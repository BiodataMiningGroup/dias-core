angular.module("biigle.volumes.edit",["biigle.api","biigle.ui.messages"]),angular.module("biigle.volumes.edit").config(["$compileProvider",function(e){"use strict";e.debugInfoEnabled(!1)}]),angular.module("biigle.volumes.edit").controller("AnnotationSessionController",["$scope","AnnotationSession","VOLUME_ID","ANNOTATION_SESSIONS","msg","VolumeUser",function(e,s,n,t,i,a){"use strict";var r,o=!1,c=!1,u={},d=new Date,l=function(s){t.push(S(s)),e.clearNewSession(),c=!1},f=function(){for(var s=t.length-1;s>=0;s--)if(t[s].id===e.newSession.id){t[s]=e.newSession,t[s].users=e.sessionUsers;break}e.clearNewSession(),c=!1},g=function(s){400===s.status?(confirm(s.data.message+" Use the Force and update the annotation session?")&&e.submit(!0),c=!1):(u=s.data,c=!1)},m=function(e){u=e.data,c=!1},_=function(){for(var s=t.length-1;s>=0;s--)if(t[s].id===e.newSession.id){t.splice(s,1);break}e.clearNewSession(),c=!1},w=function(s){400===s.status?(confirm(s.data.message+" Use the Force and delete the annotation session?")&&e.deleteSession(!0),c=!1):(i.responseError(s),c=!1)},p=function(){u={}},S=function(e){return e.starts_at=new Date(e.starts_at),e.starts_at_iso8601=new Date(e.starts_at_iso8601),e.ends_at=new Date(e.ends_at),e.ends_at_iso8601=new Date(e.ends_at_iso8601),e},y=function(s){for(var n=e.sessionUsers.length-1;n>=0;n--)if(e.sessionUsers[n].id===s.id)return!0;return!1},v={name:null,description:null,starts_at_iso8601:null,ends_at_iso8601:null,hide_other_users_annotations:!1,hide_own_annotations:!1,users:[]};e.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy"],e.open={starts_at:!1,ends_at:!1},e.newSession=angular.copy(v),e.sessionUsers=[],e.selected={user:""},e.confirm=function(){return confirm.apply(window,arguments)},e.isEditing=function(){return o},e.isLoading=function(){return c},e.toggleEditing=function(){o=!o,o||e.clearNewSession(),void 0===r&&(r=a.query({volume_id:n}))},e.openStartsAt=function(){e.open.starts_at=!0,e.open.ends_at=!1},e.openEndsAt=function(){e.open.ends_at=!0,e.open.starts_at=!1},e.hasError=function(e){return u.hasOwnProperty(e)},e.getError=function(s){if(e.hasError(s))return u[s][0]},e.hasSessions=function(){return t.length>0},e.getSessions=function(){return t},e.isActive=function(e){return e.starts_at_iso8601<d&&e.ends_at_iso8601>=d},e.dateComparator=function(e){return e.starts_at_iso8601.getTime()},e.submit=function(t){if(p(),c=!0,e.newSession.starts_at=e.newSession.starts_at_iso8601,e.newSession.ends_at=e.newSession.ends_at_iso8601,e.newSession.users=e.sessionUsers.map(function(e){return e.id}),e.newSession.id){var i={};t&&(i.force=1),s.save(i,e.newSession,f,g)}else s.create({volume_id:n},e.newSession,l,m)},e.deleteSession=function(n){c=!0;var t={id:e.newSession.id};n&&(t.force=1),s.delete(t,_,w)},e.clearNewSession=function(){p(),e.newSession=angular.copy(v),e.sessionUsers=[],e.selected.user=""},e.editSession=function(s){e.newSession=angular.copy(s),e.sessionUsers=e.newSession.users},e.getVolumeUsers=function(){return r},e.addUser=function(s,n){s.preventDefault(),y(n)||e.sessionUsers.push(n),e.selected.user=""},e.removeUser=function(s){for(var n=e.sessionUsers.length-1;n>=0;n--)e.sessionUsers[n].id===s.id&&e.sessionUsers.splice(n,1)},t.forEach(S)}]),angular.module("biigle.volumes.edit").controller("ImagesController",["$scope","$element","Image","VolumeImage","VOLUME_ID","msg",function(e,s,n,t,i,a){"use strict";var r={confirm:s.attr("data-confirmation"),success:s.attr("data-success")};e.data={addingNewImages:!1,filenames:"",newImages:[]};var o=function(s){var n=document.getElementById("volume-image-"+s);if(n)n.remove();else for(var t=e.data.newImages.length-1;t>=0;t--)if(e.data.newImages[t].id===s){e.data.newImages.splice(t,1);break}};e.deleteImage=function(e,s){var t=r.confirm.replace(":img","#"+e+" ("+s+")");confirm(t)&&n.delete({id:e},function(){o(e),a.success(r.success)},a.responseError)},window.$biigleVolumesEditDeleteImage=function(s,n){e.$apply(function(){e.deleteImage(s,n)})},e.toggleAddingNewImage=function(){e.data.addingNewImages=!e.data.addingNewImages},e.addNewImages=function(){var s=t.save({volume_id:i},{images:e.data.filenames},function(){Array.prototype.push.apply(e.data.newImages,s),e.data.filenames=""},a.responseError)}}]),angular.module("biigle.volumes.edit").factory("VolumeUser",["$resource","URL",function(e,s){"use strict";return e(s+"/api/v1/volumes/:volume_id/users")}]);
