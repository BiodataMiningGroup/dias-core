angular.module("dias.transects",["dias.api","dias.ui"]),angular.module("dias.transects").config(["$compileProvider",function(e){"use strict";e.debugInfoEnabled(!1)}]),angular.module("dias.transects").controller("FilterController",["$scope","images","TRANSECT_IMAGES",function(e,t,n){"use strict";e.totalNoImages=n.length;var i=function(){e.currentNoImages=t.length};e.$on("transects.images.new-filtering",i),i()}]),angular.module("dias.transects").controller("ImagesController",["$scope","$element","$timeout","$q","images",function(e,t,n,i,r){"use strict";var s,a,o=t[0],l=20,c=100,g=10,u=[],d=0,f=function(){return s=o.getBoundingClientRect(),o.scrollTop>=o.scrollHeight-o.offsetHeight-c},h=function(){f()&&(r.advance(l),e.$apply())},v=function(){f()&&r.limit<=r.length?(r.advance(l),a=n(v,500)):(n.cancel(a),o.addEventListener("scroll",h),window.addEventListener("resize",h))},w=function(){for(;g>d&&u.length>0;)d++,u.pop().resolve()};e.enqueueImage=function(e){var t=i.defer();return u.push(t),e.then(function(){d--,w()}),0===d&&w(),t.promise},e.images=r,n(v),e.$on("transects.images.new-ordering",function(){u.length=0,d=0,n(v)}),e.$on("transects.images.new-filtering",function(){u.length=0,d=0,n(v)})}]),angular.module("dias.transects").controller("TransectController",["$scope","images","settings","flags",function(e,t,n,i){"use strict";e.settings=n,e.flags=i,e.progress=function(){return{width:100*t.progress()+"%"}},e.setImagesSequence=t.reorder}]),angular.module("dias.transects").directive("lazyImage",["$q",function(e){"use strict";return{restrict:"A",link:function(t,n,i){var r=e.defer();t.enqueueImage(r.promise).then(function(){n.bind("load error",r.resolve),i.$set("src",i.lazyImage)})}}}]),angular.module("dias.transects").service("flags",["TRANSECT_ID","TRANSECT_IMAGES",function(e,t){"use strict";var n="dias.transects."+e+".active_filters",i="dias.transects."+e+".active_negate_filters",r=this,s={};this.list=s,this.cache={};var a=[];window.localStorage[n]&&(a=JSON.parse(window.localStorage[n]));var o=[];window.localStorage[i]&&(o=JSON.parse(window.localStorage[i]));var l=function(e){var t=[];for(var n in s)-1!==s[n].ids.indexOf(e)&&t.push(s[n]);return t},c=function(){for(var e=0;e<t.length;e++)r.cache[t[e]]=l(t[e])},g=function(e){return-1!==a.indexOf(e)},u=function(e){return-1!==o.indexOf(e)},d=function(e){s[e].activeFilter=!0,a.push(e),window.localStorage[n]=JSON.stringify(a)},f=function(e){var t=a.indexOf(e);-1!==t&&(s[e].activeFilter=!1,a.splice(t,1),window.localStorage[n]=JSON.stringify(a))},h=function(e){s[e].activeNegateFilter=!0,o.push(e),window.localStorage[i]=JSON.stringify(o)},v=function(e){var t=o.indexOf(e);-1!==t&&(s[e].activeNegateFilter=!1,o.splice(t,1),window.localStorage[i]=JSON.stringify(o))};this.add=function(e,t,n){s[e]={cssClass:e,ids:t,title:n,activeFilter:g(e),activeNegateFilter:u(e)},c()},this.remove=function(e){delete s[e],c()},this.toggleFilter=function(e){s.hasOwnProperty(e)&&(g(e)?f(e):d(e),v(e))},this.toggleNegateFilter=function(e){s.hasOwnProperty(e)&&(u(e)?v(e):h(e),f(e))},this.getActiveFilters=function(){for(var e=[],t=0;t<a.length;t++)e.push(s[a[t]].ids);return e},this.hasActiveFilters=function(){return a.length>0},this.getActiveNegateFilters=function(){for(var e=[],t=0;t<o.length;t++)e.push(s[o[t]].ids);return e},this.hasActiveNegateFilters=function(){return o.length>0}}]),angular.module("dias.transects").service("images",["$rootScope","TRANSECT_ID","TRANSECT_IMAGES","filterSubset","filterExclude","flags",function(e,t,n,i,r,s){"use strict";var a=this,o=20,l="dias.transects."+t+".images",c="dias.transects."+t+".ordering",g=[];this.sequence=[],this.limit=o,window.localStorage[l]?(a.sequence=JSON.parse(window.localStorage[l]),i(a.sequence,n,!0)):angular.copy(n,a.sequence),window.localStorage[c]&&(g=JSON.parse(window.localStorage[c])),this.length=this.sequence.length;var u=function(){var e=!1;0===g.length?angular.copy(n,a.sequence):(e=!0,angular.copy(g,a.sequence),i(a.sequence,n,!0));for(var t=s.getActiveFilters(),o=0;o<t.length;o++)e=!0,i(a.sequence,t[o]);for(t=s.getActiveNegateFilters(),o=0;o<t.length;o++)e=!0,r(a.sequence,t[o]);a.length=a.sequence.length,e?window.localStorage[l]=JSON.stringify(a.sequence):window.localStorage.removeItem(l)},d=function(){u(),a.limit=o,e.$broadcast("transects.images.new-filtering")};this.progress=function(){return a.length>0?Math.min(a.limit/a.length,1):0},this.reorder=function(t){g=Array.isArray(t)?t:[],g.length>0?window.localStorage[c]=JSON.stringify(g):window.localStorage.removeItem(c),u(),a.limit=o,e.$broadcast("transects.images.new-ordering")},this.toggleFilter=function(e){s.toggleFilter(e),d()},this.toggleNegateFilter=function(e){s.toggleNegateFilter(e),d()},this.advance=function(e){a.limit+=e}}]),angular.module("dias.transects").service("settings",function(){"use strict";var e="dias.transects.settings",t={"show-flags":!0};window.localStorage[e]&&angular.extend(t,JSON.parse(window.localStorage[e])),this.set=function(n,i){t[n]=i,window.localStorage[e]=JSON.stringify(t)},this.get=function(e){return t[e]}});