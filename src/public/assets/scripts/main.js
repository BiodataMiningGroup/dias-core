angular.module("dias.projects",["dias.api","dias.ui"]),angular.module("dias.projects").directive("projectMember",function(){"use strict";return{restrict:"A",link:function(e,r,o){var t=function(r){r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("text/plain",e.user.id)};e.$watch("removing",function(e){e?r.off("dragstart",t):r.on("dragstart",t)}),e.$watch("editing",function(r){r||e.cancelRemove()})},controller:["$scope",function(e){e.startRemove=function(){e.removing=!0},e.cancelRemove=function(){e.removing=!1},e.remove=function(){e.removeUser(e.user.id)}}]}}),angular.module("dias.projects").controller("ProjectDeleteController",["$scope","$uibModal","$attrs","msg",function(e,r,o,t){"use strict";var n=function(){e.redirectToDashboard(o.successMsg)},i=function(){t.danger(o.errorMsg)};e.submit=function(){var o=r.open({templateUrl:"confirmDeleteModal.html",size:"sm",controller:"ProjectDeleteModalController",scope:e});o.result.then(function(e){switch(e){case"success":n();break;case"error":i()}})}}]),angular.module("dias.projects").controller("ProjectDeleteModalController",["$scope","Project",function(e,r){"use strict";e.force=!1;var o=function(r){e.$close("success")},t=function(r){400===r.status?e.force=!0:e.$close("error")};e["delete"]=function(){var r=e.force?{force:!0}:{};e.project.$delete(r,o,t)}}]),angular.module("dias.projects").controller("ProjectIndexController",["$scope","$attrs","Project","$uibModal","ProjectUser","msg","$timeout",function(e,r,o,t,n,i,c){"use strict";var s=function(){e.redirectToDashboard(r.leavingSuccessMsg)};e.redirectToDashboard=function(e,o){o=o||"success",i.post(o,e),c(function(){window.location.href=r.dashboardUrl},2e3)},e.project=o.get({id:r.projectId}),e.projectId=r.projectId,e.ownUserId=r.userId,e.leaveProject=function(){var r=t.open({templateUrl:"confirmLeaveProjectModal.html",size:"sm"});r.result.then(function(r){"yes"==r&&n.detach({project_id:e.project.id},{id:e.ownUserId},s,i.responseError)})}}]),angular.module("dias.projects").controller("ProjectInformationController",["$scope",function(e){"use strict";e.edit=function(){e.editing=!e.editing}}]),angular.module("dias.projects").controller("ProjectLabelTreesController",["$scope","PROJECT_ID","ProjectLabelTree","msg",function(e,r,o,t){"use strict";var n,i=!1,c=[],s=[],a=!1;e.selected={tree:null};var l=function(e){return-1===c.indexOf(e.id)},d=function(r){e.addUsedTree(r.id),s.push(r),e.selected.tree=null,a=!1},u=function(e){c.splice(c.indexOf(e.id),1);var r=document.getElementById("label-tree-item-"+e.id);if(r)r.remove();else for(var o=s.length-1;o>=0;o--)if(s[o].id===e.id){s.splice(o,1);break}a=!1};e.isEditing=function(){return i},e.isLoading=function(){return a},e.toggleEditing=function(){i=!i,n||(n=o.available({project_id:r}))},e.attachLabelTree=function(e){e&&void 0!==e.id&&l(e)&&(o.attach({project_id:r},e,d,t.responseError),a=!0)},e.getAvailableTrees=function(){return n.filter(l)},e.addUsedTree=function(e){c.push(e)},e.getNewTrees=function(){return s},e.hasNewTrees=function(){return s.length>0},e.detachLabelTree=function(e){o.detach({project_id:r},{id:e},u,t.responseError),a=!0}}]),angular.module("dias.projects").controller("ProjectMembersContainerController",["$scope","$element","$attrs",function(e,r,o){"use strict";var t=function(r){e.hovering=!0,e.$apply(),r.preventDefault()},n=function(r){e.hovering=!1,e.$apply()},i=function(r){e.hovering=!1,e.changeUserRole(r.dataTransfer.getData("text/plain"),o.role),e.$apply(),r.preventDefault()};e.$watch("editing",function(e){e?(r.on("dragover",t),r.on("dragleave",n),r.on("drop",i)):(r.off("dragover",t),r.off("dragleave",n),r.off("drop",i))})}]),angular.module("dias.projects").controller("ProjectMembersController",["$scope","Role","ProjectUser","msg","$uibModal",function(e,r,o,t,n){"use strict";var i=function(r){for(var o=e.users.length-1;o>=0;o--)if(e.users[o].id==r)return e.users[o]},c=function(r,o){var t=n.open({templateUrl:"confirmChangeRoleModal.html",size:"sm"});t.result.then(function(t){"yes"==t&&e.changeUserRole(r,o,!0)})};r.query(function(r){e.roles={};for(var o=r.length-1;o>=0;o--)e.roles[r[o].name]=r[o].id}),e.users=o.query({project_id:e.projectId}),e.edit=function(){e.editing=!e.editing},e.addUser=function(r){var n=e.roles.guest,c=function(){r.project_role_id=n,e.users.push(r)};i(r.id)||o.attach({project_id:e.projectId},{id:r.id,project_role_id:n},c,t.responseError)},e.changeUserRole=function(r,n,s){if(!s&&r==e.ownUserId)return void c(r,n);var a=i(r),l=e.roles[n];if(a.project_role_id!=l){var d=function(){a.project_role_id=l};o.save({project_id:e.projectId},{id:a.id,project_role_id:l},d,t.responseError)}},e.removeUser=function(r){if(r==e.ownUserId)return void e.leaveProject();var n=function(){for(var o,t=e.users.length-1;t>=0;t--)if(e.users[t].id==r){o=t;break}e.users.splice(o,1)};o.detach({project_id:e.projectId},{id:r},n,t.responseError)}}]);