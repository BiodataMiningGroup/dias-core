angular.module("dias.transects",["dias.api","dias.ui"]),angular.module("dias.transects").config(["$compileProvider",function(e){"use strict";e.debugInfoEnabled(!1)}]),angular.module("dias.transects").directive("fallbackSrc",function(){"use strict";return{restrict:"A",link:function(e,t,n){t[0].onerror=function(){this.src=n.fallbackSrc}}}}),angular.module("dias.transects").directive("labelTreeItem",["$compile","$timeout","$templateCache",function(e,t,n){"use strict";return{restrict:"C",templateUrl:"label-tree-item.html",scope:!0,link:function(r,a,o){var i=angular.element(n.get("label-subtree.html"));t(function(){a.append(e(i)(r))})},controller:["$scope",function(e){var t=!1,n=!1,r=!1,a=function(){e.treeItemIsOpen(e.item)?(t=!0,r=!1):e.treeItemIsSelected(e.item)?(t=!0,r=!0):(t=!1,r=!1)},o=function(){n=e.tree&&!!e.tree[e.item.id]};e.getSubtree=function(){return t&&e.tree?e.tree[e.item.id]:[]},e.getClass=function(){return{open:t,expandable:n,selected:r}},e.$on("labels.selected",a),a(),o()}]}}]),angular.module("dias.transects").directive("transectFilterUserChooser",function(){"use strict";return{restrict:"A",scope:{select:"=transectFilterUserChooser"},replace:!0,template:'<input type="text" data-ng-model="selected" data-uib-typeahead="name(user) for user in find($viewValue)" data-typeahead-wait-ms="250" data-typeahead-on-select="select($item)"/>',controller:["$scope","TransectFilterUser",function(e,t){e.name=function(e){return e&&e.firstname&&e.lastname?e.firstname+" "+e.lastname:""},e.find=function(e){return t.find({query:encodeURIComponent(e)}).$promise}}]}}),angular.module("dias.transects").directive("transectImageLabelChooser",function(){"use strict";return{restrict:"A",scope:{select:"=transectImageLabelChooser",id:"=transectId"},replace:!0,template:'<input type="text" data-ng-model="selected" data-uib-typeahead="label.name for label in find($viewValue)" data-typeahead-wait-ms="250" data-typeahead-on-select="select($item)"/>',controller:["$scope","TransectImageLabels",function(e,t){e.find=function(n){return t.find({transect_id:e.id,query:encodeURIComponent(n)}).$promise}}]}}),angular.module("dias.transects").controller("FilterController",["$scope","images","filter",function(e,t,n){"use strict";e.active=n.hasRules,e.data={negate:"false",filter:null,selected:null},e.setFilterMode=function(e){n.setMode(e),t.updateFiltering()},e.isFilterMode=function(e){return n.getMode()===e},e.getFilters=n.getAll,e.addRule=function(){var r={filter:e.data.filter,negate:"true"===e.data.negate,data:e.data.selected};n.hasRule(r)||n.addRule(r).then(t.updateFiltering)},e.getRules=n.getAllRules,e.removeRule=function(e){n.removeRule(e),t.updateFiltering()},e.rulesLoading=n.rulesLoading,e.numberImages=n.getNumberImages,e.selectData=function(t){e.data.selected=t},e.resetFiltering=function(){n.reset(),t.updateFiltering()}}]),angular.module("dias.transects").controller("HasImageLabelFilterController",["LabelImage","filter",function(e,t){"use strict";t.add({name:"image labels",template:"hasImageLabelsFilterRule.html",resource:e,typeahead:null,transformData:function(){return null}})}]),angular.module("dias.transects").controller("ImageLabelController",["$scope","LABEL_TREES","TRANSECT_ID","keyboard",function(e,t,n,r){"use strict";var a=[],o={},i=[],s=null,l=[],c=9,u="dias.transects."+n+".label-favourites",d=[],f=function(){var e,n,r=function(e){var t=e.parent_id;o[n][t]?o[n][t].push(e):o[n][t]=[e]};for(e=t.length-1;e>=0;e--)n=t[e].name,o[n]={},t[e].labels.forEach(r),a=a.concat(t[e].labels);var i=window.localStorage.getItem(u);i&&(i=JSON.parse(i),l=a.filter(function(e){return-1!==i.indexOf(e.id)}));var s=function(e){return function(){h(e)}};for(e=0;c>=e;e++)d.push(s(e))},g=function(e){for(var t=a.length-1;t>=0;t--)if(a[t].id===e)return a[t];return null},m=function(e){var t=e;if(i.length=0,t)for(;null!==t.parent_id;)i.unshift(t.parent_id),t=g(t.parent_id)},h=function(t){t>=0&&t<l.length&&(e.selectLabel(l[t]),e.$apply())};e.selected={searchLabel:null},e.hotkeysMap=["𝟭","𝟮","𝟯","𝟰","𝟱","𝟲","𝟳","𝟴","𝟵"],e.getLabels=function(){return a},e.getLabelTrees=function(){return o},e.selectLabel=function(t){m(t),s=t,e.selected.searchLabel="",e.$broadcast("labels.selected")},e.treeItemIsOpen=function(e){return-1!==i.indexOf(e.id)},e.treeItemIsSelected=function(e){return s&&s.id===e.id},e.hasFavourites=function(){return l.length>0},e.favouritesLeft=function(){return l.length<c},e.getFavourites=function(){return l},e.isFavourite=function(e){return-1!==l.indexOf(e)},e.toggleFavourite=function(e,t){e.stopPropagation();var n=l.indexOf(t);if(-1===n&&l.length<c?l.push(t):l.splice(n,1),l.length>0){var r=l.map(function(e){return e.id});window.localStorage.setItem(u,JSON.stringify(r))}else window.localStorage.removeItem(u)},e.$on("label-mode.toggle",function(t,n){var a;if(n)for(a=0;c>=a;a++)r.on((a+1).toString(),d[a]);else for(e.selectLabel(null),a=0;c>=a;a++)r.off((a+1).toString(),d[a])}),f()}]),angular.module("dias.transects").controller("ImageLabelFilterController",["ImageLabelImage","filter",function(e,t){"use strict";t.add({name:"image label",template:"imageWithLabelFilterRule.html",resource:e,typeahead:"imageLabelFilterTypeahead.html",transformData:function(e){return e.id}})}]),angular.module("dias.transects").controller("ImageLabelUserFilterController",["ImageLabelUserImage","filter",function(e,t){"use strict";t.add({name:"image label by user",template:"imageLabelByUserFilterRule.html",resource:e,typeahead:"imageLabelUserFilterTypeahead.html",transformData:function(e){return e.id}})}]),angular.module("dias.transects").controller("ImagesController",["$scope","$element","images","filter","keyboard","$timeout",function(e,t,n,r,a,o){"use strict";var i=function(){n.updateGrid(t[0].clientWidth,t[0].clientHeight)},s=function(t){n.scrollRows(t),e.$apply()},l=function(t){n.scrollToPercent(t),e.$apply()};e.imageHasFlag=r.hasFlag,e.getImageIds=n.getSequence,t.bind("wheel",function(e){s(e.deltaY>=0?1:-1)}),a.on(38,function(){s(-1)}),a.on(40,function(){s(1)});var c=function(){s(-1*n.getRows())};a.on(37,c),a.on(33,c);var u=function(){s(n.getRows())};a.on(39,u),a.on(34,u),a.on(36,function(){l(0)}),a.on(35,function(){l(1)}),window.addEventListener("resize",function(){e.$apply(i)}),e.$on("label-mode.toggle",function(){o(i)}),i(),n.initialize()}]),angular.module("dias.transects").controller("ProgressController",["$scope","images","debounce",function(e,t,n){"use strict";var r,a=!1,o=function(e){e.preventDefault(),r=e.target.getBoundingClientRect(),t.scrollToPercent((e.clientY-r.top)/r.height)};e.beginScrolling=function(){a=!0},e.stopScrolling=function(t){e.scroll(t),a=!1},e.scroll=function(e){a&&n(function(){o(e)},25,"transects.progress.scroll")},e.progress=function(){return 100*t.progress()+"%"},e.top=function(){t.scrollToPercent(0)},e.prevPage=function(){t.scrollRows(-1*t.getRows())},e.prevRow=function(){t.scrollRows(-1)},e.nextRow=function(){t.scrollRows(1)},e.nextPage=function(){t.scrollRows(t.getRows())},e.bottom=function(){t.scrollToPercent(1)},e.isAtTop=function(){return 0===t.progress()},e.isAtBottom=function(){return 1===t.progress()}}]),angular.module("dias.transects").controller("SortByFilenameController",["$scope","sort","TRANSECT_IMAGES",function(e,t,n){"use strict";var r="filename";e.active=function(){return t.isSorterActive("filename")},e.toggle=function(){e.active()||e.activateSorter(r,n)}}]),angular.module("dias.transects").controller("SortController",["$scope","sort","images",function(e,t,n){"use strict";var r={},a=!1;e.setCache=function(e,t){r[e]=t},e.getCache=function(e){return r[e]},e.hasCache=function(e){return r.hasOwnProperty(e)},e.active=t.isActive,e.setSortAscending=function(){t.setAscending(),n.updateSorting()},e.setSortDescending=function(){t.setDescending(),n.updateSorting()},e.isSortAscending=t.isAscending,e.isSortDescending=t.isDescending,e.activateSorter=function(e,r){t.activateSorter(e,r),n.updateSorting()},e.resetSorting=function(){t.reset(),n.updateSorting()},e.setLoading=function(e){a=e},e.isLoading=function(){return a}}]),angular.module("dias.transects").controller("SortRandomController",["$scope","sort","TRANSECT_IMAGES",function(e,t,n){"use strict";var r="random",a=function(e){var t,n,r;for(t=e.length-1;t>0;t--)n=Math.floor(Math.random()*(t+1)),r=e[t],e[t]=e[n],e[n]=r;return e};e.active=function(){return t.isSorterActive("random")},e.toggle=function(){e.active()||e.activateSorter(r,a(n.slice(0)))}}]),angular.module("dias.transects").controller("TransectController",["$scope",function(e){"use strict";var t=!1;e.isInLabelMode=function(){return t},e.toggleLabelMode=function(){t=!t,e.$broadcast("label-mode.toggle",t)}}]),angular.module("dias.transects").factory("ImageLabelImage",["$resource","URL",function(e,t){"use strict";return e(t+"/api/v1/transects/:transect_id/images/filter/image-label/:data")}]),angular.module("dias.transects").factory("ImageLabelUserImage",["$resource","URL",function(e,t){"use strict";return e(t+"/api/v1/transects/:transect_id/images/filter/image-label-user/:data")}]),angular.module("dias.transects").factory("LabelImage",["$resource","URL",function(e,t){"use strict";return e(t+"/api/v1/transects/:transect_id/images/filter/labels")}]),angular.module("dias.transects").factory("TransectFilterUser",["$resource","URL",function(e,t){"use strict";return e(t+"/api/v1/users/find/:query",{},{find:{method:"GET",params:{transect_id:null},isArray:!0}})}]),angular.module("dias.transects").factory("TransectImageLabels",["$resource","URL",function(e,t){"use strict";return e(t+"/api/v1/transects/:transect_id/image-labels/find/:query",{},{find:{method:"GET",isArray:!0}})}]),angular.module("dias.transects").factory("TransectImageOrderByFilename",["$resource","URL",function(e,t){"use strict";return e(t+"/api/v1/transects/:transect_id/images/order-by/filename")}]),angular.module("dias.transects").service("filter",["TRANSECT_ID","TRANSECT_IMAGES","filterSubset","filterExclude","$q",function(e,t,n,r,a){"use strict";var o="filter",i=this,s="dias.transects."+e+".filter.rules",l="dias.transects."+e+".filter.mode",c=[],u=window.localStorage.getItem(l);u||(u=o);var d=JSON.parse(window.localStorage.getItem(s));d||(d=[]);var f=[],g=function(){angular.copy(t,f);for(var e,a=d.length-1;a>=0;a--)e=d[a],e.negate?r(f,e.ids):n(f,e.ids);d.length>0?window.localStorage.setItem(s,JSON.stringify(d)):window.localStorage.removeItem(s)};this.setMode=function(e){u=e,u!==o?window.localStorage.setItem(l,u):window.localStorage.removeItem(l)},this.getMode=function(){return u},this.add=function(e){if(!e.hasOwnProperty("name"))throw"A filter needs a name property";if(!e.hasOwnProperty("resource"))throw"A filter needs a resource property";c.push({name:e.name,resource:e.resource,template:e.template,typeahead:e.typeahead,transformData:e.transformData||angular.identity})},this.getAll=function(){return c},this.addRule=function(t){var n,r={filter:t.filter,negate:t.negate,data:t.data},o=function(){i.removeRule(r)};try{n=t.filter.transformData(t.data)}catch(s){var l=a.defer();return l.resolve(),l.promise}return r.ids=t.filter.resource.query({transect_id:e,data:n},g,o),d.push(r),r.ids.$promise},this.getAllRules=function(){return d},this.removeRule=function(e){var t=d.indexOf(e);t>=0&&d.splice(t,1),g()},this.hasRule=function(e){for(var t,n=d.length-1;n>=0;n--)if(t=d[n],t.filter==e.filter&&t.negate==e.negate&&t.data==e.data)return!0;return!1},this.hasRules=function(){return d.length>0},this.rulesLoading=function(){for(var e=d.length-1;e>=0;e--)if(d[e].ids.$resolved===!1)return!0;return!1},this.getNumberImages=function(){return f.length},this.getSequence=function(){return"filter"===u?f:t},this.hasFlag=function(e){return"flag"===u?f.indexOf(e)>=0:!1},this.reset=function(){d.length=0,i.setMode(o),g()},g()}]),angular.module("dias.transects").service("images",["TRANSECT_ID","TRANSECT_IMAGES","filterSubset","filter","sort","THUMB_DIMENSION","urlParams","debounce",function(e,t,n,r,a,o,i,s){"use strict";var l="dias.transects."+e+".images",c="dias.transects."+e+".offset",u=[];window.localStorage[l]?(u=JSON.parse(window.localStorage[l]),n(u,t)):angular.copy(t,u);var d={cols:0,rows:0},f=8,g=0,m=null,h=[],p=function(){h=u.slice(m,m+d.cols*d.rows)},S=0,v=function(){S=Math.ceil(u.length/d.cols)-d.rows,null!==m&&I(m)},w=function(){var e=!1;a.isActive()?(e=!0,angular.copy(a.getSequence(),u),n(u,t)):angular.copy(t,u),r.hasRules()&&(e=!0,n(u,r.getSequence())),p(),e?window.localStorage[l]=JSON.stringify(u):window.localStorage.removeItem(l)},I=function(e){m=Math.max(0,Math.min(S*d.cols,e)),p(),m===g?(window.localStorage.removeItem(c),i.unset("offset")):(window.localStorage[c]=m,i.set({offset:m}))};this.updateSorting=function(){w()},this.updateFiltering=function(){w(),v()},this.progress=function(){return Math.max(0,Math.min(1,m/(u.length-d.cols*d.rows)))},this.updateGrid=function(e,t){d.cols=Math.floor(e/(o.WIDTH+f)),d.rows=Math.floor(t/(o.HEIGHT+f)),p(),v()},this.scrollRows=function(e){I(m+d.cols*e)},this.scrollToPercent=function(e){I(d.cols*Math.round(S*e))},this.getSequence=function(){return h},this.getRows=function(){return d.rows},this.getCols=function(){return d.cols},this.getLength=function(){return u.length},this.initialize=function(){I(void 0!==i.get("offset")?parseInt(i.get("offset")):window.localStorage[c]?parseInt(window.localStorage[c]):g)}}]),angular.module("dias.transects").service("sort",["TRANSECT_ID","TRANSECT_IMAGES",function(e,t){"use strict";var n="dias.transects."+e+".sorting.sorter",r="dias.transects."+e+".sorting.sequence",a="dias.transects."+e+".sorting.direction",o="asc",i="desc",s={DIRECTION:o,SORTER:"filename",SEQUENCE:t},l=window.localStorage.getItem(a);l||(l=s.DIRECTION);var c=window.localStorage.getItem(n);c||(c=s.SORTER);var u=JSON.parse(window.localStorage.getItem(r));u||(u=s.SEQUENCE);var d=function(e){l=e,l===s.DIRECTION?window.localStorage.removeItem(a):window.localStorage.setItem(a,l)};this.setAscending=function(){d(o)},this.setDescending=function(){d(i)},this.isAscending=function(){return l===o},this.isDescending=function(){return l===i},this.isSorterActive=function(e){return c===e},this.isActive=function(){return c!==s.SORTER||l!==s.DIRECTION},this.reset=function(){c=s.SORTER,window.localStorage.removeItem(n),u=s.SEQUENCE,window.localStorage.removeItem(r),l=s.DIRECTION,window.localStorage.removeItem(a)},this.activateSorter=function(e,t){if(c!==e){if(t.length!==s.SEQUENCE.length)throw"Requested sorting sequence length does not match the number of images in the transect!";c=e,c===s.SORTER?window.localStorage.removeItem(n):window.localStorage.setItem(n,c),u=t,u===s.SEQUENCE?window.localStorage.removeItem(r):window.localStorage.setItem(r,JSON.stringify(u))}},this.getSequence=function(){return l===i?u.slice().reverse():u}}]);