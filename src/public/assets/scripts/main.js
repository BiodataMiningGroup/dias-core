!function(e){var t={};function i(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(s,n,function(t){return e[t]}.bind(null,n));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i(i.s=0)}({0:function(e,t,i){i("WfG0"),e.exports=i("zcrr")},WfG0:function(e,t,i){"use strict";i.r(t);var s={template:'<span><strong>with<span v-if="rule.negate">out</span></strong> <span v-text="name"></span> <strong v-if="dataName" v-text="dataName"></strong></span>',props:{rule:{type:Object,required:!0}},data:function(){return{name:this.rule.id}},computed:{dataName:function(){if(this.rule.data)return this.rule.data.name}}},n=biigle.$require("core.mixins.editor"),a=(biigle.$require("events"),biigle.$require("messages").handleErrorResponse),r=biigle.$require("api.images"),o=biigle.$require("keyboard"),l=biigle.$require("labelTrees.components.labelTrees"),u=biigle.$require("labelTrees.components.labelTypeahead"),c=biigle.$require("core.mixins.loader"),d=biigle.$require("core.components.powerToggle"),h=biigle.$require("projects.components.previewThumbnail"),m=biigle.$require("core.models.Settings"),g=biigle.$require("core.components.sidebar"),f=biigle.$require("core.components.sidebarTab"),p=biigle.$require("core.components.typeahead"),b=biigle.$require("utils.urlParams"),v={template:'<div class="filter-select">\n        <typeahead :items="items" :value="value" :placeholder="placeholder" @select="select" :template="typeaheadTemplate"></typeahead>\n        <button type="submit" class="btn btn-default" @click="submit" :disabled="!selectedItem">Add rule</button>\n    </div>',components:{typeahead:p},props:{volumeId:{type:Number,required:!0}},data:function(){return{items:[],placeholder:"",selectedItem:null,typeaheadTemplate:void 0}},computed:{value:function(){return this.selectedItem?this.selectedItem.name:""}},methods:{select:function(e){this.selectedItem=e},gotItems:function(e){this.items=e.data},parseUsernames:function(e){return e.data=e.data.map((function(e){return e.name=e.firstname+" "+e.lastname,e})),e},submit:function(){this.$emit("select",this.selectedItem)}}},y=Vue.resource("api/v1/volumes{/id}",{},{queryImagesWithImageLabels:{method:"GET",url:"api/v1/volumes{/id}/images/filter/labels"},queryImagesWithImageLabel:{method:"GET",url:"api/v1/volumes{/id}/images/filter/image-label{/label_id}"},queryImagesWithImageLabelFromUser:{method:"GET",url:"api/v1/volumes{/id}/images/filter/image-label-user{/user_id}"},queryImagesWithFilename:{method:"GET",url:"api/v1/volumes{/id}/images/filter/filename{/pattern}"},queryUsedImageLabels:{method:"GET",url:"api/v1/volumes{/id}/image-labels"},queryFilenames:{method:"GET",url:"api/v1/volumes{/id}/filenames"},queryImageLabels:{method:"GET",url:"api/v1/volumes{/id}/images/labels"},queryUsers:{method:"GET",url:"api/v1/volumes{/id}/users"},queryImages:{method:"GET",url:"api/v1/volumes{/id}/images"},saveImages:{method:"POST",url:"api/v1/volumes{/id}/images"}}),S=[{id:"imageLabels",label:"image labels",help:"All images that (don't) have image labels attached.",listComponent:{mixins:[s],data:function(){return{name:"image labels"}}},getSequence:function(e){return y.queryImagesWithImageLabels({id:e})}},{id:"imageLabel",label:"image label",help:"All images that (don't) have the given image label attached.",listComponent:{mixins:[s],data:function(){return{name:"image label"}}},selectComponent:{mixins:[v],components:{typeahead:u},data:function(){return{placeholder:"Label name"}},created:function(){y.queryUsedImageLabels({id:this.volumeId}).then(this.gotItems,a)}},getSequence:function(e,t){return y.queryImagesWithImageLabel({id:e,label_id:t.id})}},{id:"imageLabelUser",label:"image label from user",help:"All images that (don't) have one or more image labels attached by the given user.",listComponent:{mixins:[s],data:function(){return{name:"image label from user"}}},selectComponent:{mixins:[v],data:function(){return{placeholder:"User name",typeaheadTemplate:'<span v-text="item.name"></span><br><small v-text="item.affiliation"></small>'}},created:function(){y.queryUsers({id:this.volumeId}).then(this.parseUsernames,a).then(this.gotItems)}},getSequence:function(e,t){return y.queryImagesWithImageLabelFromUser({id:e,user_id:t.id})}},{id:"filename",label:"filename",help:"All images that (don't) have a filename matching the given pattern. A pattern may contain the wildcard character * that matches any string of zero or more characters.",listComponent:{mixins:[s],computed:{dataName:function(){return this.rule.data}}},selectComponent:{template:'<div class="filter-select">\n            <div class="typeahead">\n                <input class="form-control" type="text" v-model="selectedItem" placeholder="Filename pattern">\n            </div>\n            <button type="submit" class="btn btn-default" @click="submit" :disabled="!selectedItem">Add rule</button>\n        </div>',mixins:[v]},getSequence:function(e,t){return y.queryImagesWithFilename({id:e,pattern:t})}}],w={template:'<figure class="image-grid__image" :class="classObject">\n        <div v-if="showIcon" class="image-icon">\n            <i class="fas" :class="iconClass"></i>\n        </div>\n        <img @click="toggleSelect" :src="url || emptyUrl" @error="showEmptyImage">\n    </figure>',data:function(){return{url:"",timeout:null}},props:{image:{type:Object,required:!0},emptyUrl:{type:String,required:!0},selectable:{type:Boolean,required:!1},selectedIcon:{type:String,default:"check"},selectedFade:{type:Boolean,default:!0},smallIcon:{type:Boolean,default:!1}},computed:{classObject:function(){return{"image-grid__image--selected":this.selected,"image-grid__image--selectable":this.selectable,"image-grid__image--fade":this.selectedFade,"image-grid__image--small-icon":this.smallIcon}},selected:function(){return!1},iconClass:function(){return"fa-"+this.selectedIcon},showIcon:function(){return this.selectable||this.selected}},methods:{toggleSelect:function(e){this.selectable&&this.$emit("select",this.image,e)},gotBlob:function(e){var t=window.URL||window.webkitURL;this.url=t.createObjectURL(e.body),this.image.blob=this.url},showEmptyImage:function(){this.url=this.emptyUrl}},created:function(){var e=this;this.image.url?this.url=this.image.url:this.image.blob?this.url=this.image.blob:this.getUrl?this.url=this.getUrl():this.getBlob&&(this.timeout=setTimeout((function(){return e.getBlob().then(e.gotBlob)}),50))},beforeDestroy:function(){clearTimeout(this.timeout)}},I={template:'<div class="image-grid" @wheel.prevent="scroll">\n        <div class="image-grid__images" ref="images">\n            <image-grid-image v-for="image in displayedImages" :key="image.id" :image="image" :empty-url="emptyUrl" :selectable="selectable" :selected-icon="selectedIcon" @select="emitSelect"></image-grid-image>\n        </div>\n        <image-grid-progress v-if="canScroll" :progress="progress" @top="jumpToStart" @prev-page="reversePage" @prev-row="reverseRow" @jump="jumpToPercent" @next-row="advanceRow" @next-page="advancePage" @bottom="jumpToEnd"></image-grid-progress>\n    </div>',data:function(){return{clientWidth:0,clientHeight:0,offset:0,imagesOffset:0,imagesOffsetTimeout:null}},components:{imageGridImage:w,imageGridProgress:{template:'<div class="image-grid-progress">\n        <div class="btn-group-vertical">\n            <button type="button" class="btn btn-default btn-xs" title="Go to top 𝗛𝗼𝗺𝗲" @click="top" :disabled="isAtTop">\n                <span class="fa fa-fast-backward fa-rotate-90"></span>\n            </button>\n            <button type="button" class="btn btn-default btn-xs" title="Previous page 𝗣𝗮𝗴𝗲 𝘂𝗽/𝗔𝗿𝗿𝗼𝘄 𝗹𝗲𝗳𝘁" @click="prevPage" :disabled="isAtTop">\n                <span class="fa fa-step-backward fa-rotate-90"></span>\n            </button>\n            <button type="button" class="btn btn-default btn-xs" title="Previous row 𝗔𝗿𝗿𝗼𝘄 𝘂𝗽" @click="prevRow" :disabled="isAtTop">\n                <span class="fa fa-chevron-up"></span>\n            </button>\n        </div>\n        <div class="image-grid-progress__bar" @mousedown="beginScrolling" @mouseup="stopScrolling" @mouseleave="stopScrolling" @mousemove.prevent="scroll" @click="jump">\n            <div class="image-grid-progress__wrapper">\n                <div class="image-grid-progress__inner" :style="{height: progressHeight}"></div>\n            </div>\n        </div>\n        <div class="btn-group-vertical">\n            <button type="button" class="btn btn-default btn-xs" title="Next row 𝗔𝗿𝗿𝗼𝘄 𝗱𝗼𝘄𝗻" @click="nextRow" :disabled="isAtBottom">\n                <span class="fa fa-chevron-down"></span>\n            </button>\n            <button type="button" class="btn btn-default btn-xs" title="Next page 𝗣𝗮𝗴𝗲 𝗱𝗼𝘄𝗻/𝗔𝗿𝗿𝗼𝘄 𝗿𝗶𝗴𝗵𝘁" @click="nextPage" :disabled="isAtBottom">\n                <span class="fa fa-step-forward fa-rotate-90"></span>\n            </button>\n            <button type="button" class="btn btn-default btn-xs" title="Go to bottom 𝗘𝗻𝗱" @click="bottom" :disabled="isAtBottom">\n                <span class="fa fa-fast-forward fa-rotate-90"></span>\n            </button>\n        </div>\n    </div>',data:function(){return{scrolling:!1}},props:{progress:{type:Number,required:!0}},computed:{isAtTop:function(){return 0===this.progress},isAtBottom:function(){return 1===this.progress},progressHeight:function(){return 100*this.progress+"%"}},methods:{top:function(){this.$emit("top")},prevPage:function(){this.$emit("prev-page")},prevRow:function(){this.$emit("prev-row")},beginScrolling:function(){this.scrolling=!0},stopScrolling:function(){this.scrolling=!1},scroll:function(e){this.scrolling&&this.jump(e)},jump:function(e){var t=e.target.getBoundingClientRect();this.$emit("jump",(e.clientY-t.top)/t.height)},nextRow:function(){this.$emit("next-row")},nextPage:function(){this.$emit("next-page")},bottom:function(){this.$emit("bottom")}}}},props:{images:{type:Array,required:!0},emptyUrl:{type:String,required:!0},width:{type:Number,default:135},height:{type:Number,default:180},margin:{type:Number,default:8},initialOffset:{type:Number,default:0},selectable:{type:Boolean,default:!1},selectedIcon:{type:String,default:"check"},listenerSet:{type:String,default:"default"}},computed:{columns:function(){return Math.max(1,Math.floor(this.clientWidth/(this.width+this.margin)))},rows:function(){return Math.max(1,Math.floor(this.clientHeight/(this.height+this.margin)))},imagesOffsetEnd:function(){return this.imagesOffset+this.columns*this.rows},displayedImages:function(){return this.images.slice(this.imagesOffset,this.imagesOffsetEnd)},progress:function(){return this.offset/(this.columns*this.lastRow)},lastRow:function(){return Math.max(0,Math.ceil(this.images.length/this.columns)-this.rows)},lastOffset:function(){return this.lastRow*this.columns},canScroll:function(){return this.lastRow>0}},methods:{updateDimensions:function(){this.$refs.images&&(this.clientHeight=this.$refs.images.clientHeight,this.clientWidth=this.$refs.images.clientWidth)},scrollRows:function(e,t){this.setOffset(this.offset+this.columns*e,t)},scroll:function(e){this.scrollRows(e.deltaY>=0?1:-1,!0)},advanceRow:function(){this.scrollRows(1)},advancePage:function(){this.scrollRows(this.rows)},reverseRow:function(){this.scrollRows(-1)},reversePage:function(){this.scrollRows(-this.rows)},jumpToPercent:function(e){this.setOffset(this.columns*Math.round(this.lastRow*e))},jumpToStart:function(){this.jumpToPercent(0)},jumpToEnd:function(){this.jumpToPercent(1)},emitSelect:function(e,t){this.$emit("select",e,t)},setOffset:function(e,t){var i=this;this.offset=Math.max(0,Math.min(this.lastOffset,e)),clearTimeout(this.imagesOffsetTimeout),t?this.imagesOffsetTimeout=setTimeout((function(){i.imagesOffset=i.offset}),25):this.imagesOffset=this.offset}},watch:{lastOffset:function(){this.setOffset(this.offset)},offset:function(){this.$emit("scroll",this.offset)}},created:function(){o.on("ArrowUp",this.reverseRow,0,this.listenerSet),o.on("w",this.reverseRow,0,this.listenerSet),o.on("ArrowDown",this.advanceRow,0,this.listenerSet),o.on("s",this.advanceRow,0,this.listenerSet),o.on("ArrowLeft",this.reversePage,0,this.listenerSet),o.on("a",this.reversePage,0,this.listenerSet),o.on("ArrowRight",this.advancePage,0,this.listenerSet),o.on("d",this.advancePage,0,this.listenerSet),o.on("PageUp",this.reversePage,0,this.listenerSet),o.on("PageDown",this.advancePage,0,this.listenerSet),o.on("Home",this.jumpToStart,0,this.listenerSet),o.on("End",this.jumpToEnd,0,this.listenerSet),this.setOffset(this.initialOffset)},mounted:function(){window.addEventListener("resize",this.updateDimensions),this.$on("resize",this.updateDimensions),this.$nextTick(this.updateDimensions),this.$watch("canScroll",this.updateDimensions)}},q=Vue.resource("api/v1/image-labels{/id}",{},{query:{method:"GET",url:"api/v1/images{/image_id}/labels"},save:{method:"POST",url:"api/v1/images{/image_id}/labels"}}),_={template:'<ul class="image-label-list">\n        <list-item v-for="item in imageLabels" :item="item" :deletable="canDelete(item)" @deleted="emitDeleted"></list-item>\n        <li v-if="!hasImageLabels" class="text-muted">No image labels</li>\n    </ul>',components:{listItem:{template:'<li class="image-label" :class="classObject">\n        <span class="image-label__color" :style="colorStyle"></span>\n        <span v-text="label.name" :title="title"></span>\n        <button v-if="!deleting && deletable" class="close image-label__delete" :title="deleteTitle" @click.stop="deleteThis"><span aria-hidden="true">&times;</span></button>\n    </li>',props:{item:{type:Object,required:!0},deletable:{type:Boolean,default:!1}},data:function(){return{deleting:!1}},computed:{label:function(){return this.item.label},colorStyle:function(){return{"background-color":"#"+this.label.color}},deleteTitle:function(){return"Detach label "+this.label.name},title:function(){return"Attached by ".concat(this.item.user.firstname," ").concat(this.item.user.lastname)},classObject:function(){return{"image-label--deleting":this.deleting}}},methods:{deleteThis:function(){var e=this;this.deleting||(this.deleting=!0,q.delete({id:this.item.id}).then(this.deleted,a).finally((function(){return e.deleting=!1})))},deleted:function(){this.$emit("deleted",this.item)}}}},props:{imageLabels:{type:Array,required:!0},userId:{type:Number,required:!0},isAdmin:{type:Boolean,default:!1}},computed:{hasImageLabels:function(){return this.imageLabels.length>0}},methods:{canDelete:function(e){return!0===this.isAdmin||this.userId===e.user.id},emitDeleted:function(e){this.$emit("deleted",e)}}},L={template:'<button class="list-group-item" :title="title" @click="handleClick" :class="classObject" v-text="text"></button>',props:{activeSorter:{type:String,default:""}},computed:{active:function(){return this.activeSorter===this.id},classObject:function(){return{active:this.active}}},methods:{getSequence:function(){return new Vue.Promise.resolve([])},handleClick:function(){this.active||this.$emit("select",this)}}},$=[{id:"filename",component:{mixins:[L],data:function(){return{imageIds:[],title:"Sort images by filename",text:"Filename",id:"filename"}},methods:{getSequence:function(){return new Vue.Promise.resolve(this.imageIds)}},created:function(){this.imageIds=biigle.$require("volumes.imageIds")}}},{id:"random",component:{mixins:[L],data:function(){return{imageIds:[],title:"Sort images randomly",text:"Random",id:"random"}},methods:{shuffle:function(e){var t,i,s;for(t=e.length-1;t>0;t--)i=Math.floor(Math.random()*(t+1)),s=e[t],e[t]=e[i],e[i]=s;return e},getSequence:function(){var e=this.shuffle(this.imageIds.slice());return new Vue.Promise.resolve(e)},handleClick:function(){this.$emit("select",this)}},created:function(){this.imageIds=biigle.$require("volumes.imageIds")}}}];biigle.$declare("api.imageLabels",q),biigle.$declare("volumes.components.filterListComponent",s),biigle.$declare("volumes.components.imageGrid",I),biigle.$declare("volumes.components.imageGridImage",w),biigle.$declare("volumes.components.imageLabelList",_),biigle.$declare("volumes.components.sortComponent",L),biigle.$declare("volumes.mixins.sortComponent",L),biigle.$declare("volumes.stores.filters",S),biigle.$declare("volumes.stores.sorters",$);var T=Vue.resource("api/v1/annotation-sessions{/id}",{},{query:{method:"GET",url:"api/v1/volumes{/volume_id}/annotation-sessions"},save:{method:"POST",url:"api/v1/volumes{/volume_id}/annotation-sessions"}}),O={mixins:[c,n],data:{volumeId:null,sessions:null,editedSession:{name:null,description:null,starts_at_iso8601:null,starts_at:null,ends_at_iso8601:null,ends_at:null,hide_other_users_annotations:!1,hide_own_annotations:!1,users:[]},users:[],errors:{},typeaheadTemplate:'<span v-text="item.name"></span><br><small v-text="item.affiliation"></small>'},components:{typeahead:p,listItem:{props:["session","editing","editId"],computed:{title:function(){return this.editing?"Edit this annotation session":this.session.name},active:function(){var e=new Date;return this.session.starts_at_iso8601<e&&this.session.ends_at_iso8601>=e},currentlyEdited:function(){return this.session.id===this.editId},classObject:function(){return{"session--active":this.active,"list-group-item-info":this.currentlyEdited}}},methods:{edit:function(){this.editing&&!this.currentlyEdited&&this.$emit("edit",this.session)}}},userTag:{props:["user"],computed:{name:function(){return this.user.firstname+" "+this.user.lastname},title:function(){return"Remove "+this.name}},methods:{remove:function(){this.$emit("remove",this.user)}}},datepicker:VueStrap.datepicker},computed:{classObject:function(){return{"panel-warning panel--editing":this.editing}},hasSessions:function(){return this.sessions.length>0},hasNewSession:function(){return void 0===this.editedSession.id},availableUsers:function(){var e=this.editedSession.users.map((function(e){return e.id}));return this.users.filter((function(t){return-1===e.indexOf(t.id)}))},orderedSessions:function(){return this.sessions.sort((function(e,t){return t.starts_at_iso8601.getTime()-e.starts_at_iso8601.getTime()}))}},methods:{clone:function(e){return JSON.parse(JSON.stringify(e))},submit:function(e){var t=this;if(!this.loading){this.startLoading();var i=this.editedSession;if(this.hasNewSession)T.save({volume_id:this.volumeId},this.packSession(i)).then(this.sessionSaved).catch(this.handleErrorResponse).finally(this.finishLoading);else{var s={id:i.id};!0===e&&(s.force=1),T.update(s,this.packSession(i)).then((function(){return t.sessionUpdated(i)})).catch(this.handleConfirm("Use the Force and update the annotation session?",this.submit)).finally(this.finishLoading)}}},sessionUpdated:function(e){for(var t=this.sessions.length-1;t>=0;t--)this.sessions[t].id===e.id&&(this.sessions.splice(t,1,e),this.clearEditedSession())},sessionSaved:function(e){this.sessions.push(this.parseSession(e.data)),this.clearEditedSession()},packSession:function(e){return(e=this.clone(e)).users=e.users.map((function(e){return e.id})),e.starts_at=e.starts_at_iso8601,e.ends_at=e.ends_at_iso8601,delete e.starts_at_iso8601,delete e.ends_at_iso8601,e},handleConfirm:function(e,t){var i=this;return function(s){400===s.status?(i.finishLoading(),confirm(s.data.message+" "+e)&&t(!0)):i.handleErrorResponse(s)}},handleErrorResponse:function(e){422===e.status?this.errors=e.data.errors:a(e)},hasError:function(e){return this.errors.hasOwnProperty(e)},getError:function(e){return this.errors[e].join(" ")},editSession:function(e){this.editedSession=this.clone(e)},deleteSession:function(e){var t=this;if(!this.loading&&!this.hasNewSession&&(!0===e||confirm("Are you sure you want to delete the annotation session '".concat(this.editedSession.name,"'?")))){this.startLoading();var i=this.editedSession.id,s={id:i};!0===e&&(s.force=1),T.delete(s).then((function(){return t.sessionDeleted(i)})).catch(this.handleConfirm("Use the Force and delete the annotation session?",this.deleteSession)).finally(this.finishLoading)}},sessionDeleted:function(e){for(var t=this.sessions.length-1;t>=0;t--)if(this.sessions[t].id===e)return this.sessions.splice(t,1),void this.clearEditedSession()},clearEditedSession:function(){this.editedSession={name:null,description:null,starts_at_iso8601:null,starts_at:null,ends_at_iso8601:null,ends_at:null,hide_other_users_annotations:!1,hide_own_annotations:!1,users:[]}},loadUsers:function(){y.queryUsers({id:this.volumeId}).then(this.usersLoaded,a)},usersLoaded:function(e){e.data.forEach((function(e){e.name=e.firstname+" "+e.lastname})),Vue.set(this,"users",e.data)},selectUser:function(e){this.editedSession.users.push(e)},removeUser:function(e){for(var t=this.editedSession.users.length-1;t>=0;t--)this.editedSession.users[t].id===e.id&&this.editedSession.users.splice(t,1)},stringifyDate:function(e){var t=e.getMonth()+1;return t=t<10?"0"+t:t,e.getFullYear()+"-"+t+"-"+e.getDate()},parseDate:function(e){if(e)return e=e.split("-"),new Date(e[0],e[1]-1,e[2])},parseSession:function(e){var t=new Date(e.starts_at_iso8601);return e.starts_at_iso8601=t,e.starts_at=this.stringifyDate(t),t=new Date(e.ends_at_iso8601),e.ends_at_iso8601=t,e.ends_at=this.stringifyDate(t),e},setStartsAt:function(e){this.editedSession.starts_at_iso8601=this.parseDate(e),this.editedSession.starts_at=e},setEndsAt:function(e){this.editedSession.ends_at_iso8601=this.parseDate(e),this.editedSession.ends_at=e}},watch:{editedSession:function(){this.errors={}},loading:function(e){e&&(this.errors={})}},created:function(){this.volumeId=biigle.$require("volumes.id"),this.sessions=biigle.$require("volumes.annotationSessions").map(this.parseSession),this.$once("editing.start",this.loadUsers)}},x=Vue.resource("api/v1/volumes/browser/directories{/disk}",{},{getImages:{method:"GET",url:"api/v1/volumes/browser/images{/disk}"}}),F={mixins:[c],data:{disks:[],url:null,filenames:null,browsing:!1,storageDisk:null,breadCrumbs:[],currentDirectories:[],loadingBrowser:!1,directoryCache:{},fileCache:{}},computed:{showFilenameWarning:function(){return this.filenames.includes(".tif")},hasDirectories:function(){return this.currentDirectories.length>0},buttonClass:function(){return{"btn-info":this.browsing}},canGoBack:function(){return this.breadCrumbs.length>0||this.disks.length>1},hasCurrentDirectory:function(){return this.breadCrumbs.length>0},currentDirectory:function(){return this.hasCurrentDirectory?this.breadCrumbs[this.breadCrumbs.length-1]:null}},methods:{toggleBrowse:function(){this.browsing=!this.browsing},fetchDirectories:function(e,t){var i=this,s=e+"://"+t;if(!this.directoryCache.hasOwnProperty(s)){this.loadingBrowser=!0;var n=x.get({disk:e,path:t});n.finally((function(){return i.loadingBrowser=!1})),this.directoryCache[s]=n}return this.directoryCache[s]},showDirectories:function(e){this.currentDirectories=e.body},openDirectory:function(e){this.breadCrumbs.push(e)},goBack:function(){this.breadCrumbs.length>0?this.breadCrumbs.pop():this.disks.length>1&&(this.storageDisk=null)},goTo:function(e){e>=-1&&e<this.breadCrumbs.length&&(this.breadCrumbs=this.breadCrumbs.slice(0,e+1))},fetchImages:function(e,t){var i=this,s=e+"://"+t;if(!this.fileCache.hasOwnProperty(s)){this.loadingBrowser=!0;var n=x.getImages({disk:e,path:t});n.finally((function(){return i.loadingBrowser=!1})),this.fileCache[s]=n}return this.fileCache[s]},setImages:function(e){this.filenames=e.body.join(", ")},selectDirectory:function(e){var t=this,i=this.breadCrumbs.slice();e&&i.push(e),this.fetchImages(this.storageDisk,i.join("/")).then(this.setImages).then((function(){return t.url=t.storageDisk+"://"+i.join("/")})).catch(a)}},watch:{storageDisk:function(e){e&&this.fetchDirectories(e,"").then(this.showDirectories,a)},breadCrumbs:function(e){this.fetchDirectories(this.storageDisk,e.join("/")).then(this.showDirectories).catch((function(t){e.pop(),a(t)}))}},created:function(){this.disks=biigle.$require("volumes.disks"),this.url=biigle.$require("volumes.url"),this.filenames=biigle.$require("volumes.filenames"),1===this.disks.length&&(this.storageDisk=this.disks[0])},mounted:function(){this.$refs.nameInput.focus()}},A=new Vue({data:{count:0}}),P={data:function(){return{imageIds:[]}},computed:{count:function(){return A.count},text:function(){return this.count===this.imageIds.length?this.count:this.count+" of "+this.imageIds.length}},created:function(){this.imageIds=biigle.$require("volumes.imageIds")}},k={mixins:[c,n],data:{volumeId:null,filenames:"",images:[],errors:{}},components:{imageItem:{props:["image"],computed:{classObject:function(){return{"list-group-item-success":this.image.isNew}},title:function(){return"Delete image #"+this.image.id}},methods:{remove:function(){this.$emit("remove",this.image)}}}},computed:{classObject:function(){return{"panel-warning panel--editing":this.editing}},orderedImages:function(){return this.images.sort((function(e,t){return e.filename<t.filename?-1:1}))},hasNoImages:function(){return!this.loading&&0===this.images.length}},methods:{submit:function(){this.loading||(this.startLoading(),y.saveImages({id:this.volumeId},{images:this.filenames}).then(this.imagesSaved).catch(this.handleErrorResponse).finally(this.finishLoading))},imagesSaved:function(e){for(var t=e.data.length-1;t>=0;t--)e.data[t].isNew=!0,this.images.push(e.data[t]);this.filenames=""},handleRemove:function(e){var t=this;!this.loading&&confirm("Do you really want to delete the image #".concat(e.id," (").concat(e.filename,")? All annotations will be lost!"))&&(this.startLoading(),r.delete({id:e.id}).then((function(){return t.imageRemoved(e.id)})).catch(a).finally(this.finishLoading))},imageRemoved:function(e){for(var t=this.images,i=t.length-1;i>=0;i--)if(t[i].id===e)return void t.splice(i,1)},handleErrorResponse:function(e){422===e.status?this.errors=e.data.errors:a(e)},hasError:function(e){return this.errors.hasOwnProperty(e)},getError:function(e){return this.errors[e].join("\n")},setImages:function(e){for(var t in e.body)e.body.hasOwnProperty(t),this.images.push({id:t,filename:e.body[t]})}},watch:{loading:function(e){e&&(this.errors={})}},created:function(){this.volumeId=biigle.$require("volumes.id"),this.startLoading(),y.queryFilenames({id:this.volumeId}).then(this.setImages,a).finally(this.finishLoading)}},D=Vue.resource("api/v1/volumes{/id}/images/metadata"),E={mixins:[c],data:{volumeId:null,csv:void 0,error:!1,success:!1,message:void 0},methods:{handleSuccess:function(){this.error=!1,this.success=!0},handleError:function(e){this.success=!1,e.data.file?Array.isArray(e.data.file)?this.error=e.data.file[0]:this.error=e.data.file:a(e)},submit:function(){if(this.csv){this.startLoading();var e=new FormData;e.append("file",this.csv),D.save({id:this.volumeId},e).bind(this).then(this.handleSuccess,this.handleError).finally(this.finishLoading)}},setCsv:function(e){this.csv=e.target.files[0]}},created:function(){this.volumeId=biigle.$require("volumes.id")}},C={components:{previewThumbnail:h}};function R(e){return(R="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var j={mixins:[c],components:{powerToggle:d},props:{volumeId:{type:Number,required:!0},imageIds:{type:Array,required:!0},showFilenames:{type:Boolean,default:!1},loadingFilenames:{type:Boolean,default:!1}},data:function(){return{filters:S,rules:[],selectedFilterId:null,negate:!1,mode:"filter",operator:"and"}},computed:{selectedFilter:function(){return this.getFilter(this.selectedFilterId)},hasSelectComponent:function(){return this.selectedFilter&&this.selectedFilter.selectComponent},selectComponent:function(){return this.selectedFilter.selectComponent},hasRules:function(){return this.rules.length>0},sequence:function(){if(!this.hasRules)return this.imageIds;var e={},t={},i=0,s=0;return this.rules.forEach((function(n){n.negate?(i++,n.sequence.forEach((function(e){t[e]=t[e]+1||1}))):(s++,n.sequence.forEach((function(t){e[t]=e[t]+1||1})))})),"and"===this.operator?s>0?this.imageIds.filter((function(i){return e[i]===s&&!t.hasOwnProperty(i)})):this.imageIds.filter((function(e){return!t.hasOwnProperty(e)})):i>0?this.imageIds.filter((function(s){return e.hasOwnProperty(s)||t[s]!==i})):this.imageIds.filter((function(t){return e.hasOwnProperty(t)}))},inFilterMode:function(){return"filter"===this.mode},inFlagMode:function(){return"flag"===this.mode},usesAndOperator:function(){return"and"===this.operator},usesOrOperator:function(){return"or"===this.operator},helpText:function(){return this.selectedFilter?this.selectedFilter.help:null},rulesStorageKey:function(){return"biigle.volumes.".concat(this.volumeId,".filter2.rules")},modeStorageKey:function(){return"biigle.volumes.".concat(this.volumeId,".filter2.mode")},operatorStorageKey:function(){return"biigle.volumes.".concat(this.volumeId,".filter2.operator")}},methods:{filterValid:function(e){return"string"==typeof e.id&&"string"==typeof e.label&&"object"===R(e.listComponent)&&"function"==typeof e.getSequence},getFilter:function(e){for(var t=this.filters.length-1;t>=0;t--)if(this.filters[t].id===e)return this.filters[t];return null},hasRule:function(e){return-1!==this.rules.findIndex((function(t){return t.id===e.id&&t.negate===e.negate&&t.data===e.data}))},addRule:function(e){var t=this;if(this.selectedFilter){var i={id:this.selectedFilter.id,data:e,negate:this.negate};this.hasRule(i)||(this.startLoading(),this.selectedFilter.getSequence(this.volumeId,e).catch(a).then((function(e){return t.ruleAdded(i,e)})).finally(this.finishLoading))}},refreshRule:function(e){var t=this.getFilter(e.id);t&&(this.startLoading(),t.getSequence(this.volumeId,e.data).catch(a).then((function(t){return e.sequence=t.data})).finally(this.finishLoading))},ruleAdded:function(e,t){e.sequence=t.data,this.rules.push(e)},removeRule:function(e){this.rules.splice(e,1)},reset:function(){this.rules=[],this.selectedFilterId=null,this.negate=!1,this.mode="filter",this.operator="and"},activateFilterMode:function(){this.mode="filter"},activateFlagMode:function(){this.mode="flag"},activateAndOperator:function(){this.operator="and"},activateOrOperator:function(){this.operator="or"},emitUpdate:function(){this.$emit("update",this.sequence,this.mode,this.hasRules)},getListComponent:function(e){for(var t=this.filters.length-1;t>=0;t--)if(this.filters[t].id===e.id)return this.filters[t].listComponent},enableFilenames:function(){this.$emit("enable-filenames")},disableFilenames:function(){this.$emit("disable-filenames")}},watch:{sequence:function(){this.emitUpdate()},mode:function(){this.emitUpdate(),"filter"!==this.mode?localStorage.setItem(this.modeStorageKey,this.mode):localStorage.removeItem(this.modeStorageKey)},operator:function(){this.emitUpdate(),"and"!==this.operator?localStorage.setItem(this.operatorStorageKey,this.operator):localStorage.removeItem(this.operatorStorageKey)},rules:{handler:function(){this.rules.length>0?localStorage.setItem(this.rulesStorageKey,JSON.stringify(this.rules)):localStorage.removeItem(this.rulesStorageKey)},deep:!0}},created:function(){for(var e,t=0;t<this.filters.length;t++)e=this.filters[t],this.filterValid(e)||(console.error("Filter ".concat(e.id," invalid. Ignoring...")),this.filters.splice(t,1));var i=JSON.parse(localStorage.getItem(this.rulesStorageKey));i&&(this.rules=i);var s=localStorage.getItem(this.modeStorageKey);s&&(this.mode=s);var n=localStorage.getItem(this.operatorStorageKey);n&&(this.operator=n)}},U={mixins:[I],template:'<div class="image-grid" @wheel.prevent="scroll">\n        <div class="image-grid__images" ref="images">\n            <image-grid-image v-for="image in displayedImages" :key="image.id" :image="image" :empty-url="emptyUrl" :selected-label="selectedLabel" :selectable="selectable" :selected-fade="false" :show-filename="showFilenames" :show-labels="showLabels" @select="emitSelect"></image-grid-image>\n        </div>\n        <image-grid-progress v-if="canScroll" :progress="progress" @top="jumpToStart" @prev-page="reversePage" @prev-row="reverseRow" @jump="jumpToPercent" @next-row="advanceRow" @next-page="advancePage" @bottom="jumpToEnd"></image-grid-progress>\n    </div>',components:{imageGridImage:{mixins:[w,c],template:'<figure class="image-grid__image image-grid__image--volume" :class="classObject" :title="title">\n        <a v-if="!selectable && image.annotateUrl" :href="image.annotateUrl" title="Annotate this image" class="image-link">\n            <img :src="url || emptyUrl" @error="showEmptyImage">\n        </a>\n        <img v-else @click="handleClick" :src="url || emptyUrl" @error="showEmptyImage">\n        <span v-if="showFilename" class="image-filename" :title="image.filename" v-text="image.filename"></span>\n        <div class="image-buttons">\n            <a v-if="image.imageUrl" :href="image.imageUrl" class="image-button" title="View image information">\n                <span class="fa fa-info-circle" aria-hidden="true"></span>\n            </a>\n        </div>\n        <div v-if="showLabels" class="image-labels" @wheel.stop>\n            <image-label-list :image-labels="image.labels" :user-id="userId" :is-admin="isAdmin" @deleted="removeImageLabel"></image-label-list>\n        </div>\n    </figure>',components:{imageLabelList:_},data:function(){return{userId:null,isAdmin:!1,attachingSuccess:null,timeout:null,saving:!1,showAnnotationRoute:null}},props:{selectedLabel:{type:Object,default:null},showFilename:{type:Boolean,default:!1},showLabels:{type:Boolean,default:!1}},computed:{alreadyHasSelectedLabel:function(){var e=this.selectedLabel;return this.image.labels.reduce((function(t,i){return t||e.id===i.label_id}),!1)},showAnnotationLink:function(){return this.showAnnotationRoute?this.showAnnotationRoute+this.image.id:""},selected:function(){return this.image.flagged},canBeSelected:function(){return this.selectable&&this.selectedLabel&&!this.alreadyHasSelectedLabel&&!this.saving},classObject:function(){return{"image-grid__image--selected":this.selected,"image-grid__image--selectable":this.canBeSelected,"image-grid__image--saving":this.selectable&&this.saving,"image-grid__image--success":!0===this.attachingSuccess,"image-grid__image--error":!1===this.attachingSuccess}},title:function(){return this.canBeSelected?"Attach "+this.selectedLabel.name:""}},methods:{handleClick:function(){var e=this;this.canBeSelected&&(this.saving=!0,q.save({image_id:this.image.id},{label_id:this.selectedLabel.id}).then(this.labelAttached,this.attachingFailed).finally(this.resetSuccess).finally((function(){return e.saving=!1})))},labelAttached:function(e){this.attachingSuccess=!0,this.image.labels.push(e.data)},attachingFailed:function(e){this.attachingSuccess=!1,a(e)},resetSuccess:function(){var e=this;clearTimeout(this.timeout),this.timeout=setTimeout((function(){return e.attachingSuccess=null}),3e3)},removeImageLabel:function(e){var t=this.image.labels.indexOf(e);-1!==t&&this.image.labels.splice(t,1)}},created:function(){this.userId=biigle.$require("volumes.userId"),this.isAdmin=biigle.$require("volumes.isAdmin"),this.showAnnotationRoute=biigle.$require("largo.showAnnotationRoute")}}},props:{selectedLabel:{type:Object,default:null},showFilenames:{type:Boolean,default:!1},showLabels:{type:Boolean,default:!1}}},B={mixins:[c],components:{labelTrees:l,powerToggle:d},props:{volumeId:{type:Number,required:!0},showLabels:{type:Boolean,default:!1},loadingLabels:{type:Boolean,default:!1}},data:function(){return{labelTrees:[]}},methods:{handleSelectedLabel:function(e){this.$emit("select",e)},handleDeselectedLabel:function(e){this.$emit("deselect",e)},enableLabels:function(){this.$emit("enable-labels")},disableLabels:function(){this.$emit("disable-labels")}},created:function(){this.labelTrees=biigle.$require("volumes.labelTrees")}},N={mixins:[c],components:{sidebar:g,sidebarTab:f,imageGrid:U,filterTab:j,sortingTab:{mixins:[c],props:{volumeId:{type:Number,required:!0},imageIds:{type:Array,required:!0}},data:function(){return{sorters:$,direction:!0,activeSorter:null,privateSequence:[]}},computed:{defaultSorter:function(){return this.sorters[0]},isActive:function(){return this.activeSorter!==this.defaultSorter.id||!this.direction},isSortedAscending:function(){return this.direction},isSortedDescending:function(){return!this.direction},sorterStorageKey:function(){return"biigle.volumes.".concat(this.volumeId,".sorting2.sorter")},directionStorageKey:function(){return"biigle.volumes.".concat(this.volumeId,".sorting2.direction")},sequence:function(){return this.direction?this.privateSequence:this.privateSequence.slice().reverse()}},methods:{reset:function(){this.direction=!0,this.activeSorter=this.defaultSorter.id,this.privateSequence=biigle.$require("volumes.imageIds")},sortAscending:function(){this.direction=!0},sortDescending:function(){this.direction=!1},handleSelect:function(e){var t=this;this.loading||(this.startLoading(),e.getSequence().then((function(i){t.activeSorter=e.id,t.privateSequence=i})).catch(a).finally(this.finishLoading))},isValidSequence:function(e){for(var t={},i=this.imageIds,s=e.length-1;s>=0;s--)t[e[s]]=!0;for(var n=i.length-1;n>=0;n--)if(!t.hasOwnProperty(i[n]))return!1;return!0}},watch:{sequence:function(){this.$emit("update",this.sequence,this.isActive)},privateSequence:function(){this.activeSorter===this.defaultSorter.id?localStorage.removeItem(this.sorterStorageKey):localStorage.setItem(this.sorterStorageKey,JSON.stringify({id:this.activeSorter,sequence:this.privateSequence}))},direction:function(){this.direction?localStorage.removeItem(this.directionStorageKey):localStorage.setItem(this.directionStorageKey,this.direction)}},created:function(){this.privateSequence=biigle.$require("volumes.imageIds");var e=JSON.parse(localStorage.getItem(this.sorterStorageKey));e&&this.isValidSequence(e.sequence)?(this.activeSorter=e.id,this.privateSequence=e.sequence):(this.activeSorter=this.defaultSorter.id,localStorage.removeItem(this.sorterStorageKey));var t=JSON.parse(localStorage.getItem(this.directionStorageKey));null!==t&&(this.direction=t)}},labelsTab:B},data:{imageIds:[],images:[],filterSequence:[],filterMode:null,filterActive:!1,sortingSequence:[],sortingActive:!1,volumeId:null,imageLabelMode:!1,selectedLabel:null,loadingFilenames:!1,showFilenames:!1,filenamesPromise:null,loadingLabels:!1,showLabels:!1,labelsPromise:null,settings:null},computed:{sortingMap:function(){var e={};return this.sortingSequence.forEach((function(t,i){e[t]=i})),e},sortedImages:function(){var e=this.sortingMap,t=[];return this.images.forEach((function(i){t[e[i.id]]=i})),t},filterMap:function(){var e={};return this.filterSequence.forEach((function(t){e[t]=null})),e},imagesToShow:function(){var e=this.filterMap;return"flag"===this.filterMode?this.sortedImages.map((function(t){return t.flagged=e.hasOwnProperty(t.id),t})):this.sortedImages.filter((function(t){return t.flagged=!1,e.hasOwnProperty(t.id)}))},imageIdsToShow:function(){return this.imagesToShow.map((function(e){return e.id}))},imagesStorageKey:function(){return"biigle.volumes.".concat(this.volumeId,".images")},offsetStorageKey:function(){return"biigle.volumes.".concat(this.volumeId,".offset")},initialOffset:function(){return parseInt(b.get("offset"))||parseInt(localStorage.getItem(this.offsetStorageKey))||0},filterEmpty:function(){return this.filterActive&&0===this.filterSequence.length}},methods:{handleSidebarToggle:function(){var e=this;this.$nextTick((function(){return e.$refs.imageGrid.$emit("resize")}))},handleSidebarOpen:function(e){this.imageLabelMode="labels"===e},handleSidebarClose:function(){this.imageLabelMode=!1},toggleLoading:function(e){e?this.startLoading():this.finishLoading()},updateFilterSequence:function(e,t,i){this.filterSequence=e,this.filterMode=t,this.filterActive=i},handleImageGridScroll:function(e){e>0?(b.set({offset:e}),localStorage.setItem(this.offsetStorageKey,e)):(b.unset("offset"),localStorage.removeItem(this.offsetStorageKey))},handleSelectedLabel:function(e){this.selectedLabel=e},handleDeselectedLabel:function(){this.selectedLabel=null},updateSortingSequence:function(e,t){this.sortingSequence=e,this.sortingActive=t},enableFilenames:function(){var e=this;this.filenamesPromise||(this.loadingFilenames=!0,this.filenamesPromise=y.queryFilenames({id:this.volumeId}).then(this.setFilenames).finally((function(){return e.loadingFilenames=!1}))),this.filenamesPromise.then((function(){return e.showFilenames=!0}))},disableFilenames:function(){this.showFilenames=!1},setFilenames:function(e){this.images.forEach((function(t){t.filename=e.body[t.id]}))},enableLabels:function(){var e=this;this.labelsPromise||(this.loadingLabels=!0,this.labelsPromise=y.queryImageLabels({id:this.volumeId}).then(this.setLabels).finally((function(){return e.loadingLabels=!1}))),this.labelsPromise.then((function(){return e.showLabels=!0}))},disableLabels:function(){this.showLabels=!1},setLabels:function(e){this.images.forEach((function(t){t.labels=e.body[t.id]}))},restoreSettings:function(){!0===this.settings.get("showFilenames")&&this.enableFilenames(),!0===this.settings.get("showLabels")&&this.enableLabels()}},watch:{imageIdsToShow:function(e){var t=this.imageIds,i=e.length===t.length;if(i)for(var s=e.length-1;s>=0;s--)if(e[s]!==t[s]){i=!1;break}i?localStorage.removeItem(this.imagesStorageKey):localStorage.setItem(this.imagesStorageKey,JSON.stringify(e)),A.count=e.length},showFilenames:function(e){this.settings.set("showFilenames",e)},showLabels:function(e){this.settings.set("showLabels",e)}},created:function(){var e=biigle.$require("volumes.imageUuids"),t=biigle.$require("volumes.thumbUri"),i=biigle.$require("volumes.annotateUri"),s=biigle.$require("volumes.imageUri");this.imageIds=biigle.$require("volumes.imageIds"),this.filterSequence=this.imageIds,this.sortingSequence=this.imageIds,this.volumeId=biigle.$require("volumes.volumeId"),this.settings=new m({data:{storageKey:"biigle.volumes.settings",defaults:{showFilenames:!1,showLabels:!1}}}),this.images=this.imageIds.map((function(n){return{id:n,url:t.replace(":uuid",(a=e[n],a[0]+a[1]+"/"+a[2]+a[3]+"/"+a)),annotateUrl:i.replace(":id",n),imageUrl:s.replace(":id",n),flagged:!1,filename:null,labels:[]};var a})),this.restoreSettings()}};biigle.$mount("annotation-session-panel",O),biigle.$mount("create-volume-form",F),biigle.$mount("image-count",P),biigle.$mount("image-panel",k),biigle.$mount("search-results",C),biigle.$mount("volume-container",N),biigle.$mount("volume-metadata-upload",E)},zcrr:function(e,t){}});