angular.module("dias.transects",["dias.api","dias.ui"]),angular.module("dias.transects").config(["$compileProvider",function(e){"use strict";e.debugInfoEnabled(!1)}]),angular.module("dias.transects").directive("fallbackSrc",function(){"use strict";return{restrict:"A",link:function(e,t,n){t[0].onerror=function(){this.src=n.fallbackSrc}}}}),angular.module("dias.transects").controller("FilterController",["$scope","images","filter",function(e,t,n){"use strict";e.active=n.hasRules,e.data={negate:"false",filter:null,selected:null},e.setFilterMode=function(e){n.setMode(e),t.updateFiltering()},e.isFilterMode=function(e){return n.getMode()===e},e.getFilters=n.getAll,e.addRule=function(){var r={filter:e.data.filter,negate:"true"===e.data.negate,data:e.data.selected};n.hasRule(r)||n.addRule(r).then(t.updateFiltering)},e.getRules=n.getAllRules,e.removeRule=function(e){n.removeRule(e),t.updateFiltering()},e.rulesLoading=n.rulesLoading,e.numberImages=n.getNumberImages,e.selectData=function(t){e.data.selected=t}}]),angular.module("dias.transects").controller("ImagesController",["$scope","$element","images","filter","keyboard",function(e,t,n,r,o){"use strict";var i=function(){n.updateGrid(t[0].clientWidth,t[0].clientHeight)},s=function(t){n.scrollRows(t),e.$apply()},a=function(t){n.scrollToPercent(t),e.$apply()};e.imageHasFlag=r.hasFlag,e.getImageIds=n.getSequence,t.bind("wheel",function(e){s(e.deltaY>=0?1:-1)}),o.on(38,function(){s(-1)}),o.on(40,function(){s(1)});var c=function(){s(-1*n.getRows())};o.on(37,c),o.on(33,c);var l=function(){s(n.getRows())};o.on(39,l),o.on(34,l),o.on(36,function(){a(0)}),o.on(35,function(){a(1)}),window.addEventListener("resize",function(){e.$apply(i)}),i(),n.initialize()}]),angular.module("dias.transects").controller("ProgressController",["$scope","images","debounce",function(e,t,n){"use strict";var r,o=!1,i=function(e){e.preventDefault(),r=e.target.getBoundingClientRect(),t.scrollToPercent((e.clientY-r.top)/r.height)};e.beginScrolling=function(){o=!0},e.stopScrolling=function(t){e.scroll(t),o=!1},e.scroll=function(e){o&&n(function(){i(e)},25,"transects.progress.scroll")},e.progress=function(){return 100*t.progress()+"%"},e.top=function(){t.scrollToPercent(0)},e.prevPage=function(){t.scrollRows(-1*t.getRows())},e.prevRow=function(){t.scrollRows(-1)},e.nextRow=function(){t.scrollRows(1)},e.nextPage=function(){t.scrollRows(t.getRows())},e.bottom=function(){t.scrollToPercent(1)},e.isAtTop=function(){return 0===t.progress()},e.isAtBottom=function(){return 1===t.progress()}}]),angular.module("dias.transects").controller("SortByFilenameController",["$scope","sort","TRANSECT_IMAGES",function(e,t,n){"use strict";var r="filename";e.active=function(){return t.isSorterActive("filename")},e.toggle=function(){e.active()||e.activateSorter(r,n)}}]),angular.module("dias.transects").controller("SortController",["$scope","sort","images",function(e,t,n){"use strict";var r={},o=!1;e.setCache=function(e,t){r[e]=t},e.getCache=function(e){return r[e]},e.hasCache=function(e){return r.hasOwnProperty(e)},e.active=t.isActive,e.setSortAscending=function(){t.setAscending(),n.updateSorting()},e.setSortDescending=function(){t.setDescending(),n.updateSorting()},e.isSortAscending=t.isAscending,e.isSortDescending=t.isDescending,e.activateSorter=function(e,r){t.activateSorter(e,r),n.updateSorting()},e.resetSorting=function(){t.resetSorting()},e.setLoading=function(e){o=e},e.isLoading=function(){return o}}]),angular.module("dias.transects").controller("SortRandomController",["$scope","sort","TRANSECT_IMAGES",function(e,t,n){"use strict";var r="random",o=function(e){var t,n,r;for(t=e.length-1;t>0;t--)n=Math.floor(Math.random()*(t+1)),r=e[t],e[t]=e[n],e[n]=r;return e};e.active=function(){return t.isSorterActive("random")},e.toggle=function(){e.active()||e.activateSorter(r,o(n.slice(0)))}}]),angular.module("dias.transects").factory("TransectImageOrderByFilename",["$resource","URL",function(e,t){"use strict";return e(t+"/api/v1/transects/:transect_id/images/order-by/filename")}]),angular.module("dias.transects").service("filter",["TRANSECT_ID","TRANSECT_IMAGES","filterSubset","filterExclude",function(e,t,n,r){"use strict";var o="filter",i=this,s="dias.transects."+e+".filter.rules",a="dias.transects."+e+".filter.mode",c=[],l=window.localStorage.getItem(a);l||(l=o);var u=JSON.parse(window.localStorage.getItem(s));u||(u=[]);var g=[],f=function(){angular.copy(t,g);for(var e,o=u.length-1;o>=0;o--)e=u[o],e.negate?r(g,e.ids):n(g,e.ids);u.length>0?window.localStorage.setItem(s,JSON.stringify(u)):window.localStorage.removeItem(s)};this.setMode=function(e){l=e,l!==o?window.localStorage.setItem(a,l):window.localStorage.removeItem(a)},this.getMode=function(){return l},this.add=function(e){if(!e.hasOwnProperty("name"))throw"A filter needs a name property";if(!e.hasOwnProperty("resource"))throw"A filter needs a resource property";c.push({name:e.name,resource:e.resource,typeahead:e.typeahead,transformData:e.transformData||angular.identity})},this.getAll=function(){return c},this.addRule=function(t){var n={filter:t.filter,negate:t.negate,data:t.data},r=function(){i.removeRule(n)},o=t.filter.transformData(t.data);return n.ids=t.filter.resource.query({transect_id:e,data:o},f,r),u.push(n),n.ids.$promise},this.getAllRules=function(){return u},this.removeRule=function(e){var t=u.indexOf(e);t>=0&&u.splice(t,1),f()},this.hasRule=function(e){for(var t,n=u.length-1;n>=0;n--)if(t=u[n],t.filter==e.filter&&t.negate==e.negate&&t.data==e.data)return!0;return!1},this.hasRules=function(){return u.length>0},this.rulesLoading=function(){for(var e=u.length-1;e>=0;e--)if(u[e].ids.$resolved===!1)return!0;return!1},this.getNumberImages=function(){return g.length},this.getSequence=function(){return"filter"===l?g:t},this.hasFlag=function(e){return"flag"===l?g.indexOf(e)>=0:!1},f()}]),angular.module("dias.transects").service("images",["TRANSECT_ID","TRANSECT_IMAGES","filterSubset","filter","sort","THUMB_DIMENSION","urlParams","debounce",function(e,t,n,r,o,i,s,a){"use strict";var c="dias.transects."+e+".images",l="dias.transects."+e+".offset",u=[];window.localStorage[c]?(u=JSON.parse(window.localStorage[c]),n(u,t)):angular.copy(t,u);var g={cols:0,rows:0},f=8,d=0,m=null,h=[],S=function(){h=u.slice(m,m+g.cols*g.rows)},w=0,v=function(){w=Math.ceil(u.length/g.cols)-g.rows,null!==m&&R(m)},p=function(){var e=!1;o.isActive()?(e=!0,angular.copy(o.getSequence(),u),n(u,t)):angular.copy(t,u),r.hasRules()&&(e=!0,n(u,r.getSequence())),S(),e?window.localStorage[c]=JSON.stringify(u):window.localStorage.removeItem(c)},R=function(e){m=Math.max(0,Math.min(w*g.cols,e)),S(),m===d?(window.localStorage.removeItem(l),s.unset("offset")):(window.localStorage[l]=m,s.set({offset:m}))};this.updateSorting=function(){p()},this.updateFiltering=function(){p(),v()},this.progress=function(){return Math.max(0,Math.min(1,m/(u.length-g.cols*g.rows)))},this.updateGrid=function(e,t){g.cols=Math.floor(e/(i.WIDTH+f)),g.rows=Math.floor(t/(i.HEIGHT+f)),S(),v()},this.scrollRows=function(e){R(m+g.cols*e)},this.scrollToPercent=function(e){R(g.cols*Math.round(w*e))},this.getSequence=function(){return h},this.getRows=function(){return g.rows},this.getCols=function(){return g.cols},this.getLength=function(){return u.length},this.initialize=function(){R(void 0!==s.get("offset")?parseInt(s.get("offset")):window.localStorage[l]?parseInt(window.localStorage[l]):d)}}]),angular.module("dias.transects").service("sort",["TRANSECT_ID","TRANSECT_IMAGES",function(e,t){"use strict";var n="dias.transects."+e+".sorting.sorter",r="dias.transects."+e+".sorting.sequence",o="dias.transects."+e+".sorting.direction",i="asc",s="desc",a={DIRECTION:i,SORTER:"filename",SEQUENCE:t},c=window.localStorage.getItem(o);c||(c=a.DIRECTION);var l=window.localStorage.getItem(n);l||(l=a.SORTER);var u=JSON.parse(window.localStorage.getItem(r));u||(u=a.SEQUENCE);var g=function(e){c=e,c===a.DIRECTION?window.localStorage.removeItem(o):window.localStorage.setItem(o,c)};this.setAscending=function(){g(i)},this.setDescending=function(){g(s)},this.isAscending=function(){return c===i},this.isDescending=function(){return c===s},this.isSorterActive=function(e){return l===e},this.isActive=function(){return l!==a.SORTER||c!==a.DIRECTION},this.resetSorting=function(){l=a.SORTER,window.localStorage.removeItem(n),u=a.SEQUENCE,window.localStorage.removeItem(r)},this.activateSorter=function(e,t){if(l!==e){if(t.length!==a.SEQUENCE.length)throw"Requested sorting sequence length does not match the number of images in the transect!";l=e,l===a.SORTER?window.localStorage.removeItem(n):window.localStorage.setItem(n,l),u=t,u===a.SEQUENCE?window.localStorage.removeItem(r):window.localStorage.setItem(r,JSON.stringify(u))}},this.getSequence=function(){return c===s?u.slice().reverse():u}}]);