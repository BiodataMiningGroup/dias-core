angular.module("dias.transects",["dias.api","dias.ui"]),angular.module("dias.transects").config(["$compileProvider",function(e){"use strict";e.debugInfoEnabled(!1)}]),angular.module("dias.transects").controller("FilterController",["$scope","images","TRANSECT_ID","TRANSECT_IMAGES","filter",function(e,t,n,r,i){"use strict";e.active=i.hasRules,e.data={negate:"false",filter:null,selected:null},e.setFilterMode=function(e){i.setMode(e),t.updateSequence()},e.isFilterMode=function(e){return i.getMode()===e},e.getFilters=i.getAll,e.addRule=function(){var n={filter:e.data.filter,negate:"true"===e.data.negate,data:e.data.selected};i.hasRule(n)||i.addRule(n).then(t.updateSequence)},e.getRules=i.getAllRules,e.removeRule=function(e){i.removeRule(e),t.updateSequence()},e.rulesLoading=i.rulesLoading,e.numberImages=i.getNumberImages,e.selectData=function(t){e.data.selected=t}}]),angular.module("dias.transects").controller("ImagesController",["$scope","$element","$timeout","$q","images","filter",function(e,t,n,r,i,a){"use strict";var s,o,c=t[0],u=20,l=100,d=10,g=[],f=0,m=function(){return s=c.getBoundingClientRect(),c.scrollTop>=c.scrollHeight-c.offsetHeight-l},h=function(){m()&&(i.advance(u),e.$apply())},S=function(){m()&&i.limit<=i.length?(i.advance(u),o=n(S,500)):(n.cancel(o),c.addEventListener("scroll",h),window.addEventListener("resize",h))},v=function(){for(;d>f&&g.length>0;)f++,g.pop().resolve()};e.enqueueImage=function(e){var t=r.defer();return g.push(t),e.then(function(){f--,v()}),0===f&&v(),t.promise},e.images=i,e.imageHasFlag=a.hasFlag,n(S),e.$on("transects.images.updated",function(){g.length=0,f=0,n(S)})}]),angular.module("dias.transects").controller("SortByFilenameController",["$scope","sort","TransectImageOrderByFilename","TRANSECT_ID",function(e,t,n,r){"use strict";var i="filename",a="filename-sequence";e.active=function(){return t.isSorterActive("filename")},e.toggle=function(){e.active()||(e.hasCache(a)||(e.setLoading(!0),e.setCache(a,n.query({transect_id:r},function(){e.setLoading(!1)}))),e.getCache(a).$promise.then(function(t){e.activateSorter(i,t)}))}}]),angular.module("dias.transects").controller("SortByIdController",["$scope","sort","TRANSECT_IMAGES",function(e,t,n){"use strict";var r="id";e.active=function(){return t.isSorterActive("id")},e.toggle=function(){e.active()||e.activateSorter(r,n)}}]),angular.module("dias.transects").controller("SortController",["$scope","sort","images",function(e,t,n){"use strict";var r={},i=!1;e.setCache=function(e,t){r[e]=t},e.getCache=function(e){return r[e]},e.hasCache=function(e){return r.hasOwnProperty(e)},e.active=t.isActive,e.setSortAscending=function(){t.setAscending(),n.updateSequence()},e.setSortDescending=function(){t.setDescending(),n.updateSequence()},e.isSortAscending=t.isAscending,e.isSortDescending=t.isDescending,e.activateSorter=function(e,r){t.activateSorter(e,r),n.updateSequence()},e.resetSorting=function(){t.resetSorting()},e.setLoading=function(e){i=e},e.isLoading=function(){return i}}]),angular.module("dias.transects").controller("TransectController",["$scope","images",function(e,t){"use strict";e.progress=function(){return{width:100*t.progress()+"%"}}}]),angular.module("dias.transects").directive("lazyImage",["$q",function(e){"use strict";return{restrict:"A",link:function(t,n,r){var i=e.defer();t.enqueueImage(i.promise).then(function(){n.bind("load error",i.resolve),r.$set("src",r.lazyImage)})}}}]),angular.module("dias.transects").factory("TransectImageOrderByFilename",["$resource","URL",function(e,t){"use strict";return e(t+"/api/v1/transects/:transect_id/images/order-by/filename")}]),angular.module("dias.transects").service("filter",["TRANSECT_ID","TRANSECT_IMAGES","filterSubset","filterExclude",function(e,t,n,r){"use strict";var i="filter",a=this,s="dias.transects."+e+".filter.rules",o="dias.transects."+e+".filter.mode",c=[],u=window.localStorage.getItem(o);u||(u=i);var l=JSON.parse(window.localStorage.getItem(s));l||(l=[]);var d=[],g=function(){angular.copy(t,d);for(var e,i=l.length-1;i>=0;i--)e=l[i],e.negate?r(d,e.ids):n(d,e.ids);l.length>0?window.localStorage.setItem(s,JSON.stringify(l)):window.localStorage.removeItem(s)};this.setMode=function(e){u=e,u!==i?window.localStorage.setItem(o,u):window.localStorage.removeItem(o)},this.getMode=function(){return u},this.add=function(e){if(!e.hasOwnProperty("name"))throw"A filter needs a name property";if(!e.hasOwnProperty("resource"))throw"A filter needs a resource property";c.push({name:e.name,resource:e.resource,typeahead:e.typeahead,transformData:e.transformData||angular.identity})},this.getAll=function(){return c},this.addRule=function(t){var n={filter:t.filter,negate:t.negate,data:t.data},r=function(){a.removeRule(n)},i=t.filter.transformData(t.data);return n.ids=t.filter.resource.query({transect_id:e,data:i},g,r),l.push(n),n.ids.$promise},this.getAllRules=function(){return l},this.removeRule=function(e){var t=l.indexOf(e);t>=0&&l.splice(t,1),g()},this.hasRule=function(e){for(var t,n=l.length-1;n>=0;n--)if(t=l[n],t.filter==e.filter&&t.negate==e.negate&&t.data==e.data)return!0;return!1},this.hasRules=function(){return l.length>0},this.rulesLoading=function(){for(var e=l.length-1;e>=0;e--)if(l[e].ids.$resolved===!1)return!0;return!1},this.getNumberImages=function(){return d.length},this.getSequence=function(){return"filter"===u?d:t},this.hasFlag=function(e){return"flag"===u?d.indexOf(e)>=0:!1},g()}]),angular.module("dias.transects").service("images",["$rootScope","TRANSECT_ID","TRANSECT_IMAGES","filterSubset","filter","sort",function(e,t,n,r,i,a){"use strict";var s=this,o=20,c="dias.transects."+t+".images";this.sequence=[],this.limit=o,window.localStorage[c]?(s.sequence=JSON.parse(window.localStorage[c]),r(s.sequence,n,!0)):angular.copy(n,s.sequence),this.length=this.sequence.length,this.updateSequence=function(){var t=!1;a.isActive()?(t=!0,angular.copy(a.getSequence(),s.sequence),r(s.sequence,n,!0)):angular.copy(n,s.sequence),i.hasRules()&&(t=!0,r(s.sequence,i.getSequence())),s.length=s.sequence.length,t?window.localStorage[c]=JSON.stringify(s.sequence):window.localStorage.removeItem(c),s.limit=o,e.$broadcast("transects.images.updated")},this.progress=function(){return s.length>0?Math.min(s.limit/s.length,1):0},this.advance=function(e){s.limit+=e}}]),angular.module("dias.transects").service("sort",["TRANSECT_ID","TRANSECT_IMAGES",function(e,t){"use strict";var n="dias.transects."+e+".sorting.sorter",r="dias.transects."+e+".sorting.sequence",i="dias.transects."+e+".sorting.direction",a="asc",s="desc",o={DIRECTION:a,SORTER:"id",SEQUENCE:t},c=window.localStorage.getItem(i);c||(c=o.DIRECTION);var u=window.localStorage.getItem(n);u||(u=o.SORTER);var l=JSON.parse(window.localStorage.getItem(r));l||(l=o.SEQUENCE);var d=function(e){c=e,c===o.DIRECTION?window.localStorage.removeItem(i):window.localStorage.setItem(i,c)};this.setAscending=function(){d(a)},this.setDescending=function(){d(s)},this.isAscending=function(){return c===a},this.isDescending=function(){return c===s},this.isSorterActive=function(e){return u===e},this.isActive=function(){return u!==o.SORTER||c!==o.DIRECTION},this.resetSorting=function(){u=o.SORTER,window.localStorage.removeItem(n),l=o.SEQUENCE,window.localStorage.removeItem(r)},this.activateSorter=function(e,t){if(u!==e){if(t.length!==o.SEQUENCE.length)throw"Requested sorting sequence length does not match the number of images in the transect!";u=e,u===o.SORTER?window.localStorage.removeItem(n):window.localStorage.setItem(n,u),l=t,l===o.SEQUENCE?window.localStorage.removeItem(r):window.localStorage.setItem(r,JSON.stringify(l))}},this.getSequence=function(){return c===s?l.slice().reverse():l}}]);