angular.module("dias.transects",["dias.api","dias.ui"]),angular.module("dias.transects").config(["$compileProvider",function(e){"use strict";e.debugInfoEnabled(!1)}]),angular.module("dias.transects").directive("fallbackSrc",function(){"use strict";return{restrict:"A",link:function(e,t,n){t[0].onerror=function(){this.src=n.fallbackSrc}}}}),angular.module("dias.transects").controller("FilterController",["$scope","images","TRANSECT_ID","TRANSECT_IMAGES","filter",function(e,t,n,r,i){"use strict";e.active=i.hasRules,e.data={negate:"false",filter:null,selected:null},e.setFilterMode=function(e){i.setMode(e),t.updateFiltering()},e.isFilterMode=function(e){return i.getMode()===e},e.getFilters=i.getAll,e.addRule=function(){var n={filter:e.data.filter,negate:"true"===e.data.negate,data:e.data.selected};i.hasRule(n)||i.addRule(n).then(t.updateFiltering)},e.getRules=i.getAllRules,e.removeRule=function(e){i.removeRule(e),t.updateFiltering()},e.rulesLoading=i.rulesLoading,e.numberImages=i.getNumberImages,e.selectData=function(t){e.data.selected=t}}]),angular.module("dias.transects").controller("ImagesController",["$scope","$element","images","filter","keyboard",function(e,t,n,r,i){"use strict";var o=function(){n.updateGrid(t[0].clientWidth,t[0].clientHeight)},a=function(t){n.scrollRows(t),e.$apply()};e.imageHasFlag=r.hasFlag,e.getImageIds=n.getSequence,t.bind("wheel",function(e){a(e.deltaY>=0?1:-1)}),i.on(38,function(){a(-1)}),i.on(40,function(){a(1)});var s=function(){a(-1*n.getRows())};i.on(37,s),i.on(33,s);var c=function(){a(n.getRows())};i.on(39,c),i.on(34,c),i.on(36,function(){a(-1*n.getLength())}),i.on(35,function(){a(n.getLength())}),window.addEventListener("resize",function(){e.$apply(o)}),o()}]),angular.module("dias.transects").controller("SortByFilenameController",["$scope","sort","TransectImageOrderByFilename","TRANSECT_ID",function(e,t,n,r){"use strict";var i="filename",o="filename-sequence";e.active=function(){return t.isSorterActive("filename")},e.toggle=function(){e.active()||(e.hasCache(o)||(e.setLoading(!0),e.setCache(o,n.query({transect_id:r},function(){e.setLoading(!1)}))),e.getCache(o).$promise.then(function(t){e.activateSorter(i,t)}))}}]),angular.module("dias.transects").controller("SortByIdController",["$scope","sort","TRANSECT_IMAGES",function(e,t,n){"use strict";var r="id";e.active=function(){return t.isSorterActive("id")},e.toggle=function(){e.active()||e.activateSorter(r,n)}}]),angular.module("dias.transects").controller("SortController",["$scope","sort","images",function(e,t,n){"use strict";var r={},i=!1;e.setCache=function(e,t){r[e]=t},e.getCache=function(e){return r[e]},e.hasCache=function(e){return r.hasOwnProperty(e)},e.active=t.isActive,e.setSortAscending=function(){t.setAscending(),n.updateSorting()},e.setSortDescending=function(){t.setDescending(),n.updateSorting()},e.isSortAscending=t.isAscending,e.isSortDescending=t.isDescending,e.activateSorter=function(e,r){t.activateSorter(e,r),n.updateSorting()},e.resetSorting=function(){t.resetSorting()},e.setLoading=function(e){i=e},e.isLoading=function(){return i}}]),angular.module("dias.transects").controller("TransectController",["$scope","images",function(e,t){"use strict";e.progress=function(){return{width:100*t.progress()+"%"}}}]),angular.module("dias.transects").factory("TransectImageOrderByFilename",["$resource","URL",function(e,t){"use strict";return e(t+"/api/v1/transects/:transect_id/images/order-by/filename")}]),angular.module("dias.transects").service("filter",["TRANSECT_ID","TRANSECT_IMAGES","filterSubset","filterExclude",function(e,t,n,r){"use strict";var i="filter",o=this,a="dias.transects."+e+".filter.rules",s="dias.transects."+e+".filter.mode",c=[],l=window.localStorage.getItem(s);l||(l=i);var u=JSON.parse(window.localStorage.getItem(a));u||(u=[]);var g=[],d=function(){angular.copy(t,g);for(var e,i=u.length-1;i>=0;i--)e=u[i],e.negate?r(g,e.ids):n(g,e.ids);u.length>0?window.localStorage.setItem(a,JSON.stringify(u)):window.localStorage.removeItem(a)};this.setMode=function(e){l=e,l!==i?window.localStorage.setItem(s,l):window.localStorage.removeItem(s)},this.getMode=function(){return l},this.add=function(e){if(!e.hasOwnProperty("name"))throw"A filter needs a name property";if(!e.hasOwnProperty("resource"))throw"A filter needs a resource property";c.push({name:e.name,resource:e.resource,typeahead:e.typeahead,transformData:e.transformData||angular.identity})},this.getAll=function(){return c},this.addRule=function(t){var n={filter:t.filter,negate:t.negate,data:t.data},r=function(){o.removeRule(n)},i=t.filter.transformData(t.data);return n.ids=t.filter.resource.query({transect_id:e,data:i},d,r),u.push(n),n.ids.$promise},this.getAllRules=function(){return u},this.removeRule=function(e){var t=u.indexOf(e);t>=0&&u.splice(t,1),d()},this.hasRule=function(e){for(var t,n=u.length-1;n>=0;n--)if(t=u[n],t.filter==e.filter&&t.negate==e.negate&&t.data==e.data)return!0;return!1},this.hasRules=function(){return u.length>0},this.rulesLoading=function(){for(var e=u.length-1;e>=0;e--)if(u[e].ids.$resolved===!1)return!0;return!1},this.getNumberImages=function(){return g.length},this.getSequence=function(){return"filter"===l?g:t},this.hasFlag=function(e){return"flag"===l?g.indexOf(e)>=0:!1},d()}]),angular.module("dias.transects").service("images",["TRANSECT_ID","TRANSECT_IMAGES","filterSubset","filter","sort","THUMB_DIMENSION","urlParams","debounce",function(e,t,n,r,i,o,a,s){"use strict";var c="dias.transects."+e+".images",l="dias.transects."+e+".offset",u=[];window.localStorage[c]?(u=JSON.parse(window.localStorage[c]),n(u,t,!0)):angular.copy(t,u);var g={cols:0,rows:0},d=8,f=0,m=f;window.localStorage[l]?(m=parseInt(window.localStorage[l]),a.set({offset:m})):a.get(m)&&(m=parseInt(a.get("offset")));var S=[],h=function(){S=u.slice(m,m+g.cols*g.rows)},w=function(){var e=!1;i.isActive()?(e=!0,angular.copy(i.getSequence(),u),n(u,t,!0)):angular.copy(t,u),r.hasRules()&&(e=!0,n(u,r.getSequence())),h(),e?window.localStorage[c]=JSON.stringify(u):window.localStorage.removeItem(c)},v=function(e){m=Math.max(0,Math.min(u.length-g.cols*g.rows,e)),h(),m===f?(window.localStorage.removeItem(l),a.unset("offset")):(window.localStorage[l]=m,a.set({offset:m}))};this.updateSorting=function(){w()},this.updateFiltering=function(){w(),v(f)},this.progress=function(){return Math.max(0,Math.min(1,(m+g.cols*g.rows)/u.length))},this.updateGrid=function(e,t){g.cols=Math.floor(e/(o.WIDTH+d)),g.rows=Math.floor(t/(o.HEIGHT+d)),h()},this.scrollRows=function(e){v(m+g.cols*e)},this.getSequence=function(){return S},this.getRows=function(){return g.rows},this.getCols=function(){return g.cols},this.getLength=function(){return u.length}}]),angular.module("dias.transects").service("sort",["TRANSECT_ID","TRANSECT_IMAGES",function(e,t){"use strict";var n="dias.transects."+e+".sorting.sorter",r="dias.transects."+e+".sorting.sequence",i="dias.transects."+e+".sorting.direction",o="asc",a="desc",s={DIRECTION:o,SORTER:"id",SEQUENCE:t},c=window.localStorage.getItem(i);c||(c=s.DIRECTION);var l=window.localStorage.getItem(n);l||(l=s.SORTER);var u=JSON.parse(window.localStorage.getItem(r));u||(u=s.SEQUENCE);var g=function(e){c=e,c===s.DIRECTION?window.localStorage.removeItem(i):window.localStorage.setItem(i,c)};this.setAscending=function(){g(o)},this.setDescending=function(){g(a)},this.isAscending=function(){return c===o},this.isDescending=function(){return c===a},this.isSorterActive=function(e){return l===e},this.isActive=function(){return l!==s.SORTER||c!==s.DIRECTION},this.resetSorting=function(){l=s.SORTER,window.localStorage.removeItem(n),u=s.SEQUENCE,window.localStorage.removeItem(r)},this.activateSorter=function(e,t){if(l!==e){if(t.length!==s.SEQUENCE.length)throw"Requested sorting sequence length does not match the number of images in the transect!";l=e,l===s.SORTER?window.localStorage.removeItem(n):window.localStorage.setItem(n,l),u=t,u===s.SEQUENCE?window.localStorage.removeItem(r):window.localStorage.setItem(r,JSON.stringify(u))}},this.getSequence=function(){return c===a?u.slice().reverse():u}}]);