biigle.$viewModel("create-video-form",function(t){new Vue({el:t,mixins:[biigle.$require("core.mixins.loader")],mounted:function(){this.$refs.nameInput.focus()}})}),biigle.$viewModel("projects-show-video-list",function(t){var e=biigle.$require("videos.api.videos"),i=biigle.$require("messages.store");new Vue({el:t,mixins:[biigle.$require("core.mixins.loader"),biigle.$require("core.mixins.editor")],components:{previewThumbnail:biigle.$require("projects.components.previewThumbnail")},data:{project:biigle.$require("projects.project"),videos:biigle.$require("projects.videos"),filterString:"",fullHeight:0},computed:{filteredVideos:function(){if(this.hasFiltering){var t=this.filterString.toLowerCase();return this.videos.filter(function(e){return-1!==e.name.toLowerCase().indexOf(t)})}return this.videos},hasFiltering:function(){return this.filterString.length>0},filterInputClass:function(){return this.hasFiltering?"panel-filter--active":""},hasVideos:function(){return this.videos.length>0},panelStyle:function(){return this.hasFiltering?{height:this.fullHeight+"px"}:{}},hasNoMatchingVideos:function(){return this.hasVideos&&0===this.filteredVideos.length}},methods:{deleteVideo:function(t,i){e.delete({id:t.id},{force:!!i}).then(this.videoDeleted(t),this.maybeForceDelete(t))},maybeForceDelete:function(t){return function(e){if(422===e.status)return void(confirm("Deleting the video would delete annotations. Do you want to delete the video and the annotations?")&&this.deleteVideo(t,!0));i.handleResponseError(e)}.bind(this)},videoDeleted:function(t){return function(){var e=this.videos.indexOf(t);-1!==e&&this.videos.splice(e,1),this.$nextTick(this.updateFullHeight)}.bind(this)},clearFiltering:function(){this.filterString=""},updateFullHeight:function(){this.fullHeight=this.$el.offsetHeight}},mounted:function(){this.updateFullHeight()}})}),biigle.$viewModel("search-results",function(t){new Vue({el:t,components:{previewThumbnail:biigle.$require("projects.components.previewThumbnail")}})}),biigle.$declare("videos.settings",function(){var t=biigle.$require("core.models.Settings"),e={annotationOpacity:1,showMinimap:!0,autoplayDraw:0,showLabelTooltip:!1,showMousePosition:!1};return new t({data:{urlParams:Object.keys(e),storageKey:"biigle.videos.settings",defaults:e}})}),biigle.$viewModel("video-container",function(t){var e=biigle.$require("videos.id"),i=biigle.$require("videos.src"),n=biigle.$require("videos.shapes"),o=biigle.$require("videos.api.videoAnnotations"),a=biigle.$require("messages.store"),s=biigle.$require("urlParams"),r=biigle.$require("videos.models.Annotation");new Vue({el:t,mixins:[biigle.$require("core.mixins.loader")],components:{videoScreen:biigle.$require("videos.components.videoScreen"),videoTimeline:biigle.$require("videos.components.videoTimeline"),sidebar:biigle.$require("core.components.sidebar"),sidebarTab:biigle.$require("core.components.sidebarTab"),labelTrees:biigle.$require("labelTrees.components.labelTrees"),settingsTab:biigle.$require("videos.components.settingsTab"),annotationsTab:biigle.$require("videos.components.viaAnnotationsTab")},data:{canEdit:biigle.$require("videos.isEditor"),video:document.createElement("video"),labelTrees:biigle.$require("videos.labelTrees"),selectedLabel:null,bookmarks:[],annotations:[],seeking:!1,settings:{annotationOpacity:1,showMinimap:!0,autoplayDraw:0,showLabelTooltip:!1,showMousePosition:!1,playbackRate:1},openTab:"",urlParams:{x:0,y:0,r:0,t:0},initialCurrentTime:0,initialMapCenter:[0,0],initialMapResolution:0,annotationFilters:[],activeAnnotationFilter:null,resizingTimeline:!1,timelineOffsetReference:0,timelineHeightReference:0,fixedTimelineOffset:0,currentTimelineOffset:0},computed:{shapes:function(){var t={};return Object.keys(n).forEach(function(e){t[n[e]]=parseInt(e)}),t},selectedAnnotations:function(){return this.filteredAnnotations.filter(function(t){return t.isSelected})},settingsStore:function(){return biigle.$require("videos.settings")},filteredAnnotations:function(){return this.activeAnnotationFilter?this.activeAnnotationFilter.filter(this.annotations):this.annotations},hasActiveAnnotationFilter:function(){return null!==this.activeAnnotationFilter},timelineHeightOffset:function(){return this.fixedTimelineOffset+this.currentTimelineOffset},screenHeightOffset:function(){return-1*this.timelineHeightOffset},classObject:function(){return this.resizingTimeline?"resizing-timeline":""}},methods:{prepareAnnotation:function(t){return new r({data:t})},setAnnotations:function(t){this.annotations=t.body.map(this.prepareAnnotation)},addCreatedAnnotation:function(t){var e=this.prepareAnnotation(t.body);return e.$on("tracking-failed",this.removeAnnotation),this.annotations.push(e),e},seek:function(t){this.seeking||this.video.currentTime===t||(this.seeking=!0,this.video.currentTime=t)},selectAnnotation:function(t,e,i){i?this.selectAnnotations([t],[],e):this.selectAnnotations([t],this.selectedAnnotations,e)},selectAnnotations:function(t,e,i){e.forEach(function(t){t.selected=!1});var n=this.selectedAnnotations.length>0;t.forEach(function(t){t.selected=i}),void 0!==i&&!1===n&&this.seek(i)},deselectAnnotation:function(t){t?t.selected=!1:this.selectedAnnotations.forEach(function(t){t.selected=!1})},createBookmark:function(t){this.bookmarks.reduce(function(e,i){return e||i.time===t},!1)||this.bookmarks.push({time:t})},createAnnotation:function(t){var i=Object.assign(t,{shape_id:this.shapes[t.shape],label_id:this.selectedLabel?this.selectedLabel.id:0});return delete i.shape,o.save({id:e},i).then(this.addCreatedAnnotation,a.handleResponseError)},trackAnnotation:function(t){t.track=!0,this.createAnnotation(t).then(this.startPollTrackingAnnotation)},startPollTrackingAnnotation:function(t){t&&t.startPollTracking()},handleSelectedLabel:function(t){this.selectedLabel=t},handleDeselectedLabel:function(){this.selectedLabel=null},deleteAnnotationsOrKeyframes:function(t){confirm("Are you sure that you want to delete all selected annotations/keyframes?")&&t.forEach(this.deleteAnnotationOrKeyframe)},deleteAnnotationOrKeyframe:function(t){var e=t.annotation;e.isClip&&e.hasKeyframe(t.time)?e.deleteKeyframe(t.time).catch(a.handleResponseError):e.delete().then(this.deletedAnnotation(e)).catch(a.handleResponseError)},deletedAnnotation:function(t){return function(){this.removeAnnotation(t)}.bind(this)},handleVideoSeeked:function(){this.seeking=!1},modifyAnnotations:function(t){t.forEach(this.modifyAnnotation)},modifyAnnotation:function(t){t.annotation.modify(t.time,t.points).catch(a.handleResponseError)},handleUpdatedSettings:function(t,e){this.settings[t]=e},handleOpenedTab:function(t){this.settingsStore.set("openTab",t)},handleClosedTab:function(){this.settingsStore.delete("openTab")},handleToggledTab:function(){this.$refs.videoScreen.updateSize()},removeAnnotation:function(t){var e=this.annotations.indexOf(t);-1!==e&&this.annotations.splice(e,1)},splitAnnotation:function(t,e){t.split(e).then(this.addCreatedAnnotation,a.handleResponseError)},linkAnnotations:function(t){t[0].link(t[1]).then(this.deletedAnnotation(t[1])).catch(a.handleResponseError)},updateMapUrlParams:function(t,e){this.urlParams.x=Math.round(t[0]),this.urlParams.y=Math.round(t[1]),this.urlParams.r=Math.round(100*e)},updateVideoUrlParams:function(){this.urlParams.t=Math.round(100*this.video.currentTime)},restoreUrlParams:function(){void 0!==s.get("r")&&(this.initialMapResolution=parseInt(s.get("r"),10)/100),void 0!==s.get("x")&&void 0!==s.get("y")&&(this.initialMapCenter=[parseInt(s.get("x"),10),parseInt(s.get("y"),10)]),void 0!==s.get("t")&&(this.initialCurrentTime=parseInt(s.get("t"),10)/100)},maybeInitCurrentTime:function(){if(0===this.initialCurrentTime)return Vue.Promise.resolve();var t=new Vue.Promise(function(t,e){this.video.addEventListener("seeked",t),this.video.addEventListener("error",e)}.bind(this));return this.seek(this.initialCurrentTime),t},detachAnnotationLabel:function(t,e){t.labels.length>1?t.detachAnnotationLabel(e).catch(a.handleResponseError):confirm("Detaching the last label of an annotation deletes the whole annotation. Do you want to delete the annotation?")&&t.delete().then(this.deletedAnnotation(t)).catch(a.handleResponseError)},attachAnnotationLabel:function(t,e){t.attachAnnotationLabel(e).catch(a.handleResponseError)},initAnnotationFilters:function(){var t=biigle.$require("annotations.models.LabelAnnotationFilter"),e=biigle.$require("annotations.models.UserAnnotationFilter"),i=biigle.$require("annotations.models.ShapeAnnotationFilter");this.annotationFilters=[new t({data:{annotations:this.annotations}}),new e({data:{annotations:this.annotations}}),new i({data:{shapes:n}})]},setActiveAnnotationFilter:function(t){this.activeAnnotationFilter=t},resetAnnotationFilter:function(){this.activeAnnotationFilter&&this.activeAnnotationFilter.reset(),this.activeAnnotationFilter=null},handleRequiresSelectedLabel:function(){a.info("Please select a label first."),this.$refs.sidebar.$emit("open","labels")},startUpdateTimelineHeight:function(t){t.preventDefault(),this.resizingTimeline=!0,this.timelineOffsetReference=t.clientY,this.timelineHeightReference=this.$refs.videoTimeline.$el.offsetHeight},updateTimelineHeight:function(t){this.resizingTimeline&&(t.preventDefault(),this.currentTimelineOffset=this.timelineOffsetReference-t.clientY)},finishUpdateTimelineHeight:function(t){this.resizingTimeline&&(this.resizingTimeline=!1,this.fixedTimelineOffset=this.fixedTimelineOffset+this.$refs.videoTimeline.$el.offsetHeight-this.timelineHeightReference,this.currentTimelineOffset=0)}},watch:{"settings.playbackRate":function(t){this.video.playbackRate=t},urlParams:{deep:!0,handler:function(t){s.set(t)}}},created:function(){this.restoreUrlParams(),this.video.muted=!0,this.video.addEventListener("error",function(t){t.target.error.code===MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED?a.danger("The video codec is not supported by your browser."):a.danger("Error while loading video file.")}),this.video.addEventListener("seeked",this.handleVideoSeeked),this.video.addEventListener("pause",this.updateVideoUrlParams),this.video.addEventListener("seeked",this.updateVideoUrlParams),this.startLoading();var t=this,i=new Vue.Promise(function(e,i){t.video.addEventListener("canplay",e)}),n=o.query({id:e});n.then(this.setAnnotations,a.handleResponseError).then(this.initAnnotationFilters),Vue.Promise.all([i,n]).then(this.maybeInitCurrentTime).then(this.finishLoading),this.settingsStore.has("openTab")&&(this.openTab=this.settingsStore.get("openTab"))},mounted:function(){this.video.src=i}})}),biigle.$component("videos.components.annotationClip",{template:'<div class="annotation-clip" v-show="duration > 0" :style="style" :class="classObj" :title="title" @click.stop="select($event)"><segment v-for="segment in segments" :annotation="annotation" :label="label" :frames="segment.frames" :gap="segment.gap" :clip-duration="clipDuration" @select="emitSelect"></segment></div>',components:{segment:biigle.$require("videos.components.annotationSegment")},props:{annotation:{type:Object,required:!0},label:{type:Object,required:!0},duration:{type:Number,required:!0},elementWidth:{type:Number,required:!0}},data:function(){return{}},computed:{startFrame:function(){return this.annotation.startFrame},endFrame:function(){return this.annotation.endFrame},offset:function(){var t=this.startFrame/this.duration*this.elementWidth;return this.annotation.isClip||(t=Math.min(t,this.elementWidth-9)),t},clipDuration:function(){return this.endFrame-this.startFrame},width:function(){return this.clipDuration/this.duration*this.elementWidth},style:function(){return{left:this.offset+"px",width:this.width+"px"}},segments:function(){for(var t,e=[this.annotation.frames.slice()],i=[!1],n=0;-1!==(t=e[n].indexOf(null));){var o=e[n];e[n]=o.slice(0,t),e.push([o[t-1],o[t+1]]),i.push(!0),e.push(o.slice(t+1)),i.push(!1),n+=2}return e.map(function(t,e){return{frames:t,gap:i[e]}})},selected:function(){return this.annotation.isSelected},classObj:function(){return{"annotation-clip--selected":this.selected,"annotation-clip--compact":this.shouldBeCompact,"annotation-clip--more-compact":this.shouldBeMoreCompact,"annotation-clip--tracking":this.annotation.tracking,"annotation-clip--dark":this.annotation.tracking&&this.hasDarkColor}},minTimeBetweenFrames:function(){for(var t=1/0,e=this.annotation.frames.filter(function(t){return null!==t}),i=e.length-1;i>0;i--)t=Math.min(t,e[i]-e[i-1]);return t},minDistanceBetweenFrames:function(){return this.minTimeBetweenFrames/this.duration*this.elementWidth},shouldBeCompact:function(){return this.minDistanceBetweenFrames<=18},shouldBeMoreCompact:function(){return this.minDistanceBetweenFrames<=6},title:function(){return this.annotation.tracking?"Tracking in progress":""},hasDarkColor:function(){var t=this.label.color||"000000",e=parseInt(t,16);return.2126*(e>>16&255)+.7152*(e>>8&255)+.0722*(e>>0&255)<128}},methods:{emitSelect:function(t,e){this.selected&&e?this.$emit("deselect",this.annotation):this.$emit("select",this.annotation,t,e)},select:function(t){var e=this.startFrame+(t.clientX-this.$el.getBoundingClientRect().left)/this.$el.clientWidth*this.clipDuration;this.emitSelect(e,t.shiftKey)}}}),biigle.$component("videos.components.annotationKeyframe",{template:'<span class="annotation-keyframe" :style="style" :class="classObj" @click.stop="emitSelect"></span>',props:{frame:{type:Object,required:!0},startFrame:{type:Number,required:!0},segmentDuration:{type:Number,required:!0},color:{type:String,required:!0}},computed:{offset:function(){return(this.frame.time-this.startFrame)/this.segmentDuration},style:function(){return{left:100*this.offset+"%","background-color":this.color}},classObj:function(){return{"annotation-keyframe--selected":this.frame.selected}}},methods:{emitSelect:function(t){this.$emit("select",this.frame,t.shiftKey)}}}),biigle.$component("videos.components.annotationSegment",{template:'<div class="annotation-segment" :class="classObject" :style="style"><keyframe v-for="frame in keyframes" :frame="frame" :start-frame="startFrame" :segment-duration="segmentDuration" :color="color" @select="selectFrame"></keyframe></div>',components:{keyframe:biigle.$require("videos.components.annotationKeyframe")},props:{annotation:{type:Object,required:!0},label:{type:Object,required:!0},frames:{type:Array,required:!0},gap:{type:Boolean,default:!1},clipDuration:{type:Number,required:!0}},computed:{startFrame:function(){return this.frames[0]},endFrame:function(){return this.frames[this.frames.length-1]},segmentDuration:function(){return this.endFrame-this.startFrame},classObject:function(){return{"annotation-segment--gap":this.gap}},width:function(){return 100*this.segmentDuration/this.clipDuration},color:function(){return"#"+(this.label.color||"000000")},style:function(){var t={width:this.width+"%"};return this.gap?t["border-top-color"]=this.color:t["background-color"]=this.color+"66",t},keyframes:function(){if(this.gap)return[];var t=this.annotation.selected;return this.frames.map(function(e){return{time:e,selected:t===e}})}},methods:{selectFrame:function(t,e){this.$emit("select",t.time,e)}}}),biigle.$component("videos.components.annotationTrack",{template:'<div class="annotation-track"><div class="annotation-lane" v-for="lane in lanes"><annotation-clip v-for="annotation in lane" :annotation="annotation" :element-width="elementWidth" :label="label" :duration="duration" @select="emitSelect" @deselect="emitDeselect"></annotation-clip></div></div>',components:{annotationClip:biigle.$require("videos.components.annotationClip")},props:{label:{type:Object,required:!0},lanes:{type:Array,required:!0},duration:{type:Number,required:!0},elementWidth:{type:Number,required:!0}},data:function(){return{}},computed:{},methods:{emitSelect:function(t,e,i){this.$emit("select",t,e,i)},emitDeselect:function(t){this.$emit("deselect",t)}},watch:{}}),biigle.$component("videos.components.annotationTracks",{template:'<div class="annotation-tracks" draggable="true" @click="emitDeselect" @mousedown="startDragging" @mouseup="stopDragging" @mousemove="continueDragging" @scroll.stop="updateScrollTop"><annotation-track v-for="track in tracks" :label="track.label" :lanes="track.lanes" :duration="duration" :element-width="elementWidth" @select="emitSelect" @deselect="emitDeselectAnnotation"></annotation-track></div>',components:{annotationTrack:biigle.$require("videos.components.annotationTrack")},props:{tracks:{type:Array,required:!0},duration:{type:Number,required:!0},elementWidth:{type:Number,required:!0}},data:function(){return{hasOverflowTop:!1,hasOverflowBottom:!1,dragging:!1,scrollTop:0,scrollHeight:0,clientHeight:0}},computed:{hasOverflowTop:function(){return this.scrollTop>0},hasOverflowBottom:function(){var t=this.scrollHeight-this.clientHeight-1;return t>0&&this.scrollTop<t}},methods:{emitSelect:function(t,e,i){this.$emit("select",t,e,i)},emitDeselect:function(){this.$emit("deselect")},emitDeselectAnnotation:function(t){this.$emit("deselect",t)},emitDragX:function(t){this.$emit("drag-x",t)},startDragging:function(t){this.dragging=1===t.buttons},stopDragging:function(){this.dragging=!1},continueDragging:function(t){this.dragging&&(1!==t.buttons?this.stopDragging():(this.$el.scrollTop-=t.movementY,0!==t.movementX&&this.emitDragX(t.movementX)))},updateScrollTop:function(){this.scrollTop=this.$el.scrollTop},updateScrollHeight:function(){this.scrollHeight=this.$el.scrollHeight},updateClientHeight:function(){this.clientHeight=this.$el.clientHeight}},watch:{tracks:function(){this.$nextTick(this.updateScrollHeight)},hasOverflowTop:function(t){this.$emit("overflow-top",t)},hasOverflowBottom:function(t){this.$emit("overflow-bottom",t)},scrollTop:function(t){this.$emit("scroll-y",t)}},created:function(){window.addEventListener("resize",this.updateClientHeight)},mounted:function(){this.$nextTick(this.updateClientHeight)}}),biigle.$component("videos.components.currentTime",{template:'<div class="current-time" :class="classObject"><span v-text="currentTimeText"></span> <span class="hover-time" v-show="showHoverTime" v-text="hoverTimeText"></span></div>',props:{currentTime:{type:Number,required:!0},hoverTime:{type:Number,default:0},seeking:{type:Boolean,default:!1}},data:function(){return{}},computed:{currentTimeText:function(){return Vue.filter("videoTime")(this.currentTime)},hoverTimeText:function(){return Vue.filter("videoTime")(this.hoverTime)},classObject:function(){return{"current-time--seeking":this.seeking,"current-time--hover":this.showHoverTime}},showHoverTime:function(){return 0!==this.hoverTime}},methods:{},watch:{}}),biigle.$component("videos.components.currentTimeIndicator",{template:'<span class="time-indicator" :style="style"></span>',props:{duration:{type:Number,required:!0},currentTime:{type:Number,required:!0}},data:function(){return{parentWidth:0}},computed:{style:function(){if(this.duration>0){return"transform: translateX("+this.parentWidth*this.currentTime/this.duration+"px);"}}},methods:{updateParentWidth:function(){this.parentWidth=this.$el.parentElement.clientWidth}},mounted:function(){this.updateParentWidth()}}),biigle.$component("videos.components.scrollStrip",{template:'<div class="scroll-strip" @wheel.stop="handleWheel" @mouseleave="handleHideHoverTime"><div class="scroll-strip__scroller" ref="scroller" :style="scrollerStyle" @mousemove="handleUpdateHoverTime"><video-progress :bookmarks="bookmarks" :duration="duration" :element-width="elementWidth" @seek="emitSeek"></video-progress><div class="annotation-tracks-wrapper"><annotation-tracks ref="annotationTracks" :tracks="tracks" :duration="duration" :element-width="elementWidth" @select="emitSelect" @deselect="emitDeselect" @scroll-y="emitScrollY" @drag-x="handleDragX" @overflow-top="updateOverflowTop" @overflow-bottom="updateOverflowBottom"></annotation-tracks><div class="overflow-shadow overflow-shadow--top" v-show="hasOverflowTop"></div><div class="overflow-shadow overflow-shadow--bottom" v-show="hasOverflowBottom"></div></div><span class="time-indicator" :class="timeIndicatorClass" :style="timeIndicatorStyle"></span><span class="hover-time-indicator" :style="hoverTimeIndicatorStyle" v-show="showHoverTime"></span></div><div class="overflow-shadow overflow-shadow--left" v-show="hasOverflowLeft"></div><div class="overflow-shadow overflow-shadow--right" v-show="hasOverflowRight"></div></div>',components:{videoProgress:biigle.$require("videos.components.videoProgress"),annotationTracks:biigle.$require("videos.components.annotationTracks")},props:{tracks:{type:Array,required:function(){return[]}},bookmarks:{type:Array,required:function(){return[]}},duration:{type:Number,required:!0},currentTime:{type:Number,required:!0},seeking:{type:Boolean,default:!1}},data:function(){return{zoom:1,zoomFactor:.3,scrollFactor:10,initialElementWidth:0,scrollLeft:0,hoverTime:0,hasOverflowTop:!1,hasOverflowBottom:!1}},computed:{currentTimePosition:function(){return this.duration>0?this.elementWidth*this.currentTime/this.duration:0},timeIndicatorClass:function(){return{"time-indicator--seeking":this.seeking}},timeIndicatorStyle:function(){return"transform: translateX("+this.currentTimePosition+"px);"},hoverTimeIndicatorStyle:function(){return"transform: translateX("+this.hoverPosition+"px);"},scrollerStyle:function(){return{width:100*this.zoom+"%",left:this.scrollLeft+"px"}},elementWidth:function(){return this.initialElementWidth*this.zoom},hoverPosition:function(){return this.duration>0?this.elementWidth*this.hoverTime/this.duration:0},showHoverTime:function(){return 0!==this.hoverTime},hasOverflowLeft:function(){return this.scrollLeft<0},hasOverflowRight:function(){return this.elementWidth+this.scrollLeft>this.initialElementWidth}},methods:{updateInitialElementWidth:function(){this.initialElementWidth=this.$el.clientWidth},emitSeek:function(t){this.$emit("seek",t)},emitSelect:function(t,e,i){this.$emit("select",t,e,i)},emitDeselect:function(t){this.$emit("deselect",t)},emitScrollY:function(t){this.$emit("scroll-y",t)},handleWheel:function(t){t.shiftKey?0!==t.deltaY&&this.updateZoom(t):t.deltaX<0?this.updateScrollLeft(this.scrollLeft+this.scrollFactor):t.deltaX>0&&this.updateScrollLeft(this.scrollLeft-this.scrollFactor)},updateZoom:function(t){var e=t.clientX-this.$el.getBoundingClientRect().left,i=t.clientX-this.$refs.scroller.getBoundingClientRect().left,n=i/this.elementWidth,o=t.deltaY<0?this.zoomFactor:-1*this.zoomFactor;this.zoom=Math.max(1,this.zoom+o),this.$nextTick(function(){var t=n*this.elementWidth;this.updateScrollLeft(e-t)})},handleHideHoverTime:function(){this.hoverTime=0},handleUpdateHoverTime:function(t){this.hoverTime=(t.clientX-this.$refs.scroller.getBoundingClientRect().left)/this.elementWidth*this.duration},updateScrollLeft:function(t){this.scrollLeft=Math.max(Math.min(0,t),this.initialElementWidth-this.elementWidth)},updateOverflowTop:function(t){this.hasOverflowTop=t},updateOverflowBottom:function(t){this.hasOverflowBottom=t},handleDragX:function(t){this.updateScrollLeft(this.scrollLeft+t)},updateHeight:function(){this.$refs.annotationTracks.updateClientHeight()}},watch:{hoverTime:function(t){this.$emit("hover-time",t)},initialElementWidth:function(t,e){this.updateScrollLeft(this.scrollLeft*t/e)}},created:function(){window.addEventListener("resize",this.updateInitialElementWidth);var t=this;biigle.$require("events").$on("sidebar.toggle",function(){t.$nextTick(t.updateInitialElementWidth)}),biigle.$require("keyboard").on(" ",function(t){t.preventDefault()})},mounted:function(){this.$nextTick(this.updateInitialElementWidth)}}),biigle.$component("videos.components.settingsTab",{components:{powerToggle:biigle.$require("core.components.powerToggle")},props:{},data:function(){return{restoreKeys:["annotationOpacity","showMinimap","autoplayDraw","showLabelTooltip","showMousePosition"],annotationOpacity:1,showMinimap:!0,autoplayDraw:0,showLabelTooltip:!1,showMousePosition:!1,playbackRate:1}},computed:{settings:function(){return biigle.$require("videos.settings")}},methods:{handleShowMinimap:function(){this.showMinimap=!0},handleHideMinimap:function(){this.showMinimap=!1},handleShowLabelTooltip:function(){this.showLabelTooltip=!0},handleHideLabelTooltip:function(){this.showLabelTooltip=!1},handleShowMousePosition:function(){this.showMousePosition=!0},handleHideMousePosition:function(){this.showMousePosition=!1}},watch:{annotationOpacity:function(t){t=parseFloat(t),isNaN(t)||(this.$emit("update","annotationOpacity",t),this.settings.set("annotationOpacity",t))},showMinimap:function(t){this.$emit("update","showMinimap",t),this.settings.set("showMinimap",t)},autoplayDraw:function(t){t=parseFloat(t),this.$emit("update","autoplayDraw",t),this.settings.set("autoplayDraw",t)},showLabelTooltip:function(t){this.$emit("update","showLabelTooltip",t),this.settings.set("showLabelTooltip",t)},showMousePosition:function(t){this.$emit("update","showMousePosition",t),this.settings.set("showMousePosition",t)},playbackRate:function(t){t=parseFloat(t),isNaN(t)||this.$emit("update","playbackRate",t)}},created:function(){this.restoreKeys.forEach(function(t){this[t]=this.settings.get(t)},this)}}),biigle.$component("videos.components.trackHeaders",{template:'<div class="track-headers"><div class="track-header" v-for="track in tracks"><div class="label-name" v-text="track.label.name" :title="track.label.name"></div><div class="lane-dummy" v-for="lane in track.lanes"></div></div></div>',props:{tracks:{type:Array,required:!0},scrollTop:{type:Number,default:0}},data:function(){return{}},computed:{},methods:{},watch:{scrollTop:function(t){this.$el.scrollTop=t}}}),biigle.$component("videos.components.viaAnnotationsTab",{mixins:[biigle.$require("annotations.components.annotationsTab")],methods:{handleSelect:function(t,e){t.isSelected&&e?this.$emit("deselect",t):this.$emit("select",t,t.startFrame,e)}}}),biigle.$component("videos.components.videoProgress",{template:'<div class="video-progress" @click="emitSeek"><bookmark v-for="mark in bookmarks" :bookmark="mark" @select="emitSelectBookmark"></bookmark><tick v-if="hasTicks" v-for="time in ticks" :time="time"></tick></div>',props:{duration:{type:Number,required:!0},bookmarks:{type:Array,default:function(){return[]}},elementWidth:{type:Number,required:!0}},components:{bookmark:{template:'<span class="bookmark" :style="style" @click.stop="emitSelect"></span>',props:{bookmark:{type:Object,required:!0}},computed:{style:function(){return"left: "+this.bookmark.time/this.$parent.duration*this.$parent.elementWidth+"px"}},methods:{emitSelect:function(){this.$emit("select",this.bookmark)}}},tick:{template:'<span class="tick" :style="style" v-text="text"></span>',props:{time:{type:Number,required:!0}},computed:{style:function(){return"left: "+this.time/this.$parent.duration*this.$parent.elementWidth+"px"},text:function(){return Vue.filter("videoTime")(this.time)}}}},data:function(){return{tickSpacing:100}},computed:{tickCount:function(){return Math.floor(this.elementWidth/this.tickSpacing)},ticks:function(){var t=this.duration/this.tickCount;return Array.apply(null,{length:this.tickCount}).map(function(e,i){return t*i})},hasTicks:function(){return this.tickCount>0&&this.duration>0}},methods:{emitSeek:function(t){this.$emit("seek",(t.clientX-t.target.getBoundingClientRect().left)/t.target.clientWidth*this.duration)},emitSelectBookmark:function(t){this.$emit("seek",t.time)}},mounted:function(){}}),biigle.$component("videos.components.videoScreen",{mixins:[biigle.$require("videos.components.videoScreen.videoPlayback"),biigle.$require("videos.components.videoScreen.annotationPlayback"),biigle.$require("videos.components.videoScreen.drawInteractions"),biigle.$require("videos.components.videoScreen.modifyInteractions"),biigle.$require("videos.components.videoScreen.tooltips"),biigle.$require("videos.components.videoScreen.indicators"),biigle.$require("videos.components.videoScreen.polygonBrushInteractions")],
template:'<div class="video-screen" :style="styleObject"><minimap v-if="showMinimap" :extent="extent"></minimap><label-tooltip watch="hoverFeatures" :show="showLabelTooltip" :position="mousePosition"></label-tooltip><div class="controls"><div class="btn-group"><control-button v-if="playing" icon="fa-pause" title="Pause 𝗦𝗽𝗮𝗰𝗲𝗯𝗮𝗿" @click="pause"></control-button><control-button v-else icon="fa-play" title="Play 𝗦𝗽𝗮𝗰𝗲𝗯𝗮𝗿" @click="play"></control-button></div><div v-if="canAdd" class="btn-group"><control-button icon="icon-point" title="Start a point annotation 𝗔" :hover="false" :open="isDrawingPoint" :active="isDrawingPoint" @click="drawPoint"><control-button icon="fa-check" title="Finish the point annotation 𝗘𝗻𝘁𝗲𝗿" :disabled="cantFinishDrawAnnotation" @click="finishDrawAnnotation"></control-button><control-button icon="fa-project-diagram" title="Finish and track the point annotation" v-on:click="finishTrackAnnotation" :disabled="cantFinishTrackAnnotation"></control-button></control-button><control-button icon="icon-rectangle" title="Start a rectangle annotation 𝗦" :hover="false" :open="isDrawingRectangle" :active="isDrawingRectangle" @click="drawRectangle"><control-button icon="fa-check" title="Finish the rectangle annotation 𝗘𝗻𝘁𝗲𝗿" :disabled="cantFinishDrawAnnotation" @click="finishDrawAnnotation"></control-button></control-button><control-button icon="icon-circle" title="Start a circle annotation 𝗗" :hover="false" :open="isDrawingCircle" :active="isDrawingCircle" @click="drawCircle"><control-button icon="fa-check" title="Finish the circle annotation 𝗘𝗻𝘁𝗲𝗿" :disabled="cantFinishDrawAnnotation" @click="finishDrawAnnotation"></control-button><control-button icon="fa-project-diagram" title="Finish and track the circle annotation" v-on:click="finishTrackAnnotation" :disabled="cantFinishTrackAnnotation"></control-button></control-button><control-button icon="icon-linestring" title="Start a line annotation 𝗙" :hover="false" :open="isDrawingLineString" :active="isDrawingLineString" @click="drawLineString"><control-button icon="fa-check" title="Finish the line annotation 𝗘𝗻𝘁𝗲𝗿" :disabled="cantFinishDrawAnnotation" @click="finishDrawAnnotation"></control-button></control-button><control-button icon="icon-polygon" title="Start a polygon annotation 𝗚" :open="isDrawingPolygon" :active="isDrawingPolygon" @click="drawPolygon"><control-button v-if="isDrawingPolygon || isUsingPolygonBrush" icon="fa-check" title="Finish the polygon annotation 𝗘𝗻𝘁𝗲𝗿" :disabled="cantFinishDrawAnnotation" @click="finishDrawAnnotation"></control-button><control-button icon="fa-paint-brush" title="Draw a polygon using the brush tool 𝗘" :active="isUsingPolygonBrush" @click="togglePolygonBrush"></control-button><control-button icon="fa-eraser" title="Modify selected polygons using the eraser tool 𝗥" :active="isUsingPolygonEraser" @click="togglePolygonEraser"></control-button><control-button icon="fa-fill-drip" title="Modify selected polygons using the fill tool 𝗧" :active="isUsingPolygonFill" @click="togglePolygonFill"></control-button></control-button></div><div v-if="showModifyBar" class="btn-group"><control-button v-if="canModify" icon="fa-tag" title="Attach the currently selected label to existing annotations 𝗟" :active="isAttaching" :disabled="hasNoSelectedLabel" @click="toggleAttaching"></control-button><control-button v-if="canModify" icon="fa-arrows-alt" title="Move selected annotations 𝗠" :active="isTranslating" @click="toggleTranslating"></control-button><control-button v-if="canModify" icon="fa-link" title="Link selected annotations" :disabled="cannotLinkAnnotations" @click="emitLinkAnnotations"></control-button><control-button v-if="canModify" icon="fa-unlink" title="Split selected annotation" :disabled="cannotSplitAnnotation" @click="emitSplitAnnotation"></control-button><control-button v-if="canDelete" icon="fa-trash" title="Delete selected annotations/keyframes 𝗗𝗲𝗹𝗲𝘁𝗲" :disabled="hasNoSelectedAnnotations" @click="emitDelete"></control-button></div></div><div class="indicators indicators--left"><mouse-position-indicator v-if="showMousePosition" :position="mousePositionImageCoordinates"></mouse-position-indicator></div><div class="indicators indicators--right"><div class="indicator" v-if="selectedLabel" v-text="selectedLabel.name"></div></div></div>',components:{controlButton:biigle.$require("annotations.components.controlButton"),minimap:biigle.$require("annotations.components.minimap")},props:{annotations:{type:Array,default:function(){return[]}},annotationOpacity:{type:Number,default:1},autoplayDraw:{type:Number,default:0},canAdd:{type:Boolean,default:!1},canModify:{type:Boolean,default:!1},canDelete:{type:Boolean,default:!1},initialCenter:{type:Array,default:[0,0]},initialResolution:{type:Number,default:0},listenerSet:{type:String,default:"default"},selectedAnnotations:{type:Array,default:function(){return[]}},selectedLabel:{type:Object},showLabelTooltip:{type:Boolean,default:!1},showMinimap:{type:Boolean,default:!0},showMousePosition:{type:Boolean,default:!0},video:{type:HTMLVideoElement,required:!0},heightOffset:{type:Number,default:0}},data:function(){return{interactionMode:"default",mousePosition:[0,0]}},computed:{showModifyBar:function(){return this.canModify||this.canDelete},hasSelectedAnnotations:function(){return this.selectedAnnotations.length>0},hasNoSelectedAnnotations:function(){return!this.hasSelectedAnnotations},isDefaultInteractionMode:function(){return"default"===this.interactionMode},styleObject:function(){return 0!==this.heightOffset?"height: calc(65% + "+this.heightOffset+"px);":""}},methods:{createMap:function(){var t=new ol.Map({controls:[new ol.control.Zoom,new ol.control.ZoomToExtent({tipLabel:"Zoom to show whole video",label:""})],interactions:ol.interaction.defaults({altShiftDragRotate:!1,doubleClickZoom:!1,keyboard:!1,shiftDragZoom:!1,pinchRotate:!1,pinchZoom:!1})}),e=biigle.$require("annotations.ol.ZoomToNativeControl");return t.addControl(new e({label:""})),t},initLayersAndInteractions:function(t){var e=biigle.$require("annotations.stores.styles");this.annotationFeatures=new ol.Collection,this.annotationSource=new ol.source.Vector({features:this.annotationFeatures}),this.annotationLayer=new ol.layer.Vector({source:this.annotationSource,updateWhileAnimating:!0,updateWhileInteracting:!0,style:e.features,opacity:this.annotationOpacity,name:"annotations"}),this.selectInteraction=new ol.interaction.Select({condition:ol.events.condition.click,style:e.highlight,layers:[this.annotationLayer],multi:!0}),this.selectedFeatures=this.selectInteraction.getFeatures(),this.selectInteraction.on("select",this.handleFeatureSelect),t.addLayer(this.annotationLayer),t.addInteraction(this.selectInteraction)},emitCreateBookmark:function(){this.$emit("create-bookmark",this.video.currentTime)},resetInteractionMode:function(){this.interactionMode="default"},extractAnnotationFromFeature:function(t){return t.get("annotation")},handleFeatureSelect:function(t){this.$emit("select",t.selected.map(this.extractAnnotationFromFeature),t.deselected.map(this.extractAnnotationFromFeature),this.video.currentTime)},updateMousePosition:function(t){this.mousePosition=t.coordinate},emitTrack:function(){this.$emit("track")},emitMoveend:function(t){var e=t.target.getView();this.$emit("moveend",e.getCenter(),e.getResolution())},initInitialCenterAndResolution:function(t){var e=t.getView();0!==this.initialResolution&&e.setResolution(Math.min(e.getMaxResolution(),Math.max(e.getMinResolution(),this.initialResolution))),0===this.initialCenter[0]&&0===this.initialCenter[1]||!ol.extent.containsCoordinate(this.extent,this.initialCenter)||e.setCenter(this.initialCenter)},updateSize:function(){var t=this.map;this.$nextTick(function(){t.updateSize()})}},watch:{selectedAnnotations:function(t){var e=this.annotationSource,i=this.selectedFeatures;if(e&&i){var n;i.clear(),t.forEach(function(t){(n=e.getFeatureById(t.id))&&i.push(n)})}},isDefaultInteractionMode:function(t){this.selectInteraction.setActive(t)},annotationOpacity:function(t){this.annotationLayer&&this.annotationLayer.setOpacity(t)},heightOffset:function(){this.updateSize()}},created:function(){this.$once("map-ready",this.initLayersAndInteractions),this.$once("map-ready",this.initInitialCenterAndResolution),this.map=this.createMap(),this.$emit("map-created",this.map),this.map.on("pointermove",this.updateMousePosition),this.map.on("moveend",this.emitMoveend),biigle.$require("keyboard").on("Escape",this.resetInteractionMode,0,this.listenerSet)},mounted:function(){this.map.setTarget(this.$el)}}),biigle.$component("videos.components.videoTimeline",{template:'<div class="video-timeline" :style="styleObject"><div class="grab-border" @mousedown="emitStartResize"></div><div class="static-strip"><current-time :current-time="currentTime" :hover-time="hoverTime" :seeking="seeking"></current-time><track-headers ref="trackheaders" :tracks="annotationTracks" :scroll-top="scrollTop"></track-headers></div><scroll-strip ref="scrollStrip" :tracks="annotationTracks" :duration="duration" :current-time="currentTime" :bookmarks="bookmarks" :seeking="seeking" @seek="emitSeek" @select="emitSelect" @deselect="emitDeselect" @scroll-y="handleScrollY" @hover-time="updateHoverTime"></scroll-strip></div>',components:{currentTime:biigle.$require("videos.components.currentTime"),trackHeaders:biigle.$require("videos.components.trackHeaders"),scrollStrip:biigle.$require("videos.components.scrollStrip")},props:{annotations:{type:Array,default:function(){return[]}},video:{type:HTMLVideoElement,required:!0},bookmarks:{type:Array,default:function(){return[]}},seeking:{type:Boolean,default:!1},heightOffset:{type:Number,default:0}},data:function(){return{animationFrameId:null,refreshRate:30,refreshLastTime:Date.now(),currentTime:0,duration:0,scrollTop:0,hoverTime:0}},computed:{labelMap:function(){var t={};return this.annotations.forEach(function(e){e.labels.forEach(function(e){t.hasOwnProperty(e.label_id)||(t[e.label_id]=e.label)})}),t},annotationTracks:function(){var t={};return this.annotations.forEach(function(e){e.labels.forEach(function(i){t.hasOwnProperty(i.label_id)||(t[i.label_id]=[]),t[i.label_id].push(e)})}),Object.keys(t).map(function(e){return{label:this.labelMap[e],lanes:this.getAnnotationTrackLanes(t[e])}},this)},styleObject:function(){return 0!==this.heightOffset?"height: calc(35% + "+this.heightOffset+"px);":""}},methods:{startUpdateLoop:function(){var t=Date.now();t-this.refreshLastTime>=this.refreshRate&&(this.updateCurrentTime(),this.refreshLastTime=t),this.animationFrameId=window.requestAnimationFrame(this.startUpdateLoop)},stopUpdateLoop:function(){this.updateCurrentTime(),window.cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null},updateCurrentTime:function(){this.currentTime=this.video.currentTime},setDuration:function(){this.duration=this.video.duration},emitSeek:function(t){this.$emit("seek",t)},emitSelect:function(t,e,i){this.$emit("select",t,e,i)},emitDeselect:function(t){this.$emit("deselect",t)},handleScrollY:function(t){this.scrollTop=t},getAnnotationTrackLanes:function(t){var e=[[]],i=[[]];return t.forEach(function(t){var n=[t.startFrame,t.endFrame],o=0,a=!1;t:for(;!a;){if(i[o]){for(var s=e[o].length-1;s>=0;s--)if(this.rangesCollide(e[o][s],n)){o+=1;continue t}}else e[o]=[],i[o]=[];e[o].push(n),i[o].push(t),a=!0}},this),i},rangesCollide:function(t,e){return t[0]>=e[0]&&t[0]<e[1]||t[1]>e[0]&&t[1]<=e[1]||e[0]>=t[0]&&e[0]<t[1]||e[1]>t[0]&&e[1]<=t[1]||t[0]===e[0]&&t[1]===e[1]},updateHoverTime:function(t){this.hoverTime=t},emitStartResize:function(t){this.$emit("start-resize",t)}},watch:{heightOffset:function(){this.$refs.scrollStrip.updateHeight()}},created:function(){this.video.addEventListener("play",this.startUpdateLoop),this.video.addEventListener("pause",this.stopUpdateLoop),this.video.addEventListener("loadedmetadata",this.setDuration),this.video.addEventListener("seeked",this.updateCurrentTime)},mounted:function(){}}),biigle.$declare("videos.api.videoAnnotations",Vue.resource("api/v1/video-annotations{/id}",{},{query:{method:"GET",url:"api/v1/videos{/id}/annotations"},save:{method:"POST",url:"api/v1/videos{/id}/annotations"},split:{method:"POST",url:"api/v1/video-annotations{/id}/split"},link:{method:"POST",url:"api/v1/video-annotations{/id}/link"},attachLabel:{method:"POST",url:"api/v1/video-annotations{/id}/labels"},detachLabel:{method:"DELETE",url:"api/v1/video-annotation-labels{/id}"}})),biigle.$declare("videos.api.videos",Vue.resource("api/v1/videos{/id}",{},{save:{method:"POST",url:"api/v1/projects{/id}/videos"}})),function(){var t=new Date(0);Vue.filter("videoTime",function(e){return t.setTime(1e3*e),t.toISOString().split("T")[1].slice(0,-2)})}(),biigle.$declare("videos.models.Annotation",function(){return Vue.extend({data:function(){return{id:0,frames:[],points:[],video_id:0,shape_id:0,created_at:"",updated_at:"",labels:[],selected:!1,revision:1,tracking:!1}},computed:{api:function(){return biigle.$require("videos.api.videoAnnotations")},shape:function(){return biigle.$require("videos.shapes")[this.shape_id]},startFrame:function(){return this.frames[0]},endFrame:function(){return this.frames[this.frames.length-1]},interpolationPoints:function(){switch(this.shape){case"Rectangle":case"Ellipse":return this.points.map(this.rectangleToInterpolationPoints);case"LineString":case"Polygon":return this.points.map(this.polygonToSvgPath);default:return this.points}},gapRanges:function(){var t=[];return this.frames.map(function(e,i,n){null===e&&t.push([n[i-1],n[i+1]])}),t},isSelected:function(){return!1!==this.selected},isClip:function(){return this.frames.length>1}},methods:{startPollTracking:function(){this.tracking=!0,this.continuePollTracking()},pollTracking:function(){biigle.$require("videos.api.videoAnnotations").get({id:this.id}).then(this.maybeFinishPollTracking,this.cancelPollTracking)},maybeFinishPollTracking:function(t){var e=t.body;e.frames.length>1?(this.tracking=!1,this.frames=e.frames,this.points=e.points):this.continuePollTracking()},continuePollTracking:function(){this.pollTimeout=window.setTimeout(this.pollTracking,5e3)},cancelPollTracking:function(){biigle.$require("messages.store").danger("Tracking of annotation "+this.id+" failed."),this.tracking=!1,this.$emit("tracking-failed",this)},interpolatePoints:function(t){if(t<this.startFrame||t>this.endFrame)return[];if(this.hasGapAt(t))return[];for(var e=this.frames,i=e.length-1;i>=0&&!(e[i]<=t&&null!==e[i]);i--);if(e[i]===t)return this.points[i];var n=(t-e[i])/(e[i+1]-e[i]);return this.interpolateBetweenFrames(i,i+1,n)},interpolateBetweenFrames:function(t,e,i){var n=this.interpolationPoints[t],o=this.interpolationPoints[e];switch(this.shape){case"Rectangle":case"Ellipse":return this.interpolationPointsToRectangle(this.interpolateNaive(n,o,i));case"LineString":case"Polygon":return this.interpolatePolymorph(n,o,i);default:return this.interpolateNaive(n,o,i)}},interpolateNaive:function(t,e,i){return t.map(function(t,n){return t+(e[n]-t)*i})},interpolatePolymorph:function(t,e,i){return polymorph.interpolate([t,e])(i).replace(/[MCL\s]+/g," ").trim().split(" ").map(function(t){return parseInt(t,10)})},rectangleToInterpolationPoints:function(t){var e=[t[2]-t[0],t[3]-t[1]],i=[t[6]-t[0],t[7]-t[1]],n=Math.sqrt(i[0]*i[0]+i[1]*i[1]),o=Math.sqrt(e[0]*e[0]+e[1]*e[1]),a=[e[0]/o,e[1]/o],s=[(t[0]+t[2]+t[4]+t[6])/4,(t[1]+t[3]+t[5]+t[7])/4];return[s[0],s[1],a[0],a[1],n,o]},interpolationPointsToRectangle:function(t){var e=[t[2],t[3]],i=[-e[1],e[0]],n=t[4]/2*i[0],o=t[4]/2*i[1],a=t[5]/2*e[0],s=t[5]/2*e[1];return[t[0]-a-n,t[1]-s-o,t[0]+a-n,t[1]+s-o,t[0]+a+n,t[1]+s+o,t[0]-a+n,t[1]-s+o]},polygonToSvgPath:function(t){return t=t.slice(),t.unshift("M"),t.splice(3,0,"L"),t.join(" ")},hasGapAt:function(t){if(t<this.startFrame||t>this.endFrame)return!1;for(var e=this.gapRanges.length-1;e>=0;e--)if(this.gapRanges[e][0]<t&&this.gapRanges[e][1]>t)return!0;return!1},detachAnnotationLabel:function(t){var e=this.labels.indexOf(t);return-1!==e&&this.labels.splice(e,1),this.api.detachLabel({id:t.id})},attachAnnotationLabel:function(t){var e=this.api.attachLabel({id:this.id},{label_id:t.id});return e.then(this.handleAttachedLabel),e},handleAttachedLabel:function(t){this.labels.push(t.body)},hasKeyframe:function(t){return-1!==this.frames.indexOf(t)},modify:function(t,e){var i=this.frames.indexOf(t);if(-1!==i)this.points.splice(i,1,e);else{for(var n=this.frames.length-1;n>=0&&!(this.frames[n]<=t);n--);this.frames.splice(n+1,0,t),this.points.splice(n+1,0,e)}return this.api.update({id:this.id},{frames:this.frames,points:this.points})},split:function(t){return this.api.split({id:this.id},{time:t}).then(this.handleFinishedSplit)},handleFinishedSplit:function(t){return this.frames=t.body[0].frames,this.points=t.body[0].points,t.body=t.body[1],t},link:function(t){return this.api.link({id:this.id},{annotation_id:t.id}).then(this.handleFinishedLink)},handleFinishedLink:function(t){return this.frames=t.body.frames,this.points=t.body.points,this.labels=t.body.labels,t},deleteKeyframe:function(t){var e=this.frames.indexOf(t);return-1!==e?(this.frames.splice(e,1),this.points.splice(e,1),this.api.update({id:this.id},{frames:this.frames,points:this.points})):Vue.Promise.reject("Unknown keyframe "+t+" of annotation "+this.id)},delete:function(){return this.api.delete({id:this.id})}},watch:{points:function(t){this.revision+=1}}})}),biigle.$component("videos.components.videoScreen.annotationPlayback",function(){return{data:function(){return{renderedAnnotationMap:{}}},computed:{annotationsRevision:function(){return this.annotations.reduce(function(t,e){return t+e.revision},0)},annotationsPreparedToRender:function(){return this.annotations.map(function(t){return{id:t.id,start:t.startFrame,end:t.endFrame,self:t}}).sort(function(t,e){return t.start-e.start})}},methods:{refreshAnnotations:function(t){var e=this.annotationSource,i=this.selectedFeatures,n=this.annotationsPreparedToRender,o=this.renderedAnnotationMap,a={};this.renderedAnnotationMap=a;for(var s,r=[],l=!1,c=0,h=n.length;c<h;c++)if(!(n[c].end<t&&n[c].start!==t||n[c].self.hasGapAt(t))){if(n[c].start>t)break;s=n[c],l=!0,o.hasOwnProperty(s.id)?(a[s.id]=o[s.id],delete o[s.id]):r.push(s.self)}l?Object.values(o).forEach(function(t){e.removeFeature(t),i.remove(t)}):(e.clear(),i.clear());var d=r.map(this.createFeature);d.forEach(function(t){a[t.getId()]=t,t.get("annotation").isSelected&&i.push(t)}),d.length>0&&e.addFeatures(d),Object.values(a).forEach(function(e){this.updateGeometry(e,t)},this)},createFeature:function(t){var e=new ol.Feature(this.getGeometryFromPoints(t.shape,t.points[0]));return e.setId(t.id),e.set("annotation",t),t.labels&&t.labels.length>0&&e.set("color",t.labels[0].label.color),e},updateGeometry:function(t,e){var i=t.get("annotation"),n=i.interpolatePoints(e);t.setGeometry(this.getGeometryFromPoints(i.shape,n))},getGeometryFromPoints:function(t,e){switch(e=this.convertPointsFromDbToOl(e),t){case"Point":return new ol.geom.Point(e[0]);case"Rectangle":return new ol.geom.Rectangle([e]);case"Polygon":return new ol.geom.Polygon([e]);case"LineString":return new ol.geom.LineString(e);case"Circle":return new ol.geom.Circle(e[0],e[1][0]);case"Ellipse":return new ol.geom.Ellipse([e]);default:return void console.error("Unknown annotation shape: "+t)}},getPointsFromGeometry:function(t){var e;switch(t.getType()){case"Circle":e=[t.getCenter(),[t.getRadius()]];break;case"Polygon":case"Rectangle":case"Ellipse":e=t.getCoordinates()[0];break;case"Point":e=[t.getCoordinates()];break;default:e=t.getCoordinates()}return this.convertPointsFromOlToDb(e)},invertPointsYAxis:function(t){for(var e=this.videoCanvas.height,i=1;i<t.length;i+=2)t[i]=e-t[i];return t},convertPointsFromOlToDb:function(t){return this.invertPointsYAxis(Array.prototype.concat.apply([],t))},convertPointsFromDbToOl:function(t){t=this.invertPointsYAxis(t.slice());for(var e=[],i=0;i<t.length;i+=2)e.push([t[i],t[i+1]||0]);return e}},watch:{},created:function(){this.$on("refresh",this.refreshAnnotations),this.$once("map-ready",function(){this.$watch("annotationsRevision",function(){this.refreshAnnotations(this.video.currentTime)})})}}}),biigle.$component("videos.components.videoScreen.drawInteractions",function(){return{data:function(){return{pendingAnnotation:{},autoplayDrawTimeout:null}},computed:{hasSelectedLabel:function(){return!!this.selectedLabel},hasNoSelectedLabel:function(){return!this.selectedLabel},isDrawing:function(){return this.interactionMode.startsWith("draw")},isDrawingPoint:function(){return"drawPoint"===this.interactionMode},isDrawingRectangle:function(){return"drawRectangle"===this.interactionMode},isDrawingCircle:function(){return"drawCircle"===this.interactionMode},isDrawingLineString:function(){return"drawLineString"===this.interactionMode},isDrawingPolygon:function(){return"drawPolygon"===this.interactionMode},hasPendingAnnotation:function(){return this.pendingAnnotation.shape&&this.pendingAnnotation.frames.length>0&&this.pendingAnnotation.points.length>0},cantFinishDrawAnnotation:function(){return!this.hasPendingAnnotation},cantFinishTrackAnnotation:function(){return!this.pendingAnnotation.frames||1!==this.pendingAnnotation.frames.length}},methods:{requireSelectedLabel:function(){this.$emit("requires-selected-label"),this.resetInteractionMode()},initPendingAnnotationLayer:function(t){var e=biigle.$require("annotations.stores.styles");this.pendingAnnotationSource=new ol.source.Vector,this.pendingAnnotationLayer=new ol.layer.Vector({opacity:.5,source:this.pendingAnnotationSource,updateWhileAnimating:!0,updateWhileInteracting:!0,style:e.editing}),t.addLayer(this.pendingAnnotationLayer)},draw:function(t){this["isDrawing"+t]?this.resetInteractionMode():this.hasNoSelectedLabel?this.requireSelectedLabel():this.canAdd&&(this.interactionMode="draw"+t)},drawPoint:function(){this.draw("Point")},drawRectangle:function(){this.draw("Rectangle")},drawCircle:function(){this.draw("Circle")},drawLineString:function(){this.draw("LineString")},drawPolygon:function(){this.draw("Polygon")},maybeUpdateDrawInteractionMode:function(t){if(this.resetPendingAnnotation(),this.drawInteraction&&(this.map.removeInteraction(this.drawInteraction),this.drawInteraction=void 0),this.isDrawing&&this.hasSelectedLabel){var e=t.slice(4);this.pause(),this.drawInteraction=new ol.interaction.Draw({source:this.pendingAnnotationSource,type:e,style:biigle.$require("annotations.stores.styles").editing}),this.drawInteraction.on("drawend",this.extendPendingAnnotation),this.map.addInteraction(this.drawInteraction),this.pendingAnnotation.shape=e}},finishDrawAnnotation:function(){(this.isDrawing||this.isUsingPolygonBrush)&&(this.hasPendingAnnotation&&this.$emit("create-annotation",this.pendingAnnotation),this.resetInteractionMode())},finishTrackAnnotation:function(){this.isDrawing&&(this.hasPendingAnnotation&&this.$emit("track-annotation",this.pendingAnnotation),this.resetInteractionMode())},resetPendingAnnotation:function(){this.pendingAnnotationSource.clear(),this.pendingAnnotation={shape:"",frames:[],points:[]}},extendPendingAnnotation:function(t){var e=this.pendingAnnotation.frames[this.pendingAnnotation.frames.length-1];void 0===e||e<this.video.currentTime?(this.pendingAnnotation.frames.push(this.video.currentTime),this.pendingAnnotation.points.push(this.getPointsFromGeometry(t.feature.getGeometry())),!this.video.ended&&this.autoplayDraw>0&&(this.play(),window.clearTimeout(this.autoplayDrawTimeout),this.autoplayDrawTimeout=window.setTimeout(this.pause,1e3*this.autoplayDraw))):this.pendingAnnotationSource.once("addfeature",function(t){this.removeFeature(t.feature)})}},watch:{},created:function(){if(this.$once("map-ready",this.initPendingAnnotationLayer),this.canAdd){var t=biigle.$require("keyboard");t.on("a",this.drawPoint,0,this.listenerSet),t.on("s",this.drawRectangle,0,this.listenerSet),t.on("d",this.drawCircle,0,this.listenerSet),t.on("f",this.drawLineString,0,this.listenerSet),t.on("g",this.drawPolygon,0,this.listenerSet),this.$watch("interactionMode",this.maybeUpdateDrawInteractionMode),t.on("Enter",this.finishDrawAnnotation,0,this.listenerSet)}}}}),biigle.$component("videos.components.videoScreen.indicators",function(){var t=biigle.$require("utils.throttle");return{components:{mousePositionIndicator:biigle.$require("annotations.components.mousePositionIndicator")},data:function(){return{mousePositionImageCoordinates:[0,0]}},computed:{},methods:{updateMousePositionImageCoordinates:function(){this.mousePositionImageCoordinates=this.invertPointsYAxis(this.mousePosition.slice()).map(Math.round)}},watch:{mousePosition:function(e){t(this.updateMousePositionImageCoordinates,100,"videos.update-mouse-position-ic")}},created:function(){}}}),biigle.$component("videos.components.videoScreen.modifyInteractions",function(){return{data:function(){return{isTranslating:!1}},computed:{cannotSplitAnnotation:function(){var t=["Point","Circle","Rectangle"];return 1!==this.selectedAnnotations.length||-1===t.indexOf(this.selectedAnnotations[0].shape)},cannotLinkAnnotations:function(){return 2!==this.selectedAnnotations.length||this.selectedAnnotations[0].shape_id!==this.selectedAnnotations[1].shape_id},isAttaching:function(){return"attachLabel"===this.interactionMode}},methods:{initModifyInteraction:function(t){this.featureRevisionMap={},this.modifyInteraction=new ol.interaction.Modify({features:this.selectInteraction.getFeatures(),deleteCondition:function(t){return ol.events.condition.shiftKeyOnly(t)&&ol.events.condition.singleClick(t)}}),this.modifyInteraction.on("modifystart",this.handleModifyStart),this.modifyInteraction.on("modifyend",this.handleModifyEnd),t.addInteraction(this.modifyInteraction)},handleModifyStart:function(t){t.features.getArray().forEach(function(t){this.featureRevisionMap[t.getId()]=t.getRevision()},this)},handleModifyEnd:function(t){var e=t.features.getArray().filter(function(t){return this.featureRevisionMap[t.getId()]!==t.getRevision()},this).map(function(t){return{annotation:t.get("annotation"),points:this.getPointsFromGeometry(t.getGeometry()),time:this.video.currentTime}},this);e.length>0&&this.$emit("modify",e)},maybeUpdateModifyInteractionMode:function(t){this.modifyInteraction&&this.modifyInteraction.setActive(t)},emitDelete:function(){this.canDelete&&this.hasSelectedAnnotations&&this.$emit("delete",this.selectedAnnotations.map(function(t){return{annotation:t,time:this.video.currentTime}},this))},toggleTranslating:function(){this.resetInteractionMode(),this.isTranslating=!this.isTranslating},initTranslateInteraction:function(t){var e=biigle.$require("annotations.ol.ExtendedTranslateInteraction");this.translateInteraction=new e({features:this.selectedFeatures,map:t}),this.translateInteraction.setActive(!1),this.translateInteraction.on("translatestart",this.handleModifyStart),this.translateInteraction.on("translateend",this.handleModifyEnd),this.map.addInteraction(this.translateInteraction)},maybeUpdateIsTranslating:function(t){this.translateInteraction&&!t&&(this.isTranslating=!1)},resetTranslating:function(){this.isTranslating=!1},emitSplitAnnotation:function(){this.$emit("split-annotation",this.selectedAnnotations[0],this.video.currentTime)},emitLinkAnnotations:function(){this.$emit("link-annotations",this.selectedAnnotations)},toggleAttaching:function(){this.isAttaching?this.resetInteractionMode():this.interactionMode="attachLabel"},initAttachInteraction:function(t){var e=biigle.$require("annotations.ol.AttachLabelInteraction");this.attachInteraction=new e({features:this.annotationFeatures,map:t}),this.attachInteraction.setActive(!1),this.attachInteraction.on("attach",this.handleAttachLabel),this.map.addInteraction(this.attachInteraction)},handleAttachLabel:function(t){this.$emit("attach-label",t.feature.get("annotation"),this.selectedLabel)},maybeResetAttaching:function(t){this.isAttaching&&t&&this.resetInteractionMode()}},watch:{isTranslating:function(t){this.translateInteraction&&(this.translateInteraction.setActive(t),t?this.modifyInteraction.setActive(!1):this.isDefaultInteractionMode&&this.modifyInteraction.setActive(!0))},isAttaching:function(t){this.attachInteraction&&this.attachInteraction.setActive(t)}},created:function(){var t=biigle.$require("keyboard");this.canModify&&(this.$once("map-created",function(){this.$once("map-ready",this.initModifyInteraction),this.$once("map-ready",this.initTranslateInteraction),this.$once("map-ready",this.initAttachInteraction)}),this.$watch("isDefaultInteractionMode",this.maybeUpdateModifyInteractionMode),this.$watch("isDefaultInteractionMode",this.maybeUpdateIsTranslating),t.on("m",this.toggleTranslating,0,this.listenerSet),t.on("Escape",this.resetTranslating,0,this.listenerSet),t.on("l",this.toggleAttaching,0,this.listenerSet),this.$watch("hasNoSelectedLabel",this.maybeResetAttaching)),this.canDelete&&t.on("Delete",this.emitDelete)}}}),biigle.$component("videos.components.videoScreen.polygonBrushInteractions",function(){return{data:function(){return{polygonBrushRadius:50}},computed:{isUsingPolygonBrush:function(){return"polygonBrush"===this.interactionMode},isUsingPolygonEraser:function(){return"polygonEraser"===this.interactionMode},isUsingPolygonFill:function(){return"polygonFill"===this.interactionMode}},methods:{togglePolygonBrush:function(){this.isUsingPolygonBrush?this.resetInteractionMode():this.hasSelectedLabel?this.canAdd&&(this.interactionMode="polygonBrush"):this.requireSelectedLabel()},togglePolygonEraser:function(){this.isUsingPolygonEraser?this.resetInteractionMode():this.canModify&&(this.interactionMode="polygonEraser")},togglePolygonFill:function(){this.isUsingPolygonFill?this.resetInteractionMode():this.canModify&&(this.interactionMode="polygonFill")},togglePolygonBrushInteraction:function(t){t?this.hasSelectedLabel&&(this.polygonBrushInteraction=new ol.interaction.PolygonBrush({source:this.pendingAnnotationSource,style:biigle.$require("annotations.stores.styles").editing,brushRadius:this.polygonBrushRadius}),this.polygonBrushInteraction.on("drawend",this.extendPendingAnnotation),this.pendingAnnotation.shape="Polygon",this.map.addInteraction(this.polygonBrushInteraction)):(this.polygonBrushRadius=this.polygonBrushInteraction.getBrushRadius(),this.map.removeInteraction(this.polygonBrushInteraction))},togglePolygonEraserInteraction:function(t){t?(this.polygonEraserInteraction=new ol.interaction.ModifyPolygonBrush({features:this.selectInteraction.getFeatures(),style:biigle.$require("annotations.stores.styles").editing,brushRadius:this.polygonBrushRadius,allowRemove:!1,addCondition:ol.events.condition.never,subtractCondition:ol.events.condition.noModifierKeys}),this.polygonEraserInteraction.on("modifystart",this.handleModifyStart),this.polygonEraserInteraction.on("modifyend",this.handleModifyEnd),this.map.addInteraction(this.polygonEraserInteraction),this.map.addInteraction(this.shiftClickSelectInteraction)):(this.polygonBrushRadius=this.polygonEraserInteraction.getBrushRadius(),this.map.removeInteraction(this.polygonEraserInteraction),this.polygonEraserInteraction=null,this.map.removeInteraction(this.shiftClickSelectInteraction))},togglePolygonFillInteraction:function(t){t?(this.polygonFillInteraction=new ol.interaction.ModifyPolygonBrush({features:this.selectInteraction.getFeatures(),style:biigle.$require("annotations.stores.styles").editing,brushRadius:this.polygonBrushRadius,allowRemove:!1,addCondition:ol.events.condition.noModifierKeys,subtractCondition:ol.events.condition.never}),this.polygonFillInteraction.on("modifystart",this.handleModifyStart),this.polygonFillInteraction.on("modifyend",this.handleModifyEnd),this.map.addInteraction(this.polygonFillInteraction),this.map.addInteraction(this.shiftClickSelectInteraction)):(this.polygonBrushRadius=this.polygonFillInteraction.getBrushRadius(),this.map.removeInteraction(this.polygonFillInteraction),this.polygonFillInteraction=null,
this.map.removeInteraction(this.shiftClickSelectInteraction))},initShiftSelectInteraction:function(t){this.shiftClickSelectInteraction=new ol.interaction.Select({condition:function(t){return ol.events.condition.click(t)&&ol.events.condition.shiftKeyOnly(t)},style:biigle.$require("annotations.stores.styles").highlight,layers:[this.annotationLayer],features:this.selectInteraction.getFeatures(),multi:!0}),this.shiftClickSelectInteraction.on("select",this.handleFeatureSelect)}},created:function(){var t=biigle.$require("keyboard");this.canAdd&&(this.$watch("isUsingPolygonBrush",this.togglePolygonBrushInteraction),t.on("e",this.togglePolygonBrush,0,this.listenerSet)),this.canModify&&(this.$once("map-created",function(){this.$once("map-ready",this.initShiftSelectInteraction)}),this.$watch("isUsingPolygonEraser",this.togglePolygonEraserInteraction),t.on("r",this.togglePolygonEraser,0,this.listenerSet),this.$watch("isUsingPolygonFill",this.togglePolygonFillInteraction),t.on("t",this.togglePolygonFill,0,this.listenerSet))}}}),biigle.$component("videos.components.videoScreen.tooltips",function(){return{components:{labelTooltip:biigle.$require("annotations.components.labelTooltip")},data:function(){return{hoveredFeaturesHash:""}},computed:{showTooltip:function(){return this.isDefaultInteractionMode&&this.showLabelTooltip}},methods:{annotationLayerFilter:function(t){return"annotations"===t.get("name")},updateHoveredAnnotations:function(t){var e=this.map.getFeaturesAtPixel(t.pixel,{layerFilter:this.annotationLayerFilter})||[],i=e.map(function(t){return t.getId()}).join("-");this.hoveredFeaturesHash!==i&&(this.hoveredFeaturesHash=i,this.$emit("hoverFeatures",e))},resetHoveredAnnotations:function(){this.hoveredFeaturesHash="",this.$emit("hoverFeatures",[])},updateTooltipEventListeners:function(){this.showTooltip?this.map.on("pointermove",this.updateHoveredAnnotations):(this.map.un("pointermove",this.updateHoveredAnnotations),this.resetHoveredAnnotations())}},watch:{showTooltip:function(){this.updateTooltipEventListeners()}},created:function(){this.$once("map-created",this.updateTooltipEventListeners)}}}),biigle.$component("videos.components.videoScreen.videoPlayback",function(){return{data:function(){return{playing:!1,animationFrameId:null,refreshRate:30,renderCurrentTime:-1,refreshLastTime:Date.now(),extent:[0,0,0,0],minResolution:.25}},computed:{},methods:{initVideoLayer:function(t){var e=t[0];this.videoCanvas.width=this.video.videoWidth,this.videoCanvas.height=this.video.videoHeight,this.extent=[0,0,this.videoCanvas.width,this.videoCanvas.height];var i=new ol.proj.Projection({code:"biigle-image",units:"pixels",extent:this.extent});this.videoLayer=new ol.layer.Image({name:"image",source:new ol.source.Canvas({canvas:this.videoCanvas,projection:i,canvasExtent:this.extent,canvasSize:[this.extent[0],this.extent[1]]})}),e.addLayer(this.videoLayer),e.setView(new ol.View({center:[0,0],projection:i,minResolution:this.minResolution,extent:this.extent})),e.getView().fit(this.extent)},renderVideo:function(){if(this.renderCurrentTime!==this.video.currentTime){this.renderCurrentTime=this.video.currentTime,this.videoCanvasCtx.drawImage(this.video,0,0,this.video.videoWidth,this.video.videoHeight),this.videoLayer.changed();var t=Date.now();t-this.refreshLastTime>=this.refreshRate&&(this.$emit("refresh",this.video.currentTime),this.refreshLastTime=t)}},startRenderLoop:function(){this.renderVideo(),this.animationFrameId=window.requestAnimationFrame(this.startRenderLoop)},stopRenderLoop:function(){window.cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null,this.renderVideo()},setPlaying:function(){this.playing=!0},setPaused:function(){this.playing=!1},togglePlaying:function(){this.playing?this.pause():this.play()},play:function(){this.video.play()},pause:function(){this.video.pause()},emitMapReady:function(){this.$emit("map-ready",this.map)}},watch:{playing:function(t){t&&!this.animationFrameId?this.startRenderLoop():t||this.stopRenderLoop()}},created:function(){this.videoCanvas=document.createElement("canvas"),this.videoCanvasCtx=this.videoCanvas.getContext("2d"),this.video.addEventListener("play",this.setPlaying),this.video.addEventListener("pause",this.setPaused),this.video.addEventListener("seeked",this.renderVideo),this.video.addEventListener("loadeddata",this.renderVideo);var t=this,e=new Vue.Promise(function(e,i){t.$once("map-created",e)}),i=new Vue.Promise(function(e,i){t.video.addEventListener("loadedmetadata",e)});Vue.Promise.all([e,i]).then(this.initVideoLayer).then(this.emitMapReady),biigle.$require("keyboard").on(" ",this.togglePlaying)}}});