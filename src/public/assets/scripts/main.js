angular.module("dias.transects",["dias.api","dias.ui"]),angular.module("dias.transects").config(["$compileProvider",function(e){"use strict";e.debugInfoEnabled(!1)}]),angular.module("dias.transects").controller("FilterButtonController",["$scope","filter",function(e,t){"use strict";e.active=t.hasRules}]),angular.module("dias.transects").controller("FilterController",["$scope","images","TRANSECT_ID","TRANSECT_IMAGES","filter",function(e,t,n,r,a){"use strict";e.data={negate:"false",filter:null,data:null},e.setFilterMode=function(e){a.setMode(e),t.updateFiltering()},e.isFilterMode=function(e){return a.getMode()===e},e.getFilters=a.getAll,e.addRule=function(){var n={filter:e.data.filter,negate:"true"===e.data.negate,data:e.data.data};a.hasRule(n)||a.addRule(n).success(t.updateFiltering)},e.getRules=a.getAllRules,e.removeRule=function(e){a.removeRule(e),t.updateFiltering()},e.rulesLoading=a.rulesLoading,e.numberImages=a.getNumberImages}]),angular.module("dias.transects").controller("ImagesController",["$scope","$element","$timeout","$q","images","filter",function(e,t,n,r,a,i){"use strict";var s,o,l=t[0],u=20,c=100,g=10,d=[],f=0,m=function(){return s=l.getBoundingClientRect(),l.scrollTop>=l.scrollHeight-l.offsetHeight-c},h=function(){m()&&(a.advance(u),e.$apply())},p=function(){m()&&a.limit<=a.length?(a.advance(u),o=n(p,500)):(n.cancel(o),l.addEventListener("scroll",h),window.addEventListener("resize",h))},w=function(){for(;g>f&&d.length>0;)f++,d.pop().resolve()};e.enqueueImage=function(e){var t=r.defer();return d.push(t),e.then(function(){f--,w()}),0===f&&w(),t.promise},e.images=a,e.imageHasFlag=i.hasFlag,n(p),e.$on("transects.images.new-ordering",function(){d.length=0,f=0,n(p)}),e.$on("transects.images.new-filtering",function(){d.length=0,f=0,n(p)})}]),angular.module("dias.transects").controller("TransectController",["$scope","images",function(e,t){"use strict";e.progress=function(){return{width:100*t.progress()+"%"}},e.setImagesSequence=t.reorder}]),angular.module("dias.transects").directive("lazyImage",["$q",function(e){"use strict";return{restrict:"A",link:function(t,n,r){var a=e.defer();t.enqueueImage(a.promise).then(function(){n.bind("load error",a.resolve),r.$set("src",r.lazyImage)})}}}]),angular.module("dias.transects").service("filter",["TRANSECT_ID","TRANSECT_IMAGES","filterSubset","filterExclude",function(e,t,n,r){"use strict";var a="filter",i=this,s="dias.transects."+e+".filter-rules",o="dias.transects."+e+".filter-mode",l=[],u=window.localStorage.getItem(o);u||(u=a);var c=JSON.parse(window.localStorage.getItem(s));c||(c=[]);var g=[],d=function(){angular.copy(t,g);for(var e,a=c.length-1;a>=0;a--)e=c[a],e.negate?r(g,e.ids):n(g,e.ids);c.length>0?window.localStorage.setItem(s,JSON.stringify(c)):window.localStorage.removeItem(s)};this.setMode=function(e){u=e,u!==a?window.localStorage.setItem(o,u):window.localStorage.removeItem(o)},this.getMode=function(){return u},this.add=function(e){if(!e.hasOwnProperty("name"))throw"A filter needs a name property";if(!e.hasOwnProperty("resource"))throw"A filter needs a resource property";l.push({name:e.name,resource:e.resource,typeahead:e.typeahead})},this.getAll=function(){return l},this.addRule=function(t){var n={filter:t.filter,negate:t.negate,data:t.data},r=function(){i.removeRule(n)};return n.ids=t.filter.resource.query({transect_id:e,data:t.data},d,r),c.push(n),n.ids.$promise},this.getAllRules=function(){return c},this.removeRule=function(e){var t=c.indexOf(e);t>=0&&c.splice(t,1),d()},this.hasRule=function(e){for(var t,n=c.length-1;n>=0;n--)if(t=c[n],t.filter==e.filter&&t.negate==e.negate&&t.data==e.data)return!0;return!1},this.hasRules=function(){return c.length>0},this.rulesLoading=function(){for(var e=c.length-1;e>=0;e--)if(c[e].ids.$resolved===!1)return!0;return!1},this.getNumberImages=function(){return g.length},this.getSequence=function(){return"filter"===u?g:t},this.hasFlag=function(e){return"flag"===u?g.indexOf(e)>=0:!1},d()}]),angular.module("dias.transects").service("images",["$rootScope","TRANSECT_ID","TRANSECT_IMAGES","filterSubset","filter",function(e,t,n,r,a){"use strict";var i=this,s=20,o="dias.transects."+t+".images",l="dias.transects."+t+".ordering",u=[];this.sequence=[],this.limit=s,window.localStorage[o]?(i.sequence=JSON.parse(window.localStorage[o]),r(i.sequence,n,!0)):angular.copy(n,i.sequence),window.localStorage[l]&&(u=JSON.parse(window.localStorage[l])),this.length=this.sequence.length;var c=function(){var e=!1;0===u.length?angular.copy(n,i.sequence):(e=!0,angular.copy(u,i.sequence),r(i.sequence,n,!0)),a.hasRules()&&(e=!0,r(i.sequence,a.getSequence())),i.length=i.sequence.length,e?window.localStorage[o]=JSON.stringify(i.sequence):window.localStorage.removeItem(o)};this.updateFiltering=function(){c(),i.limit=s,e.$broadcast("transects.images.new-filtering")},this.progress=function(){return i.length>0?Math.min(i.limit/i.length,1):0},this.reorder=function(t){u=Array.isArray(t)?t:[],u.length>0?window.localStorage[l]=JSON.stringify(u):window.localStorage.removeItem(l),c(),i.limit=s,e.$broadcast("transects.images.new-ordering")},this.advance=function(e){i.limit+=e}}]);