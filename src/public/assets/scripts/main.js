angular.module("dias.projects",["dias.api","dias.ui"]),angular.module("dias.projects").controller("MembersController",["$scope","PROJECT","MEMBERS","ROLES","DEFAULT_ROLE_ID","USER_ID","ProjectUser","msg","User",function(e,t,n,r,o,i,c,a,u){"use strict";var s=!1,d=!1;e.newMember={user:null,project_role_id:o.toString()};var l=function(e){a.responseError(e),d=!1},f=function(e){e.project_role_id=parseInt(e.tmp_project_role_id),d=!1},p=function(e,t){e.tmp_project_role_id=e.project_role_id.toString(),l(t)},g=function(e){for(var t=n.length-1;t>=0;t--)if(n[t].id===e.id){n.splice(t,1);break}d=!1},m=function(e){for(var t=n.length-1;t>=0;t--)if(n[t].id===e.id)return!1;return!0},j=function(e){return e.filter(m)},_=function(t){t.tmp_project_role_id=t.project_role_id.toString(),n.push(t),e.newMember.user=null,d=!1};e.isEditing=function(){return s},e.toggleEditing=function(){s=!s},e.isLoading=function(){return d},e.getMembers=function(){return n},e.hasMembers=function(){return n.length>0},e.getRoles=function(){return r},e.getRole=function(e){return r[e]},e.isOwnUser=function(e){return i===e.id},e.updateRole=function(e){d=!0,c.save({project_id:t.id},{id:e.id,project_role_id:parseInt(e.tmp_project_role_id)},function(){f(e)},function(t){p(e,t)})},e.detachMember=function(e){d||(d=!0,c.detach({project_id:t.id},{id:e.id},function(){g(e)},l))},e.username=function(e){return e&&e.firstname&&e.lastname?e.firstname+" "+e.lastname:""},e.findUser=function(e){return u.find({query:encodeURIComponent(e)}).$promise.then(j)},e.newMemberValid=function(){return e.newMember.user&&void 0!==e.newMember.user.id&&m(e.newMember.user)&&null!==e.newMember.project_role_id},e.attachMember=function(){if(!d&&e.newMemberValid()){d=!0;var n=e.newMember.user;n.project_role_id=parseInt(e.newMember.project_role_id),c.attach({project_id:t.id},{id:n.id,project_role_id:n.project_role_id},function(){_(n)},l)}};for(var h=n.length-1;h>=0;h--)n[h].tmp_project_role_id=n[h].project_role_id.toString()}]),angular.module("dias.projects").controller("ProjectController",["$scope","PROJECT","Project","msg","$timeout","ProjectUser","USER_ID","REDIRECT_URL",function(e,t,n,r,o,i,c,a){"use strict";var u=!1,s=!1;e.projectInfo={name:t.name,description:t.description};var d=function(e){r.responseError(e),s=!1},l=function(e){t.name=e.name,t.description=e.description,u=!1,s=!1},f=function(){r.success("The project was deleted. Redirecting..."),o(function(){window.location.href=a},2e3)},p=function(){r.success("You left the project. Redirecting..."),o(function(){window.location.href=a},2e3)},g=function(e){400===e.status?confirm("Deleting this project will delete one or more transects with all annotations! Do you want to continue?")&&n.delete({id:t.id,force:!0},f,r.responseError):mgs.responseError(e)};e.isEditing=function(){return u},e.toggleEditing=function(){u=!u},e.isSaving=function(){return s},e.getName=function(){return t.name},e.getDescription=function(){return t.description},e.saveChanges=function(){s=!0,n.save({id:t.id,name:e.projectInfo.name,description:e.projectInfo.description},l,d)},e.discardChanges=function(){e.projectInfo.name=t.name,e.projectInfo.description=t.description,u=!1},e.deleteProject=function(){confirm("Do you really want to delete the project "+t.name+"?")&&n.delete({id:t.id},f,g)},e.leaveProject=function(){confirm("Do you really want to leave the project "+t.name+"?")&&i.detach({project_id:t.id},{id:c},p,r.responseError)}}]),angular.module("dias.projects").controller("ProjectLabelTreesController",["$scope","PROJECT","LABEL_TREES","ProjectLabelTree","msg",function(e,t,n,r,o){"use strict";var i,c=!1,a=!1;e.selected={tree:null};var u=function(e){for(var t=n.length-1;t>=0;t--)if(n[t].id===e.id)return!1;return!0},s=function(t){n.push(t),e.selected.tree=null,a=!1},d=function(e){for(var t=n.length-1;t>=0;t--)if(n[t].id===e.id){n.splice(t,1);break}a=!1};e.isEditing=function(){return c},e.isLoading=function(){return a},e.toggleEditing=function(){c=!c,i||(i=r.available({project_id:t.id}))},e.getTrees=function(){return n},e.attachLabelTree=function(e){e&&void 0!==e.id&&u(e)&&(r.attach({project_id:t.id},{id:e.id},function(){s(e)},o.responseError),a=!0)},e.getAvailableTrees=function(){return i.filter(u)},e.detachLabelTree=function(e){r.detach({project_id:t.id},{id:e.id},d,o.responseError),a=!0}}]),angular.module("dias.projects").controller("TransectsController",["$scope","PROJECT","TRANSECTS","ProjectTransect","msg","AttachableTransects",function(e,t,n,r,o,i){"use strict";var c,a=!1,u=!1;e.data={transectToAttach:null};var s=function(e){o.responseError(e),u=!1},d=function(e,n){400===n.status?confirm("The transect you are about to remove belongs only to this project and will be deleted. Are you sure you want to delete this transect?")?r.detach({project_id:t.id,force:!0},{id:e.id},function(){l(e)},s):u=!1:s(n)},l=function(e){for(var t=n.length-1;t>=0;t--)if(n[t].id===e.id){n.splice(t,1);break}u=!1},f=function(t){for(var r=c.length-1;r>=0;r--)c[r].id===t.id&&c.splice(r,1);n.push(t),e.data.transectToAttach=null,u=!1};e.isEditing=function(){return a},e.toggleEditing=function(){a=!a},e.isLoading=function(){return u},e.getTransects=function(){return n},e.hasTransects=function(){return n.length>0},e.detachTransect=function(e){u||(u=!0,r.detach({project_id:t.id},{id:e.id},function(){c.push(e),l(e)},function(t){d(e,t)}))},e.getAttachableTransects=function(){return c||(u=!0,c=i.query({id:t.id},function(){u=!1},s)),c},e.attachTransect=function(){u||(u=!0,r.attach({project_id:t.id},{id:e.data.transectToAttach.id},function(){f(e.data.transectToAttach)},s))}}]),angular.module("dias.projects").factory("AttachableTransects",["$resource","URL",function(e,t){"use strict";return e(t+"/api/v1/projects/:id/attachable-transects")}]);