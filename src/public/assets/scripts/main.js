angular.module("dias.projects",["dias.api","dias.ui"]),angular.module("dias.projects").directive("projectLabelCategoryItem",["$compile","$timeout","$templateCache",function(e,r,o){"use strict";return{restrict:"C",templateUrl:"label-item.html",scope:!0,link:function(t,n,c){var i=angular.element(o.get("label-subtree.html"));r(function(){n.append(e(i)(t))})},controller:["$scope",function(e){e.isOpen=!1,e.isExpandable=!!e.categoriesTree[e.item.id],e.isSelected=!1,e.removing=!1,e.startRemove=function(){e.removing=!0},e.cancelRemove=function(){e.removing=!1},e.$on("categories.selected",function(r,o){e.item.id===o?(e.isOpen=!0,e.isSelected=!0,e.$emit("categories.openParents")):(e.isOpen=!1,e.isSelected=!1)}),e.$on("categories.openParents",function(r){e.isOpen=!0,null===e.item.parent_id&&r.stopPropagation()}),e.$on("categories.refresh",function(r){e.isExpandable=!!e.categoriesTree[e.item.id]})}]}}]),angular.module("dias.projects").directive("projectMember",function(){"use strict";return{restrict:"A",link:function(e,r,o){var t=function(r){r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("text/plain",e.user.id)};e.$watch("removing",function(e){e?r.off("dragstart",t):r.on("dragstart",t)}),e.$watch("editing",function(r){r||e.cancelRemove()})},controller:["$scope",function(e){e.startRemove=function(){e.removing=!0},e.cancelRemove=function(){e.removing=!1},e.remove=function(){e.removeUser(e.user.id)}}]}}),angular.module("dias.projects").controller("ProjectDeleteController",["$scope","$uibModal","$attrs","msg",function(e,r,o,t){"use strict";var n=function(){e.redirectToDashboard(o.successMsg)},c=function(){t.danger(o.errorMsg)};e.submit=function(){var o=r.open({templateUrl:"confirmDeleteModal.html",size:"sm",controller:"ProjectDeleteModalController",scope:e});o.result.then(function(e){switch(e){case"success":n();break;case"error":c()}})}}]),angular.module("dias.projects").controller("ProjectDeleteModalController",["$scope","Project",function(e,r){"use strict";e.force=!1;var o=function(r){e.$close("success")},t=function(r){400===r.status?e.force=!0:e.$close("error")};e["delete"]=function(){var r=e.force?{force:!0}:{};e.project.$delete(r,o,t)}}]),angular.module("dias.projects").controller("ProjectIndexController",["$scope","$attrs","Project","$uibModal","ProjectUser","msg","$timeout",function(e,r,o,t,n,c,i){"use strict";var s=function(){e.redirectToDashboard(r.leavingSuccessMsg)};e.redirectToDashboard=function(e,o){o=o||"success",c.post(o,e),i(function(){window.location.href=r.dashboardUrl},2e3)},e.project=o.get({id:r.projectId}),e.projectId=r.projectId,e.ownUserId=r.userId,e.leaveProject=function(){var r=t.open({templateUrl:"confirmLeaveProjectModal.html",size:"sm"});r.result.then(function(r){"yes"==r&&n.detach({project_id:e.project.id},{id:e.ownUserId},s,c.responseError)})}}]),angular.module("dias.projects").controller("ProjectInformationController",["$scope",function(e){"use strict";e.edit=function(){e.editing=!e.editing}}]),angular.module("dias.projects").controller("ProjectLabelsController",["$scope","ProjectLabel","Label","msg",function(e,r,o,t){"use strict";var n="#0099ff",c=function(r){var o=r.parent_id;e.categoriesTree[o]?e.categoriesTree[o].push(r):e.categoriesTree[o]=[r]},i=function(){e.labels=r.query({project_id:e.projectId},function(){e.categoriesTree={},e.labels.forEach(c)})};i(),e.newLabel={parent_id:null,name:null,project_id:e.projectId,color:n},e.selected={label:null},e.resetColor=function(){e.newLabel.color=n},e.edit=function(){e.editing=!e.editing},e.selectItem=function(r){e.selected.label=r,e.newLabel.parent_id=r?r.id:null,e.$broadcast("categories.selected",e.newLabel.parent_id)},e.remove=function(r){o["delete"]({id:r,force:!0},function(){e.selected.label.id===r&&e.selectItem(null),i()},t.responseError)},e.addLabel=function(){o.add(e.newLabel,function(r){e.labels.push(r),c(r),e.$broadcast("categories.refresh"),e.newLabel.name=""},t.responseError)}}]),angular.module("dias.projects").controller("ProjectMembersContainerController",["$scope","$element","$attrs",function(e,r,o){"use strict";var t=function(r){e.hovering=!0,e.$apply(),r.preventDefault()},n=function(r){e.hovering=!1,e.$apply()},c=function(r){e.hovering=!1,e.changeUserRole(r.dataTransfer.getData("text/plain"),o.role),e.$apply(),r.preventDefault()};e.$watch("editing",function(e){e?(r.on("dragover",t),r.on("dragleave",n),r.on("drop",c)):(r.off("dragover",t),r.off("dragleave",n),r.off("drop",c))})}]),angular.module("dias.projects").controller("ProjectMembersController",["$scope","Role","ProjectUser","msg","$uibModal",function(e,r,o,t,n){"use strict";var c=function(r){for(var o=e.users.length-1;o>=0;o--)if(e.users[o].id==r)return e.users[o]},i=function(r,o){var t=n.open({templateUrl:"confirmChangeRoleModal.html",size:"sm"});t.result.then(function(t){"yes"==t&&e.changeUserRole(r,o,!0)})};r.query(function(r){e.roles={};for(var o=r.length-1;o>=0;o--)e.roles[r[o].name]=r[o].id}),e.users=o.query({project_id:e.projectId}),e.edit=function(){e.editing=!e.editing},e.addUser=function(r){var n=e.roles.guest,i=function(){r.project_role_id=n,e.users.push(r)};c(r.id)||o.attach({project_id:e.projectId},{id:r.id,project_role_id:n},i,t.responseError)},e.changeUserRole=function(r,n,s){if(!s&&r==e.ownUserId)return void i(r,n);var a=c(r),l=e.roles[n];if(a.project_role_id!=l){var d=function(){a.project_role_id=l};o.save({project_id:e.projectId},{id:a.id,project_role_id:l},d,t.responseError)}},e.removeUser=function(r){if(r==e.ownUserId)return void e.leaveProject();var n=function(){for(var o,t=e.users.length-1;t>=0;t--)if(e.users[t].id==r){o=t;break}e.users.splice(o,1)};o.detach({project_id:e.projectId},{id:r},n,t.responseError)}}]);