biigle={},biigle.$viewModel=function(t,e){window.addEventListener("load",function(){var n=document.getElementById(t);n&&e(n)})},biigle.$require=function(t){t=Array.isArray(t)?t:t.split(".");for(var e=biigle,n=0,i=t.length;n<i;n++)e.hasOwnProperty(t[n])||(e[t[n]]={}),e=e[t[n]];return e},biigle.$declare=function(t,e){t=t.split(".");var n=t.pop();return biigle.$require(t)[n]="function"==typeof e?e():e,e},biigle.$component=function(t,e){var n=biigle.$require(t);"function"==typeof e&&(e=e());for(var i in e)e.hasOwnProperty(i)&&(n[i]=e[i]);return n},biigle.$viewModel("video-container",function(t){var e=biigle.$require("videoSrc");new Vue({el:t,components:{videoScreen:biigle.$require("components.videoScreen"),videoTimeline:biigle.$require("components.videoTimeline")},data:{video:document.createElement("video"),bookmarks:[],annotations:[]},computed:{},methods:{seek:function(t){this.video.currentTime=t},selectAnnotation:function(t,e){this.deselectAnnotations(),t.selected=e,this.seek(t.points.frames[e])},deselectAnnotations:function(){this.annotations.forEach(function(t){t.selected=!1})},createBookmark:function(t){this.bookmarks.reduce(function(e,n){return e||n.time===t},!1)||this.bookmarks.push({time:t})}},created:function(){this.video.muted=!0},mounted:function(){this.video.src=e}})}),biigle.$component("components.annotationClip",{template:'<div class="annotation-clip" :style="style" :class="classObj" @click.stop="emitSelectFrame(0)"><keyframe v-for="(frame, i) in keyframes" :frame="frame" @select="emitSelectFrame(i)"></keyframe></div>',components:{keyframe:{template:'<span class="annotation-keyframe" :style="style" :class="classObj" @click.stop="emitSelect"></span>',props:{frame:{type:Object,required:!0}},computed:{offset:function(){return(this.frame.time-this.$parent.startFrame)/this.$parent.clipDuration},style:function(){return{left:100*this.offset+"%","background-color":"#"+this.$parent.color}},classObj:function(){return{"annotation-keyframe--selected":this.frame.selected}}},methods:{emitSelect:function(){this.$emit("select")}}}},props:{annotation:{type:Object,required:!0},labelId:{type:String,required:!0},duration:{type:Number,required:!0}},data:function(){return{}},computed:{startFrame:function(){return this.annotation.points.frames[0]},endFrame:function(){return this.annotation.points.frames[this.annotation.points.frames.length-1]},offset:function(){return this.startFrame/this.duration},clipDuration:function(){return this.endFrame-this.startFrame},width:function(){return this.clipDuration/this.duration},color:function(){for(var t=parseInt(this.labelId),e=this.annotation.labels.length-1;e>=0;e--)if(this.annotation.labels[e].id===t)return this.annotation.labels[e].color;return"000000"},style:function(){return{left:100*this.offset+"%",width:100*this.width+"%","background-color":"#"+this.color+"66"}},keyframes:function(){var t=this.annotation.selected;return this.annotation.points.frames.map(function(e,n){return{time:e,selected:t===n}})},selected:function(){return!1!==this.annotation.selected},classObj:function(){return{"annotation-clip--selected":this.selected}}},methods:{emitSelectFrame:function(t){this.$emit("select",this.annotation,t)}},mounted:function(){}}),biigle.$component("components.annotationTrack",{template:'<div class="annotation-track"><div class="annotation-lane" v-for="lane in lanes"><annotation-clip v-for="annotation in lane" :annotation="annotation" :label-id="labelId" :duration="duration" @select="emitSelect"></annotation-clip></div></div>',components:{annotationClip:biigle.$require("components.annotationClip")},props:{annotations:{type:Array,required:!0},labelId:{type:String,required:!0},duration:{type:Number,required:!0}},data:function(){return{}},computed:{lanes:function(){var t=[[]],e=[[]];return this.annotations.forEach(function(n){var i=[n.points.frames[0],n.points.frames[n.points.frames.length-1]],o=0,r=!1;t:for(;!r;){if(e[o]){for(var a=t[o].length-1;a>=0;a--)if(this.rangesCollide(t[o][a],i)){o+=1;continue t}}else t[o]=[],e[o]=[];t[o].push(i),e[o].push(n),r=!0}},this),e}},methods:{emitSelect:function(t,e){this.$emit("select",t,e)},rangesCollide:function(t,e){return t[0]>=e[0]&&t[0]<e[1]||t[1]>e[0]&&t[1]<=e[1]||e[0]>=t[0]&&e[0]<t[1]||e[1]>t[0]&&e[1]<=t[1]||t[0]===e[0]&&t[1]===e[1]}},watch:{lanes:{immediate:!0,handler:function(t){this.$emit("update",this.labelId,t.length)}}}}),biigle.$component("components.annotationTracks",{template:'<div class="annotation-tracks" @click="emitDeselect" @scroll.stop="handleScroll"><annotation-track v-for="(annotations, labelId) in tracks" :annotations="annotations" :labelId="labelId" :duration="duration" @select="emitSelect" @update="emitUpdate"></annotation-track></div>',components:{annotationTrack:biigle.$require("components.annotationTrack")},props:{annotations:{type:Array,default:function(){return[]}},duration:{type:Number,required:!0}},data:function(){return{}},computed:{tracks:function(){var t={};return this.annotations.forEach(function(e){e.labels.forEach(function(n){t.hasOwnProperty(n.id)||(t[n.id]=[]),t[n.id].push(e)})}),t}},methods:{emitSelect:function(t,e){this.$emit("select",t,e)},emitDeselect:function(){this.$emit("deselect")},emitUpdate:function(t,e){this.$emit("update",t,e)},handleScroll:function(){this.$emit("scroll-y",this.$el.scrollTop)}}}),biigle.$component("components.controlButton",{template:'<span class="control-button btn" :title="title" :class="classObject" @click="handleClick" @mouseenter="handleMouseEnter" @mouseleave="handleMouseLeave"><i :class="iconClass" aria-hidden="true"></i><span v-if="hasSubControls" @click.stop class="control-button__sub-controls btn-group"><slot></slot></span></span>',props:{title:{type:String,default:""},icon:{type:String,required:!0},active:{type:Boolean,default:!1}},data:function(){return{mouseOver:!1,timeout:null,activeSubControls:0}},computed:{classObject:function(){return{active:this.active,"control-button--open":this.showSubControls}},iconClass:function(){return this.icon.startsWith("fa-")?"fa "+this.icon:"icon icon-white "+this.icon},hasSubControls:function(){return this.$slots.hasOwnProperty("default")},showSubControls:function(){return this.mouseOver||this.hasActiveSubControl},hasActiveSubControl:function(){return this.activeSubControls>0}},methods:{handleClick:function(){this.$emit("click")},handleMouseEnter:function(){this.mouseOver=!0,window.clearTimeout(this.timeout)},handleMouseLeave:function(){var t=this;window.clearTimeout(this.timeout),this.timeout=window.setTimeout(function(){t.mouseOver=!1},200)},updateActiveSubControls:function(t){t?this.activeSubControls++:this.activeSubControls--}},watch:{active:function(t){this.$parent.$emit("control-button-active",t)}},created:function(){this.$on("control-button-active",this.updateActiveSubControls)}}),biigle.$component("components.currentTimeIndicator",{template:'<span class="time-indicator" :style="style"></span>',props:{duration:{type:Number,required:!0},currentTime:{type:Number,required:!0}},data:function(){return{parentWidth:0}},computed:{style:function(){if(this.duration>0){return"transform: translateX("+this.parentWidth*this.currentTime/this.duration+"px);"}}},methods:{updateParentWidth:function(){this.parentWidth=this.$el.parentElement.clientWidth}},mounted:function(){this.updateParentWidth()}}),biigle.$component("components.scrollStrip",{template:'<div class="scroll-strip"><video-progress :bookmarks="bookmarks" :duration="duration" @seek="emitSeek"></video-progress><annotation-tracks :annotations="annotations" :duration="duration" @select="emitSelect" @deselect="emitDeselect" @update="emitUpdateTracks" @scroll-y="emitScrollY"></annotation-tracks><span class="time-indicator" :style="indicatorStyle"></span></div>',components:{videoProgress:biigle.$require("components.videoProgress"),annotationTracks:biigle.$require("components.annotationTracks")},props:{annotations:{type:Array,required:function(){return[]}},bookmarks:{type:Array,required:function(){return[]}},duration:{type:Number,required:!0},currentTime:{type:Number,required:!0}},data:function(){return{elementWidth:0}},computed:{currentTimeOffset:function(){return this.duration>0?Math.round(this.elementWidth*this.currentTime/this.duration):0},indicatorStyle:function(){return"transform: translateX("+this.currentTimeOffset+"px);"}},methods:{updateElementWidth:function(){this.elementWidth=this.$el.clientWidth},emitSeek:function(t){this.$emit("seek",t)},emitSelect:function(t,e){this.$emit("select",t,e)},emitDeselect:function(){this.$emit("deselect")},emitUpdateTracks:function(t,e){this.$emit("update-tracks",t,e)},emitScrollY:function(t){this.$emit("scroll-y",t)}},mounted:function(){this.updateElementWidth(),window.addEventListener("resize",this.updateElementWidth)}}),biigle.$component("components.trackHeaders",{template:'<div class="track-headers"><div class="track-header" v-for="track in tracks"><div class="label-name" v-text="track.label.name"></div><div class="lane-dummy" v-for="lane in track.lanes"></div></div></div>',props:{labels:{type:Object,required:!0},laneCounts:{type:Object,default:function(){return{}}},scrollTop:{type:Number,default:0}},data:function(){return{}},computed:{tracks:function(){return Object.keys(this.laneCounts).map(function(t){return{label:this.labels[t],lanes:Array.apply(null,{length:this.laneCounts[t]})}},this)}},methods:{},watch:{scrollTop:function(t){this.$el.scrollTop=t}}}),biigle.$component("components.videoProgress",{template:'<div class="video-progress" @click="emitSeek"><bookmark v-for="mark in bookmarks" :bookmark="mark" @select="emitSelectBookmark"></bookmark></div>',props:{duration:{type:Number,required:!0},bookmarks:{type:Array,default:function(){return[]}}},components:{bookmark:{template:'<span class="bookmark" :style="style" @click.stop="emitSelect"></span>',props:{bookmark:{type:Object,required:!0}},computed:{style:function(){return"left: "+100*this.bookmark.time/this.$parent.duration+"%"}},methods:{emitSelect:function(){this.$emit("select",this.bookmark)}}}},data:function(){return{}},computed:{},methods:{emitSeek:function(t){this.$emit("seek",(t.clientX-t.target.getBoundingClientRect().left)/t.target.clientWidth*this.duration)},emitSelectBookmark:function(t){this.$emit("seek",t.time)}},mounted:function(){}}),biigle.$component("components.videoScreen",{template:'<div class="video-screen"><div class="controls"><div class="btn-group"><control-button v-if="playing" icon="fa-pause" title="Pause [Spacebar]" v-on:click="pause"></control-button><control-button v-else icon="fa-play" title="Play [Spacebar]" v-on:click="play"></control-button></div><div class="btn-group"><control-button icon="fa-bookmark" title="Create a bookmark [b]" v-on:click="emitCreateBookmark"></control-button><control-button icon="fa-dot-circle" title="Create a point annotation" v-on:click="startDrawPoint" disabled></control-button></div></div></div>',components:{controlButton:biigle.$require("components.controlButton")},props:{video:{type:HTMLVideoElement,required:!0},annotations:{type:Array,default:function(){return[]}}},data:function(){return{playing:!1,animationFrameId:null,refreshRate:100,refreshLastTime:Date.now(),renderedAnnotationMap:{}}},computed:{annotationsPreparedToRender:function(){return this.annotations.map(function(t){return{id:t.id,start:t.points.frames[0],end:t.points.frames[t.points.frames.length-1],self:t}}).sort(function(t,e){return t.start-e.start})}},methods:{createMap:function(){return new ol.Map({renderer:"canvas",interactions:ol.interaction.defaults({altShiftDragRotate:!1,doubleClickZoom:!1,keyboard:!1,shiftDragZoom:!1,pinchRotate:!1,pinchZoom:!1})})},createVideoLayer:function(){this.videoCanvas.width=this.video.videoWidth,this.videoCanvas.height=this.video.videoHeight;var t=[0,0,this.videoCanvas.width,this.videoCanvas.height],e=new ol.proj.Projection({code:"biigle-image",units:"pixels",extent:t});this.videoLayer=new ol.layer.Image({map:this.map,source:new ol.source.Canvas({canvas:this.videoCanvas,projection:this.projection,canvasExtent:t,canvasSize:[t[0],t[1]]})}),this.map.setView(new ol.View({projection:e,minResolution:.25,extent:t})),this.map.getView().fit(t),this.annotationLayer.setMap(this.map)},createAnnotationLayer:function(){this.annotationFeatures=new ol.Collection,this.annotationSource=new ol.source.Vector({features:this.annotationFeatures}),this.annotationLayer=new ol.layer.Vector({source:this.annotationSource,updateWhileAnimating:!0,updateWhileInteracting:!0,style:biigle.$require("stores.styles").features})},renderVideo:function(){this.videoCanvasCtx.drawImage(this.video,0,0,this.video.videoWidth,this.video.videoHeight),this.videoLayer.changed();var t=Date.now();t-this.refreshLastTime>=this.refreshRate&&(this.refreshAnnotations(this.video.currentTime),this.refreshLastTime=t)},startRenderLoop:function(){this.renderVideo(),this.animationFrameId=window.requestAnimationFrame(this.startRenderLoop)},stopRenderLoop:function(){window.cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null},setPlaying:function(){this.playing=!0},setPaused:function(){this.playing=!1},togglePlaying:function(){this.playing?this.pause():this.play()},play:function(){this.video.play()},pause:function(){this.video.pause()},refreshAnnotations:function(t){var e=this.annotationSource,n=this.annotationsPreparedToRender,i=this.renderedAnnotationMap,o={};this.renderedAnnotationMap=o;for(var r,a=[],s=!1,l=0,c=n.length;l<c;l++)if(!(n[l].end<=t&&n[l].start!==t)){if(n[l].start>t)break;r=n[l],s=!0,i.hasOwnProperty(r.id)?(o[r.id]=i[r.id],delete i[r.id]):a.push(r.self)}s?Object.values(i).forEach(function(t){e.removeFeature(t)}):e.clear();var u=a.map(this.createFeature);u.forEach(function(t){o[t.getId()]=t}),u.length>0&&e.addFeatures(u),Object.values(o).forEach(function(e){this.updateGeometry(e,t)},this)},invertPointsYAxis:function(t){for(var e=this.videoCanvas.height,n=1;n<t.length;n+=2)t[n]=e-t[n];return t},createGeometry:function(t,e){return new ol.geom.Point(this.invertPointsYAxis(e.slice()))},createFeature:function(t){var e=new ol.Feature(this.createGeometry("Point",t.points.coordinates[0]));return e.setId(t.id),e.set("annotation",t),t.labels&&t.labels.length>0&&e.set("color",t.labels[0].color),e},updateGeometry:function(t,e){var n=t.get("annotation"),i=n.points.frames;if(!(i.length<=1)){var o;for(o=i.length-1;o>=0&&!(i[o]<=e);o--);var r=n.points.coordinates,a=(e-i[o])/(i[o+1]-i[o]);t.setGeometry(this.createGeometry("Point",this.interpolateCoordinates(r[o],r[o+1],a)))}},interpolateCoordinates:function(t,e,n){return t.map(function(t,i){return t+(e[i]-t)*n})},emitCreateBookmark:function(){this.$emit("create-bookmark",this.video.currentTime)},startDrawPoint:function(){console.log("draw")}},watch:{playing:function(t){t&&!this.animationFrameId?this.startRenderLoop():t||this.stopRenderLoop()}},created:function(){this.map=this.createMap(),this.videoCanvas=document.createElement("canvas"),this.videoCanvasCtx=this.videoCanvas.getContext("2d"),this.video.addEventListener("loadedmetadata",this.createVideoLayer),this.video.addEventListener("play",this.setPlaying),this.video.addEventListener("pause",this.setPaused),this.video.addEventListener("seeked",this.renderVideo),this.video.addEventListener("loadeddata",this.renderVideo),this.createAnnotationLayer();var t=biigle.$require("keyboard");t.on(" ",this.togglePlaying),t.on("b",this.emitCreateBookmark)},mounted:function(){this.map.setTarget(this.$el)}}),biigle.$component("components.videoTimeline",{template:'<div class="video-timeline"><div class="static-strip"><div class="current-time" v-text="currentTimeString"></div><track-headers ref="trackheaders" :labels="labelMap" :lane-counts="laneCounts" :scroll-top="scrollTop"></track-headers></div><scroll-strip :annotations="annotations" :duration="duration" :current-time="currentTime" :bookmarks="bookmarks" @seek="emitSeek" @select="emitSelect" @deselect="emitDeselect" @update-tracks="handleUpdatedTracks" @scroll-y="handleScrollY"></scroll-strip></div>',components:{trackHeaders:biigle.$require("components.trackHeaders"),scrollStrip:biigle.$require("components.scrollStrip")},props:{annotations:{type:Array,default:function(){return[]}},video:{type:HTMLVideoElement,required:!0},bookmarks:{type:Array,default:function(){return[]}}},data:function(){return{animationFrameId:null,refreshRate:100,refreshLastTime:Date.now(),currentTime:0,currentTimeDate:new Date(0),currentTimeString:"00:00:00.000",duration:0,laneCounts:{},scrollTop:0}},computed:{labelMap:function(){var t={};return this.annotations.forEach(function(e){e.labels.forEach(function(e){t.hasOwnProperty(e.id)||(t[e.id]=e)})}),t}},methods:{startUpdateLoop:function(){var t=Date.now();t-this.refreshLastTime>=this.refreshRate&&(this.updateCurrentTime(),this.refreshLastTime=t),this.animationFrameId=window.requestAnimationFrame(this.startUpdateLoop)},stopUpdateLoop:function(){this.updateCurrentTime(),window.cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null},updateCurrentTime:function(){this.currentTime=this.video.currentTime,this.currentTimeDate.setTime(1e3*this.currentTime),this.currentTimeString=this.currentTimeDate.toISOString().split("T")[1].slice(0,-1)},setDuration:function(){this.duration=this.video.duration},emitSeek:function(t){this.$emit("seek",t)},emitSelect:function(t,e){this.$emit("select",t,e)},emitDeselect:function(){this.$emit("deselect")},handleUpdatedTracks:function(t,e){Vue.set(this.laneCounts,t,e)},handleScrollY:function(t){this.scrollTop=t}},watch:{},created:function(){this.video.addEventListener("play",this.startUpdateLoop),this.video.addEventListener("pause",this.stopUpdateLoop),this.video.addEventListener("loadedmetadata",this.setDuration),this.video.addEventListener("seeked",this.updateCurrentTime)},mounted:function(){}}),biigle.$declare("keyboard",new Vue({data:{activeListenerSetName:"default",listenerSets:{default:{}},compatibilityMap:{Hyper:"OS",Meta:"OS",ScrollLock:"Scroll",Super:"OS"," ":"Spacebar",ArrowDown:"Down",ArrowLeft:"Left",ArrowRight:"Right",ArrowUp:"Up",CrSel:"Crsel",Delete:"Del",ExSel:"Exsel",ContextMenu:"Apps",Escape:"Esc"},ignoredTags:["input","textarea","select"]},computed:{activeListenerSet:function(){return this.listenerSets[this.activeListenerSetName]||{}}},methods:{isKeyIdentifier:function(t){return"string"==typeof t||t instanceof String},shouldIgnoreTarget:function(t){return-1!==this.ignoredTags.indexOf(t.target.tagName.toLowerCase())},handleKeyEvents:function(t){t=t||event,this.shouldIgnoreTarget(t)||this.activeListenerSet.hasOwnProperty(t.key)&&this.executeCallbacks(this.activeListenerSet[t.key],t)},executeCallbacks:function(t,e){for(var n=t.length-1;n>=0;n--)if(!1===t[n].callback(e))return},on:function(t,e,n,i){if(!this.isKeyIdentifier(t))return void console.error(t+" is not a valid key.");this.compatibilityMap.hasOwnProperty(t)&&this.on(this.compatibilityMap[t],e,n,i),n=n||0;var o={callback:e,priority:n};i=i||"default",this.listenerSets.hasOwnProperty(i)||(this.listenerSets[i]={});var r=this.listenerSets[i];if(r.hasOwnProperty(t)){var a,s=r[t];for(a=0;a<s.length&&!(s[a].priority>=n);a++);a===s.length-1?s.push(o):s.splice(a,0,o)}else r[t]=[o]},off:function(t,e,n){n=n||"default";var i=this.listenerSets[n];if(i&&i.hasOwnProperty(t))for(var o=i[t],r=o.length-1;r>=0;r--)if(o[r].callback===e){o.splice(r,1);break}},setActiveSet:function(t){this.activeListenerSetName=t}},created:function(){document.body.addEventListener("keydown",this.handleKeyEvents)}})),biigle.$declare("stores.styles",function(){var t={white:[255,255,255,1],blue:[0,153,255,1],orange:"#ff5e00"},e={},n=new ol.style.Stroke({color:t.white,width:5}),i=new ol.style.Stroke({color:t.white,width:6}),o=new ol.style.Stroke({color:t.blue,width:3}),r=new ol.style.Stroke({color:t.orange,width:3}),a=new ol.style.Fill({color:t.blue}),s=new ol.style.Fill({color:t.orange}),l=new ol.style.Stroke({color:t.white,width:2}),c=new ol.style.Stroke({color:t.white,width:3}),u=new ol.style.Stroke({color:t.white,width:2,lineDash:[3]}),d=new ol.style.Stroke({color:t.blue,width:3,lineDash:[5]});new ol.style.Fill({color:t.blue}),new ol.style.Fill({color:t.orange});return{colors:t,features:function(i){var o=i.get("color");return o=o?"#"+o:t.blue,e.hasOwnProperty(o)||(e[o]=[new ol.style.Style({stroke:n,image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:o}),stroke:l})}),new ol.style.Style({stroke:new ol.style.Stroke({color:o,width:3})})]),e[o]},highlight:[new ol.style.Style({stroke:i,image:new ol.style.Circle({radius:6,fill:s,stroke:c}),zIndex:200}),new ol.style.Style({stroke:r,zIndex:200})],editing:[new ol.style.Style({stroke:n,image:new ol.style.Circle({radius:6,fill:a,stroke:u})}),new ol.style.Style({stroke:d})],viewport:[new ol.style.Style({stroke:o}),new ol.style.Style({stroke:new ol.style.Stroke({color:t.white,width:1})})],cross:[new ol.style.Style({image:new ol.style.RegularShape({stroke:i,points:4,radius1:6,radius2:0,angle:Math.PI/4})}),new ol.style.Style({image:new ol.style.RegularShape({stroke:r,points:4,radius1:6,radius2:0,angle:Math.PI/4})})]}});